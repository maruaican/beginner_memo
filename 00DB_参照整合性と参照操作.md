なるほど！SQLの仕様例を交えた形で、最初から体系的に整理し直しますね。
テーマは「参照整合性と参照操作（CASCADE／RESTRICT／NO ACTION／SET NULL／SET DEFAULT）」です。

---

# 参照操作（外部キー制約）の体系的解説

## １　全体像（テキスト図）

```
部署（部署ID, 部署名）
   1 → 多
社員（社員ID, 社員名, 部署ID）
```

* 「社員.部署ID」が「部署.部署ID」を参照
* 部署を削除／更新したとき、社員テーブルの外部キーをどう扱うかを定めるのが参照操作

---

## １－１　定義（IPA準拠）と用語の由来

* **参照整合性**
  外部キーは必ず参照先の表に存在していなければならない制約。
* **参照操作**
  親行を削除・更新したときに子行をどう処理するかを定めるSQL仕様。
* **用語の由来**
  SQL標準の `FOREIGN KEY` 制約に付ける `ON DELETE` / `ON UPDATE` 句に由来。

---

## １－２　技術の必要性（解決する具体的課題）

もし参照操作がなければ：

* 削除された部署を参照する社員が残る（存在しない部署ID → 整合性違反）
* 部署ID変更で社員が古い部署IDのまま → 不整合

参照操作で「親表と子表のデータの整合性」を確実に保つ。

---

## １－３　試験の着眼点（頻出領域と解答に必要な知識）

* 出題ポイントは **参照操作の種類と動作の対応**
* **RESTRICTとNO ACTIONの違い** が狙われやすい
* **SET NULLとSET DEFAULTの混同**も頻出

---

## １－４　体系マップ（比較表）

| 参照操作        | 動作内容                      | 使用例SQL                  | 注意点                |
| ----------- | ------------------------- | ----------------------- | ------------------ |
| CASCADE     | 親削除/更新時に子も削除/更新           | `ON DELETE CASCADE`     | 子データが一括削除されるのでリスク大 |
| RESTRICT    | 子が残っていると親削除/更新を拒否         | `ON DELETE RESTRICT`    | 即時エラー              |
| NO ACTION   | 直ちにエラーは出さず、最終チェックで違反ならエラー | `ON DELETE NO ACTION`   | RESTRICTとの違いが試験狙い  |
| SET NULL    | 親削除/更新時に子外部キーをNULLに       | `ON DELETE SET NULL`    | 外部キー列がNULL許容必須     |
| SET DEFAULT | 親削除/更新時に子外部キーを既定値に        | `ON DELETE SET DEFAULT` | デフォルト値の定義が必須       |

---

## １－５　代表例（SQL仕様）

### 部署・社員テーブル定義（例）

```sql
CREATE TABLE 部署 (
  部署ID   INT PRIMARY KEY,
  部署名   VARCHAR(50)
);

CREATE TABLE 社員 (
  社員ID   INT PRIMARY KEY,
  社員名   VARCHAR(50),
  部署ID   INT,
  FOREIGN KEY (部署ID)
    REFERENCES 部署(部署ID)
    ON DELETE CASCADE
    ON UPDATE CASCADE
);
```

### 各参照操作の指定例

* CASCADE

  ```sql
  FOREIGN KEY (部署ID) REFERENCES 部署(部署ID)
  ON DELETE CASCADE;
  ```

  → 部署削除時に社員も削除

* RESTRICT

  ```sql
  FOREIGN KEY (部署ID) REFERENCES 部署(部署ID)
  ON DELETE RESTRICT;
  ```

  → 部署に社員が残っていたら削除不可

* NO ACTION

  ```sql
  FOREIGN KEY (部署ID) REFERENCES 部署(部署ID)
  ON DELETE NO ACTION;
  ```

  → 一見似ているが、整合性チェックのタイミングが異なる

* SET NULL

  ```sql
  FOREIGN KEY (部署ID) REFERENCES 部署(部署ID)
  ON DELETE SET NULL;
  ```

  → 部署削除時、社員の部署IDをNULLに（NULL許容必須）

* SET DEFAULT

  ```sql
  FOREIGN KEY (部署ID) REFERENCES 部署(部署ID)
  ON DELETE SET DEFAULT;
  ```

  → 部署削除時、社員の部署IDを既定値に置換（DEFAULT必須）

---

## １－６　よくある誤解と正しい知識

* 誤解①：RESTRICTとNO ACTIONは完全に同じ
  → 厳密には違う（チェックタイミングの差）。
* 誤解②：SET NULLはどんな外部キーでも使える
  → 外部キーがNOT NULLならエラーになる。
* 誤解③：CASCADEを使えば安全
  → 子データが意図せず削除される危険あり。

---

## １－７　一問一答（5問）

**問１**
部署を削除したら社員も自動で削除されるのは？
→ 回答：`CASCADE`
→ 解説：親と一緒に子も削除。

**問２**
部署削除時、社員が残っていたら削除できないのは？
→ 回答：`RESTRICT`
→ 解説：即座にエラー。

**問３**
部署削除時、社員の部署IDがNULLになるのは？
→ 回答：`SET NULL`
→ 解説：NULL許容必須。

**問４**
部署削除時、社員の部署IDが「未所属(999)」に置換されるのは？
→ 回答：`SET DEFAULT`
→ 解説：事前にデフォルト値を設定しておく必要あり。

**問５**
部署ID更新時、社員の部署IDも自動更新されるのは？
→ 回答：`ON UPDATE CASCADE`
→ 解説：親キー変更が子にも反映される。

---

## １－８　要約（3行以内）

参照操作は外部キー制約で、親データ削除／更新時の子データ処理を定める。
種類は CASCADE／RESTRICT／NO ACTION／SET NULL／SET DEFAULT の5つ。
試験ではRESTRICTとNO ACTION、SET NULLとSET DEFAULTの違いを狙われやすい。

---

👉 このあと、実際に `社員` と `部署` にデータをINSERTして、各参照操作を実行した結果例（削除後の社員表の状態）まで整理すると、さらに理解が深まります。
要りますか？
