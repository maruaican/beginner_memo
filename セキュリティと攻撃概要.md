了解しました。**CSRFを含めて最初から作り直し**、対策を「なぜ必要か／どう実装するか」まで丁寧に示します。用語と表記はIPA準拠で統一し、試験で**狙われやすい混同**も明示します。

---

# Webアプリ攻撃の体系と対策（OSコマンドインジェクション／SQLインジェクション／クロスサイトスクリプティング／セッションハイジャック／CSRF）

## １　全体像（テキスト図）

```
[利用者入力 or 攻撃者誘導]
           │
           ▼
 ┌──────────────────────────────┐
 │ Webアプリケーション（サーバ側） │
 ├─(A) OSコマンド呼出 →【OSコマンドインジェクション】
 ├─(B) SQL生成／実行 →【SQLインジェクション】
 ├─(C) HTML生成／出力 →【クロスサイトスクリプティング（XSS）】
 ├─(D) セッション管理 →【セッションハイジャック】
 └─(E) 跨サイト送信   →【CSRF（クロスサイトリクエストフォージェリ）】
                                      ▲
                                      │（被害者ブラウザが正規Cookieを自動送信）
```

※参照用：**ディレクトリトラバーサル**は「入力値をファイル名に使う」系の別攻撃（XSSではない）。

---

## １－１　定義（IPA準拠）と用語の由来

* **OSコマンドインジェクション**
  定義：ユーザ入力をOSコマンドの一部として扱い、サーバ上で不正なOSコマンドを実行させる攻撃。
  語源：Injection＝「注入」。本来のコマンド列に外部入力を**注ぎ込む**比喩。

* **SQLインジェクション**
  定義：ユーザ入力をSQL文の一部に組み込ませ、意図しないSQLを実行させる攻撃。
  語源：Structured Query Language（SQL）＋Injection。

* **クロスサイトスクリプティング（XSS）**
  定義：動的ページに悪意のスクリプトを混入させ、被害者のブラウザで実行させる攻撃。
  語源：Cross-site＝サイトを**越境**、Scripting＝スクリプト実行。

* **セッションハイジャック**
  定義：セッションID等を盗取・推測・固定化して、認証済みセッションを**奪取**する攻撃。
  語源：Hijack＝「横取り・乗っ取り」。

* **CSRF（クロスサイトリクエストフォージェリ）**
  定義：被害者を別サイトから誘導し、被害者のブラウザに**正規Cookieを自動送信**させて、不正リクエストを実行させる攻撃。
  語源：Forgery＝「偽造」。**別オリジン**からの**正規リクエストを装う**。

---

## １－２　技術の必要性（解決する具体的課題）

* OSコマンドインジェクション：**シェル呼出**にユーザ入力を混ぜると、攻撃者が任意コマンドを実行できる。
* SQLインジェクション：**SQL連結**を許すと、認証回避・情報漏えい・改ざんが発生する。
* XSS：**ブラウザ実行**を許すと、Cookie窃取、DOM改ざん、フィッシングが起きる。
* セッションハイジャック：**推測・盗聴・固定**に弱いIDだと、なりすましが成立する。
* CSRF：**正規Cookieの自動送信**を悪用されると、本人意思なしに状態変更が行われる。

---

## １－３　試験の着眼点（頻出領域と解答に必要な知識）

* 試験作成者が狙う混同（代表例）
  （１）XSS ↔ CSRF …「別サイトを介す」が共通だが、**XSSはスクリプト実行、CSRFは正規リクエスト送信**。
  （２）OSコマンドインジェクション ↔ セッションハイジャック …**前者はサーバOS実行、後者はセッション奪取**。
  （３）XSS ↔ ディレクトリトラバーサル …**XSSはブラウザ標的、ディレクトリトラバーサルはサーバ内ファイル標的**。
  （４）SQLインジェクション対策で\*\*「入力チェックのみ」**を選ばせる誤答。正答は**バインド機構\*\*。
  （５）CSRF対策で\*\*「HttpOnly」**を選ばせる誤答。正答は**CSRFトークン／SameSite\*\*等。

* 解答に必要な最小セット
  ① 攻撃の**標的**（サーバOS／DB／ブラウザ／セッション／被害者ブラウザのCookie）
  ② **成立条件**（連結・出力未エスケープ・ID弱さ・正規Cookie自動送信）
  ③ **第一選択の対策**（実装手段まで）＋**補助策**＋**誤答で選びがち**の組

---

## １－４　体系マップ（分類・関係・比較表：対策を実装レベルで詳述）

| 攻撃                 | 標的/成立条件                             | 第一選択の対策（実装）                                                                                                    | 併用すべき補助策                                                                                             | 誤答で選びがち（試験が狙う）                                               |
| ------------------ | ----------------------------------- | -------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| **OSコマンドインジェクション** | サーバOS。**シェルに入力を連結**すると成立。           | **シェル呼出をやめてAPIで代替**（例：ファイル操作＝標準ライブラリ、圧縮＝専用ライブラリ）。どうしても外部コマンドが必要なら**引数配列で直接exec（シェルを介さない）**＋**固定コマンドのホワイトリスト**。 | 入力検証（英数字・許可文字のみ）、環境変数初期化、**権限最小化**（専用ユーザ／chroot／コンテナ）、**エラー出力抑止**、タイムアウト。                            | 「**セッションIDを推測困難にする**」→セッションハイジャック対策。                         |
| **SQLインジェクション**    | DB。**SQL文字列連結**で成立。                 | **プレースホルダ／バインド機構**（プリペアドステートメント）。**識別子（表名・項目名）の切替はホワイトリスト**で文字列連結禁止。                                           | DBユーザの権限最小化、**複文禁止**・**メタ文字無効化**設定、LIKEでの**ワイルドカードのエスケープ**、ログ監査。                                     | 「**入力チェックだけ**」「**出力エスケープ**」は不十分。                             |
| **XSS（反射／蓄積／DOM）** | **被害者ブラウザ**。**未エスケープ出力**で成立。        | **文脈別エスケープ**（HTML本文・属性・URL・JS文脈で適切にエンコード）。テンプレート／フレームワークの**自動エスケープを有効**。DOM操作は`textContent`等を使用。               | **CSP**（script-src等）で被害縮小、**HttpOnly**でCookie窃取を困難化、入力サニタイズ（HTML受入れ時のみ）、`innerHTML`禁止、Trusted Types。 | 「**SameSiteでXSSを防ぐ**」→SameSiteは**CSRF**緩和。                   |
| **セッションハイジャック**    | **セッションID**。**推測・盗聴・固定化**等で成立。      | **TLS（HTTPS）＋Secure属性＋HttpOnly属性**。**推測困難ID**（高エントロピー）、**ログイン直後のセッションID再生成**、**URL埋込禁止**。                      | セッション有効期限短縮、**SameSite**で他サイト送信抑制、ログアウト時失効、パス/ドメインの最小化、HSTS。                                         | 「**シェル起動禁止**」はOSコマンドインジェクション対策。                              |
| **CSRF**           | **被害者ブラウザが正規Cookieを自動送信**。XSS不要で成立。 | **CSRFトークン方式**（フォーム/非同期要求に**予測不能トークン**を照合）。**SameSite Cookie**（Lax/Strict）を有効化。**状態変更はPOST等**で実装、**GETは参照専用**。 | **Origin/Referer検証**、**カスタムヘッダ＋CORS**（XSRF対策パターン）、多要素／再認証、重要操作に確認画面。                                 | 「**HttpOnlyでCSRFは防げる**」→×（HttpOnlyはCookieのJS読取を防ぐ＝XSS対策の一部）。 |

※参照行：**ディレクトリトラバーサル**＝サーバの**非公開ファイル**を「`../`等」で辿る攻撃。**入力値をファイル名として直接使わない／ルート固定＋正規化＋許可拡張子**が基本。XSS対策ではない。

---

## １－５　代表例（正答例・誤答例）

* 正答例
  （１）SQLインジェクション：\*\*バインド機構（プレースホルダ）\*\*を使う。
  （２）XSS：**文脈別の出力エスケープ**を徹底する。
  （３）セッションハイジャック：**Secure＋HttpOnly＋推測困難ID＋TLS**。
  （４）OSコマンドインジェクション：**シェルを使わずAPIで代替**。
  （５）CSRF：**CSRFトークン＋SameSite**を実装する。

* 誤答例（試験で狙われやすい）
  （１）「XSS対策＝SameSite」→ ×（CSRF緩和）。
  （２）「CSRF対策＝HttpOnly」→ ×（XSS緩和）。
  （３）「SQLi対策＝入力チェックだけ」→ ×（**第一選択はバインド**）。
  （４）「セッションハイジャック対策＝シェル起動禁止」→ ×（OSコマンド）。
  （５）「XSS対策＝ファイル名に入力を使わない」→ ×（ディレクトリトラバーサル）。

---

## １－６　よくある誤解と対処

* 誤解①：**入力チェック**を厳格にすれば、SQLiもXSSもCSRFも防げる。
  対処：**第一選択**はそれぞれ**バインド／出力エスケープ／CSRFトークン+SameSite**。入力チェックは**補助**。

* 誤解②：HttpOnlyを付ければ**CSRF**は防げる。
  対処：HttpOnlyは**JSからCookieを読めなくする**だけ（XSS対策の一部）。CSRFは**トークン**が本丸。

* 誤解③：XSSとCSRFの違いは「スクリプトを使うかどうか」。
  対処：**XSS＝悪性スクリプト実行**、**CSRF＝正規Cookie自動送信での**「**不本意な要求**」。成立機序が異なる。

* 誤解④：セッションIDは長ければよい。
  対処：**推測困難性＋TLS＋再生成＋URL埋込禁止**など**複合対策**が必要。

* 誤解⑤：OSコマンドはクォートで十分。
  対処：**シェル非経由**（execve系／引数配列）＋**固定ホワイトリスト**が基本。クォートのみは不十分。

---

## １－７　一問一答（5問：問題→回答→解説）

**問１**
CSRFの**第一選択**の対策はどれか。
**回答**：CSRFトークン方式（予測不能トークンの照合）＋SameSite。
**解説**：トークンがないと、被害者ブラウザは**正規Cookie**だけで不正要求を成立させる。HttpOnlyはXSS緩和でありCSRFの本丸ではない。
**誤答例**：HttpOnly、出力エスケープ、入力チェック。

**問２**
SQLインジェクションに対して、入力チェックのみでは不十分な理由は何か。
**回答**：**連結自体**が根因であり、バインド機構で**値と命令を分離**しなければ防げない。
**解説**：正規表現での禁止語・長さ制限は回避されやすい。プレースホルダが第一選択。
**誤答例**：URLエンコードで十分、HTMLエスケープで十分。

**問３**
XSSの基本対策として正しいのはどれか。
**回答**：**文脈別の出力エスケープ**（HTML本文・属性・URL・JS文脈）。
**解説**：入力サニタイズは補助。`innerHTML`直書き禁止、CSPは被害縮小。
**誤答例**：SameSite属性、CSRFトークン。

**問４**
セッションハイジャックの**固定化攻撃**に有効な対策は何か。
**回答**：**ログイン直後のセッションID再生成**と**URL埋込禁止**。
**解説**：攻撃者が配布したIDでログインさせる手口を無効化する。
**誤答例**：出力エスケープ、OSコマンド禁止。

**問５**
OSコマンドインジェクションの直接的な根因を除去する対策はどれか。
**回答**：**シェルを介さずAPIで代替**、やむを得ない場合は**引数配列で実行＋固定ホワイトリスト**。
**解説**：シェル展開（\`;|&\$()\`\` 等）を通さない設計が最重要。
**誤答例**：セッションIDを長くする、SameSiteを付与する。

---

## １－８　要約（3行以内）

攻撃は**標的と成立条件**で識別する（OS／DB／ブラウザ／セッション／正規Cookie自動送信）。
対策は「**第一選択（本丸）＋補助策**」で記憶する（SQL＝バインド、XSS＝出力エスケープ、CSRF＝トークン）。
試験は**混同**（XSS↔CSRF、OSコマンド↔セッション）を狙う。対応表で誤答を排除する。
