
---
# サブクエリ 詳細解説

## 1. サブクエリの概要

### 1.1. 基本定義
サブクエリとは、SQL文の中に**入れ子（ネスト）になったSELECT文**のことです。**内側のSELECT文（サブクエリ）が先に実行**され、その**結果を外側のSQL文（親クエリ）に渡す**ことで、複雑な条件指定やデータ抽出を実現します。

サブクエリが返す結果の形式は、単一の値、複数行の単一列、または複数行の複数列など様々です。

### 1.2. サブクエリの分類
サブクエリは、いくつかの観点から分類することができます。

*   **使用する句による分類**
    *   **WHERE句サブクエリ**: **条件式**の中で使用する。
    *   **FROM句サブクエリ**: 一時的な**テーブル**（派生表）として使用する。
    *   **SELECT句サブクエリ**: 取得する**列**の一つとして使用する。
*   **結果の行数・列数による分類**
    *   **スカラサブクエリ**: 1行1列の**単一の値**を返す。
    *   **行サブクエリ**: 複数列を持つ**単一の行**を返す。
    *   **表サブクエリ**: **複数行・複数列**を返す。
*   **相関の有無による分類**
    *   **非相関サブクエリ**: 外側のクエリとは独立して単独で実行できる。サブクエリは一度だけ実行される。
    *   **相関サブクエリ**: 外側のクエリが処理している行の値を参照する。外側のクエリの行ごとにサブクエリが繰り返し実行される。



## 5. 相関サブクエリ (Correlated Subquery)

相関サブクエリは、サブクエリ（内側のクエリ）が親クエリ（外側のクエリ）の列を参照するサブクエリです。

### 5.1. 定義と特徴
*   **実行方式**: 親クエリの各行が処理されるたびに、その行の値を参照してサブクエリが**繰り返し実行**されます。
*   **非相関サブクエリとの比較**:

| 項目 | 相関サブクエリ | 非相関サブクエリ |
| :--- | :--- | :--- |
| **実行回数** | 親クエリの行数分、繰り返し実行 | 1回だけ実行 |
| **外部参照** | **あり**（親クエリの列を参照） | なし |
| **処理速度** | 遅くなる傾向がある | 速い傾向がある |
| **用途** | 行ごとの動的な比較や存在チェック | 固定的な値や集合との比較 |

### 5.2. 使用箇所ごとのパターン

#### 5.2.1. WHERE句での利用
*   **比較演算子**: 各行の値を、その行に関連するグループの集計値と比較します。
    *   **SQL例**: 自身が所属する部署の平均給与よりも高い給与をもらっている社員を抽出
        ```sql
        SELECT 社員名, 給与
        FROM 社員 s1
        WHERE 給与 > (
          SELECT AVG(給与)
          FROM 社員 s2
          WHERE s2.部署ID = s1.部署ID -- 親クエリの部署IDを参照
        );
        ```

*   **EXISTS / NOT EXISTS**: 親クエリの各行について、関連するデータがサブクエリ内に存在するかどうかをチェックします。
    *   **SQL例**: 一度でも注文を担当したことがある社員を抽出
        ```sql
        SELECT 社員名
        FROM 社員
        WHERE EXISTS (
          SELECT 1 -- '1'自体に意味はなく、行の存在チェックが目的
          FROM 注文
          WHERE 注文.社員ID = 社員.社員ID -- 親クエリの社員IDを参照
        );
        ```
    *   **`NOT EXISTS`** を使えば、「一度も注文を担当したことがない社員」を安全に抽出できます（`NOT IN` のNULL問題を回避可能）。

#### 5.2.2. SELECT句での利用
「4.2.2. 相関サブクエリ」で解説した通り、親クエリの行ごとに計算した値を新たな列として追加します。

#### 5.2.3. HAVING句での利用
`GROUP BY` で集計されたグループごとに、サブクエリを条件として利用します。
*   **SQL例**: 部署の平均給与が、全社平均よりも高い部署を抽出
    ```sql
    -- この例は非相関だが、HAVING句でサブクエリが使えることを示す
    SELECT 部署ID, AVG(給与) AS 平均給与
    FROM 社員
    GROUP BY 部署ID
    HAVING AVG(給与) > (SELECT AVG(給与) FROM 社員);
    ```

### 5.3. 相関サブクエリの注意点と試験対策
*   **外部参照の見逃し**: `WHERE s2.部署ID = s1.部署ID` のような相関条件を見落とし、非相関サブクエリと誤認しないように注意が必要です。
*   **性能問題**: 親クエリの行数が多くなると、繰り返し実行により性能が著しく低下する可能性があります。JOINへの書き換えを検討することが重要です。
*   **試験頻出パターン**:
    1.  **グループ内比較**: 「部署内の平均/最大値より大きい」など。
    2.  **存在チェック**: 「〜したことがある/ない顧客」など（`EXISTS` / `NOT EXISTS`）。
    3.  **ランキング**: 「部署内で給与がトップの社員」など。