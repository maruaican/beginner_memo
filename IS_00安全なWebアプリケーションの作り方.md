# 安全なウェブアプリケーションの作り方


はい、承知いたしました。
プロのテクニカルライターとして、【背景】と【目的】を理解し、【制約条件】と【補足ルール】に基づき、【資料】に含まれる専門的なIT用語に補足説明を追加します。

***

### １．全体像（テキスト図）

```
利用者 ─┐
         │
         ├─── Webブラウザ
         │
         │
         └──── 悪意のある攻撃者
                   │
                   │ (SQLインジェクション)      (不正なSQL文の注入)
                   ├─→ Webサーバ/Webアプリケーション ─→ DB（Database）
                   │
                   │ (クロスサイトスクリプティング)  (不正スクリプトの埋め込み)
                   ├─→ Webサーバ/Webアプリケーション
                   │           ↓
                   │       (スクリプトの実行)
                   └─→ 利用者のWebブラウザ
                          │
                          └→ 攻撃者 (情報送信)
```

### ２．定義（IPA準拠）と用語の由来

情報処理安全確保支援士の観点から、攻撃の定義をより詳細に、かつ根本的な脆弱性と関連付けて解説します。

  * **SQLインジェクション（SQL Injection, Injection：注入、「データベースへの命令文に、悪意のある命令を『注入』し、情報を盗み見たり改ざんしたりする攻撃」）**:
      * **定義**: Webアプリケーションが、データベースへの命令文（SQL文）を動的に組み立てる際に、利用者からの入力値を適切にエスケープ（無害化:プログラムにとって特別な意味を持つ文字を、単なる普通の文字として扱うように変換すること）せずに用いる脆弱性を悪用する攻撃。単なる不正な入力ではなく、データベースに対する認証回避や情報窃取、データ破壊を目的とした攻撃です。
      * **用語の由来**: 前述のとおりですが、特にセキュリティエンジニアリングの文脈では、この脆弱性が\*\*「入力検証の不備」\*\*に起因することが強調されます。

  * **クロスサイトスクリプティング（XSS（Cross-Site Scripting、Cross-Site：サイトを横断して、Scripting：スクリプトを実行する、「ウェブサイトの脆弱性を利用して悪意のあるプログラムを埋め込み、訪問者のブラウザ上で実行させる攻撃」））**:
      * **定義**: Webアプリケーションが、利用者からの入力を適切にサニタイジング（無害化）せずに、動的に生成するHTML（HyperText：テキストを超える、Markup：印付け、Language：言語、「ウェブページの構造やデザインを記述するための言語」）に出力する脆弱性を悪用し、利用者のブラウザ上で攻撃者が用意したスクリプトを実行させる攻撃。
      * **分類**: 反射型、格納型、DOM（Document Object Model、Document：文書、Object：モノ、Model：模型、「ウェブページをプログラムから操作するための仕組み」） Basedの3種類に大別されます。セキュリティ対策の観点からは、これらのタイプに応じた対策が必要です。

  * **クロスサイトリクエストフォージェリ（CSRF（Cross-Site Request Forgery、Cross-Site：サイトを横断して、Request：要求、Forgery：偽造、「ログイン中の利用者に、意図しない操作をさせるリクエストを『偽造』して送信させる攻撃」））**:
      * **定義**: Webアプリケーションが、リクエストの正当性を検証する仕組みを持たない脆弱性を悪用し、攻撃者が利用者の意ถしない操作を強制的に実行させる攻撃。
      * **用語の由来**: 「Forgery」は「偽造」を意味し、利用者になりすましてリクエストを**偽造**することに本質があります。

  * **セッションハイジャック（Session Hijack、Session：接続期間、Hijack：乗っ取る、「利用者がログインしている状態（セッション）を乗っ取り、その人になりすます攻撃」）**:
      * **定義**: WebアプリケーションがセッションID（Session：接続期間、ID：識別子、「ウェブサイトが個々の利用者を識別するための一時的な会員証のようなもの」）を安全に管理していない脆弱性を悪用し、攻撃者がセッションIDを推測・窃取・固定化することで、利用者の認証情報を乗っ取る攻撃。
      * **用語の由来**: ネットワーク通信における「セッション」を「乗っ取る（Hijack）」ことから、この名称がつけられました。

### ３．技術の必要性（解決する具体的課題）
  * **入力値の検証・無害化**: ユーザーからの入力はすべて信頼できないものとして扱い、データベースやHTMLなど、利用されるコンテキスト（Context、「プログラムが実行される際の『状況』や『環境』」）に応じて適切な無害化処理を施すことが、SQLインジェクションやXSSを防ぐ大前提です。
  * **セッション管理の厳格化**: セッションIDの推測困難性、盗聴防止、固定化対策など、セッション管理のライフサイクル全体にわたるセキュリティ確保が、セッションハイジャックを防ぐ上で不可欠です。
  * **リクエストの正当性検証**: Webアプリケーションの重要な機能（例：パスワード変更、決済処理）を実行する際、利用者の意図を再確認する仕組み（例：ワンタイムトークン（One-Time Token、One-Time：一度きりの、Token：しるし、「一度しか使えない使い捨てのパスワードや整理券のようなもの」））を導入することが、CSRF（Cross-Site Request Forgery）を防ぐ上で不可欠です。

### ４．試験の着眼点（頻出領域と解答に必要な知識を解説）
  * **脆弱性の特定**: 問題文に示されるソースコード（Source Code、Source：源、Code：符号、「コンピュータプログラムがどのように動くかが書かれた、人間が理解できる形式の設計図」）や通信ログから、SQLインジェクション、XSS、CSRFなどの脆弱性がどこに存在するかを正確に読み取る能力が求められます。
  * **対策の選択**: 複数の対策候補の中から、システムのパフォーマンスや運用に与える影響、対策の網羅性を考慮して最適なものを選ぶ必要があります。例えば、`SQLインジェクション対策として、静的プレースホルダ（Static Placeholder、Static：静的な、Placeholder：場所取り、「命令文のテンプレートを先に用意し、後から安全にデータだけを埋め込む仕組み」）はパフォーマンスが高速であり、かつ安全性が高いことから、推奨される対策`であることが多いです。
  * **多層防御の理解**: 単一の対策に依存するのではなく、入力検証、セッション管理、認証、通信の暗号化など、複数のレイヤ（Layer、「階層構造で考えたときの、それぞれの『層』」）でセキュリティを確保する「多層防御」の考え方が重要となります。

### ５．体系マップ（分類・関係・比較表）
| 攻撃手法 | 脆弱性の根本原因 | 代表的な対策 |
| :--- | :--- | :--- |
| **SQLインジェクション** | SQL文の動的生成における入力検証不備 | プリペアドステートメント（Prepared Statement、Prepared：準備された、Statement：文、「命令文を事前に準備しておく仕組み。SQLインジェクション対策に効果的」）（静的プレースホルダ（Static Placeholder、Static：静的な、Placeholder：場所取り、「命令文のテンプレートを先に用意し、後から安全にデータだけを埋め込む仕組み」））、\エスケープ（escape、「プログラムにとって特別な意味を持つ文字を、単なる普通の文字として扱うように変換すること」）処理 |
| **クロスサイトスクリプティング（XSS（Cross-Site Scripting、Cross-Site：サイトを横断して、Scripting：スクリプトを実行する、「ウェブサイトの脆弱性を利用して悪意のあるプログラムを埋め込み、訪問者のブラウザ上で実行させる攻撃」））** | 出力処理における入力値のサニタイジング不備 | 入力値の無害化（HTMLエスケープ）、\WAF（Web Application Firewall、Web Application：ウェブアプリケーション、Firewall：防火壁、「ウェブアプリへの攻撃を検知・防御する防火壁システム」）、\CSP（Content Security Policy、Content：コンテンツ、Security：セキュリティ、Policy：方針、「ウェブサイトが読み込んで良いコンテンツの出所を厳密に指定するセキュリティ上の『方針』」） |
| **クロスサイトリクエストフォージェリ（CSRF（Cross-Site Request Forgery、Cross-Site：サイトを横断して、Request：要求、Forgery：偽造、「ログイン中の利用者に、意図しない操作をさせるリクエストを『偽造』して送信させる攻撃」））** | リクエストの正当性検証の不備 | ワンタイムトークン（One-Time Token、One-Time：一度きりの、Token：しるし、「一度しか使えない使い捨てのパスワードや整理券のようなもの」）（同期トークン）、\Refererヘッダ（Referer Header、Referer：参照元、Header：ヘッダ情報、「利用者がどのページから来たかを示す通信情報の一部」）の検証、\SameSite Cookie属性（SameSite Cookie Attribute、SameSite：同じサイト、Cookie：クッキー、Attribute：属性、「外部サイトからのリクエスト時にCookieが送信されるのを制限する設定」） |
| **セッションハイジャック（Session Hijack、Session：接続期間、Hijack：乗っ取る、「利用者がログインしている状態（セッション）を乗っ取り、その人になりすます攻撃」）** | セッションID（Session Identifier、Session：接続期間、ID：識別子、「ウェブサイトが個々の利用者を識別するための一時的な会員証のようなもの」）の管理不備 | セッションIDの推測困難化（乱数性の向上）、\SSL/TLS（Secure Sockets Layer / Transport Layer Security、「インターネット上の通信を暗号化する技術」）による通信暗号化、\セッションIDの定期的な再生成、\タイムアウトの設定 |

### ６．代表例（正答例・誤答例）
**正答例**

  * **SQLインジェクション（Structured Query Language Injection、Structured：構造化された、Query：問い合わせ、Language：言語、Injection：注入、「データベースへの命令文に、悪意のある命令を『注入』し、情報を盗み見たり改ざんしたりする攻撃」）** ↔ **静的プレースホルダ（Static Placeholder、Static：静的な、Placeholder：場所取り、「命令文のテンプレートを先に用意し、後から安全にデータだけを埋め込む仕組み」）**
      * **解説**: プリペアドステートメント（Prepared Statement、Prepared：準備された、Statement：文、「命令文を事前に準備しておく仕組み。SQLインジェクション対策に効果的」）（静的プレースホルダ）は、SQL文の骨格とパラメータ（Parameter、「プログラムの動作を変化させるために渡す値や情報」）を分離してデータベースに送信します。データベースは、SQL文を最初にコンパイル（Compile、「人間が書いたプログラムをコンピュータが理解できる言葉に翻訳すること」）し、後から送られてくるパラメータを単なるデータとして扱います。この処理特性により、パラメータ中にSQLの構文を構成する特殊文字が含まれていても、命令として解釈されることはありません。これは、攻撃者が意図したSQL文の実行を根本的に防ぐ、最も効果的かつ高速な対策です。

**誤答例**

  * **クロスサイトスクリプティング（XSS（Cross-Site Scripting、Cross-Site：サイトを横断して、Scripting：スクリプトを実行する、「ウェブサイトの脆弱性を利用して悪意のあるプログラムを埋め込み、訪問者のブラウザ上で実行させる攻撃」））** ↔ **HTTP Only属性（HttpOnly Attribute、HTTP：ウェブの通信ルール、Only：だけ、Attribute：属性、「プログラムからCookieを読み取れなくする設定」）が付与されていないCookie（Cookie、「ウェブサイトが利用者のPCに一時的に保存する小さなデータ」）の利用**
      * **解説**: HTTP Only属性が付与されていないCookieは、JavaScriptからアクセスが可能です。このため、XSSによってCookie情報が容易に窃取されてしまいます。セッション情報を含む重要なCookieには、必ずHTTP Only属性を付与し、JavaScriptからのアクセスを禁止すべきです。


### ７．よくある誤解と正しい知識
  * **誤解**: クロスサイトスクリプティングは、Webアプリケーションの入力フォームのみに存在する脆弱性である。
      * **正しい知識**: XSS（Cross-Site Scripting）は、入力フォームだけでなく、URL（Uniform Resource Locator）のパラメータやHTTPヘッダ（HTTP Header、HTTP：ウェブの通信ルール、Header：先頭部分、「通信の際にデータ本体に付随する追加情報」）、ファイルアップロードなど、Webアプリケーションが利用者からデータを受け付けるすべての箇所に潜在する可能性があります。攻撃の種類も、反射型、格納型、DOM（Document Object Model、「ウェブページをプログラムから操作するための仕組み」） Basedなど多岐にわたり、それぞれ異なる対策が求められます。情報処理安全確保支援士は、これらの多様な攻撃経路と対策を網羅的に理解し、設計段階から対策を講じる必要があります。

### ８．一問一答（5問：問題→回答→解説）
**問題１**
Webアプリケーションにおいて、SQLインジェクション対策として、パフォーマンスの観点から最も優れている手法はどれか。
**回答**
プリペアドステートメント（Prepared Statement、Prepared：準備された、Statement：文、「命令文を事前に準備しておく仕組み。SQLインジェクション対策に効果的」）（静的プレースホルダ（Static Placeholder、Static：静的な、Placeholder：場所取り、「命令文のテンプレートを先に用意し、後から安全にデータだけを埋め込む仕組み」））の利用
**解説**
プリペアドステートメントは、SQL文をあらかじめコンパイル（Compile、「人間が書いたプログラムをコンピュータが理解できる言葉に翻訳すること」）しておくため、同じSQL文が繰り返し実行される場合、コンパイル処理のオーバーヘッド（Overhead、「本来の処理に加えて付随的にかかってしまう負荷」）が削減され、高速な実行が期待できます。また、パラメータ（Parameter、「プログラムの動作を変化させるために渡す値や情報」）は後からバインド（Bind、「データや値を特定の場所に割り当てること」）されるため、SQLインジェクション攻撃を根本的に防ぐことが可能です。

**問題２**
セッションハイジャック（Session Hijack、Session：接続期間、Hijack：乗っ取る、「利用者がログインしている状態（セッション）を乗っ取り、その人になりすます攻撃」）攻撃を最も効率的に防ぐために、HTTPレスポンスヘッダ（「サーバがブラウザに応答する際に送る追加情報」）に追加すべき推奨属性はどれか。
**回答**
`Set-Cookie`ヘッダにおける`Secure`と`HttpOnly`属性
**解説**
`Secure`属性は、Cookie（Cookie、「ウェブサイトが利用者のPCに一時的に保存する小さなデータ」）がHTTPS通信でのみ送信されるように強制し、盗聴を防ぎます。`HttpOnly`属性は、JavaScriptからのCookieへのアクセスを禁止し、XSS（Cross-Site Scripting）によるCookieの窃取を防ぎます。これら二つの属性は、セッションハイジャック対策の基本中の基本です。

**問題３**
Webアプリケーション開発におけるCSRF（Cross-Site Request Forgery）対策として、二重送信防止トークン（ワンタイムトークン（一度しか使えない使い捨てのパスワードや整理券のようなもの）の仕組みを詳細に説明せよ。
**回答**
①フォームを生成する際に、サーバ側で推測困難なランダムなトークンを生成し、セッションに保存します。②このトークンをWebページの隠しフィールドに含めて、利用者のブラウザに送信します。③利用者がフォームを送信する際、トークンも一緒にサーバに送られます。④サーバは、受信したトークンとセッションに保存しておいたトークンを比較し、一致した場合のみ処理を実行します。
**解説**
この仕組みにより、攻撃者が用意した偽のフォームには正しいトークンが含まれないため、サーバ側で不正なリクエストを拒否することができます。

**問題４**
Webアプリケーションのセキュリティ診断において、クロスサイトスクリプティング（XSS（Cross-Site Scripting）脆弱性を発見するために、入力値に含めるべき文字列の例を挙げよ。
**回答**
`<script>alert(1)</script>`
**解説**
この文字列は、HTMLの`<script>`タグを閉じることで、JavaScriptの`alert()`関数を実行させようとするものです。この文字列が、Webページの表示時にブラウザ上でダイアログ（Dialog、「利用者への通知や入力要求のための小さなウィンドウ」）を表示した場合、XSS脆弱性が存在すると判断できます。

**問題５**
SQLインジェクション対策として、エスケープ処理を行う際の課題を述べよ。
**回答**
エスケープ処理は、使用するデータベースや文字コードによってルールが異なるため、実装が複雑であり、漏れが生じるリスクがあります。また、開発者がすべての特殊文字を正確にエスケープする必要があり、ヒューマンエラーが発生しやすい点も課題です。
**解説**
このため、IPAを含む多くのセキュリティ機関は、エスケープ処理よりも、より安全で実装が容易なプリペアドステートメント（Prepared Statement、Prepared：準備された、Statement：文、「命令文を事前に準備しておく仕組み。SQLインジェクション対策に効果的」）の利用を推奨しています。

### ９．要約（3行以内）

情報処理安全確保支援士レベルの解説では、SQLインジェクション、クロスサイトスクリプティング（XSS（Cross-Site Scripting、Cross-Site）、クロスサイトリクエストフォージェリ（CSRF（Cross-Site Request Forgery）、セッションハイジャックについて、脆弱性の根本原因、攻撃の仕組み、そして最も効果的な対策技術を深く理解することが求められます。単一の知識ではなく、セキュリティの多層防御の視点から、最適な対策を論理的に選択する能力が重要です。