
***

## 【応用情報技術者試験対策】SELECT句サブクエリ（スカラサブクエリ）の完全攻略

### 1. SELECT句サブクエリの定義と絶対的ルール：スカラーであるべし

SELECT句に記述するサブクエリは、その返す値の性質から「**スカラサブクエリ**」と呼ばれます。

#### 1.1. 定義と特徴
スカラサブクエリとは、SELECT句の中に記述される副問合せであり、外側のクエリが処理する各行に対して、追加情報を1つの列として付加する目的で利用されます。
最大の特徴は、**結果として必ず「1行1列」の単一の値（スカラ値）を返さなければならない**という厳格なルールです。もし、サブクエリが複数行や複数列を返した場合、構文エラーとなります。

#### 【試験本番での着眼点】
以下のポイントを意識して問題文のSQLを確認しましょう。
1. **[複数列チェック]** サブクエリ内の`SELECT`の直後に、列名がカンマで区切られ複数指定されていないか確認する。
2. **[原則]** SELECT句にサブクエリを見つけたら、まず「**本当に1行1列しか返さないか？**」を疑う。
3. **[複数行チェック]** `IN`, `EXISTS`, `ALL`, `ANY`など、複数行を扱う前提の演算子がSELECT句サブクエリで使われていないか確認する（これらは使えません）。

4. **[頻出パターン]** 相関サブクエリ内での`GROUP BY`は、複数列を返そうとしている誤用パターンである可能性が高い。

#### 1.2. 他の句のサブクエリとの比較
サブクエリが使用できる句はSELECT句に限りませんが、句によって返せる結果の形式が異なります。この違いを混同しないことが重要です。

| 使用する句 | 返せる結果の形式 | 役割 |
| **SELECT句** | **1行1列（スカラ値）限定** | 列の値として利用 |
| **FROM句** | 複数行・複数列 OK | 仮想的なテーブルとして利用 |
| **WHERE句** | 複数行 OK （IN, EXISTSなどで利用） | 条件判定の値として利用 |

### 2. スカラサブクエリの種類と具体例
スカラサブクエリは、外側のクエリとの関連性の有無によって「非相関サブクエリ」と「相関サブクエリ」に大別されます。

#### 2.1. 非相関サブクエリ
サブクエリが外側のクエリに依存せず、独立して実行されるタイプです。サブクエリは最初に一度だけ実行され、その結果が外側のクエリのすべての行で共通して使用されます。

**SQL例：全社員の給与と「全社の平均給与」を表示する**
```sql
SELECT
    社員名,
    給与,
    (SELECT AVG(給与) FROM 社員) AS 全社平均給与
FROM 社員;
```
この例では、サブクエリ`(SELECT AVG(給与) FROM 社員)`は単独で動作し、全社員の平均給与という単一の値を計算します。その結果が、`全社平均給与`列の全ての行に表示されます。

#### 2.2. 相関サブクエリ
サブクエリが、外側のクエリが処理している現在の行の値を参照するタイプです。外側のクエリの行が一つ処理されるたびに、サブクエリもその行に対応する値を計算するために実行されます。そのため、行ごとに異なる結果を返すことが可能です。

**SQL例：各社員の給与と、その社員が所属する「部署の平均給与」を表示する**
```sql
SELECT
    社員名,
    給与,
    (SELECT AVG(給与)
     FROM 社員 AS 同部署
     WHERE 同部署.部署ID = 社員.部署ID) AS 部署平均給与
FROM 社員;
```
この例では、サブクエリ内の`WHERE 同部署.部署ID = 社員.部署ID`という条件で、外側のクエリ（`FROM 社員`）の現在の行が持つ`部署ID`を参照しています。これにより、メインクエリの1行ごとに、その行の社員と同じ部署に所属する社員だけの平均給与が算出されます。

> **補足：相関サブクエリとGROUP BY**
> 上記の例では、サブクエリ内で平均値を算出していますが`GROUP BY`は不要です。これは、相関条件によってデータが**既に対象の1部署に限定されている**ため、その範囲で1つの平均値を計算するだけであり、グループ化の必要がないからです。

### 3. 【試験最重要】狙われやすい誤答パターンと着眼点

応用情報技術者試験では、「スカラサブクエリは1行1列しか返せない」というルールを正しく理解しているかを問う問題が頻出します。典型的な誤答パターンを把握し、正しく見抜けるようになりましょう。

#### 3.1. 誤答パターン1：複数行を返してしまう
SELECT句のサブクエリが、結果として複数行を返してしまうケースは典型的な誤りです。

**【誤答例】IN句を使い、複数部署のIDを返そうとしている**
```sql
-- エラーになるSQL
SELECT
    社員名,
    (SELECT 部署ID FROM 部署 WHERE 部署名 IN ('営業','開発')) AS 所属部署
FROM 社員;
```
*   **誤りの理由**: `IN ('営業','開発')`という条件では、「営業部」と「開発部」の2つの部署IDが返る可能性があります。サブクエリが複数行を返すため、「1行1列」のルールに違反し、エラーとなります。

*   **修正方法**:
    1.  **集計関数で1行に集約する**: `MAX()`や`MIN()`を使い、強制的に1つの値に絞り込みます。
        ```sql
        -- 修正例1
        (SELECT MAX(部署ID) FROM 部署 WHERE 部署名 IN ('営業','開発'))
        ```
    2.  **WHERE句の条件で1行に限定する**: 検索条件を厳しくし、必ず1行だけが返るようにします。
        ```sql
        -- 修正例2
        (SELECT 部署ID FROM 部署 WHERE 部署名 = '営業')
        ```

#### 3.2. 誤答パターン2：複数列を返してしまう
サブクエリ内のSELECTリストに複数の列を指定してしまうケースも、明確なルール違反です。

**【誤答例】相関サブクエリでGROUP BYを誤用し、複数列を返そうとしている**
```sql
-- エラーになるSQL
SELECT
    社員名,
    (SELECT 部署ID, AVG(給与)
     FROM 社員 AS 同部署
     WHERE 同部署.部署ID = 社員.部署ID
     GROUP BY 部署ID) AS 部署平均給与
FROM 社員;
```
*   **誤りの理由**: サブクエリの`SELECT`の次に`部署ID, AVG(給与)`と2つの属性（列）を指定しています。SELECT句サブクエリが返すことができるのは**1つの列のみ**であるため、この記述はエラーとなります。

*   **修正方法**: 返したい値を1列に絞ります。
    ```sql
    -- 修正例
    (SELECT AVG(給与)
     FROM 社員 AS 同部署
     WHERE 同部署.部署ID = 社員.部署ID)
    ```



### 4. パフォーマンス・可読性を高める代替手法

相関サブクエリは外側のクエリの行ごとに実行されるため、データ量が多い場合にパフォーマンスが低下する可能性があります。また、SQLが複雑になりがちです。このような場合、JOINやウィンドウ関数への書き換えが有効です。

#### 4.1. JOINによる書き換え
事前に部署ごとの平均給与を派生テーブルとして計算し、元のテーブルと結合します。

```sql
SELECT
    s.社員名,
    s.給与,
    d.部署平均給与
FROM 社員 AS s
JOIN (
    SELECT 部署ID, AVG(給与) AS 部署平均給与
    FROM 社員
    GROUP BY 部署ID
) AS d ON s.部署ID = d.部署ID;
```

#### 4.2. ウィンドウ関数による書き換え
`OVER (PARTITION BY ...)` を使うことで、集計と同時に個々の行のデータを保持できます。可読性が高く、パフォーマンス面でも有利なことが多い手法です。

```sql
SELECT
    社員名,
    給与,
    AVG(給与) OVER (PARTITION BY 部署ID) AS 部署平均給与
FROM 社員;
```

### 5. まとめ
*   SELECT句に書けるサブクエリは、**1行1列のスカラ値**を返す「スカラサブクエリ」のみです。
*   試験では、サブクエリが「**複数行**」または「**複数列**」を返していないかを確認することが最も重要です。
*   特に`IN`句や、相関サブクエリ内での不適切な`GROUP BY`の使用は、典型的な誤答パターンとして頻出します。
*   パフォーマンスや可読性の観点から、**JOIN**や**ウィンドウ関数**への書き換えも選択肢として理解しておきましょう。
