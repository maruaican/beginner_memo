
---

# 集合演算（Set Operations）とリレーション演算（Relational Operations）の体系的解説

## 1. はじめに：根本的な違いを理解する

集合演算とリレーション演算は、データベースからデータを取り出す際に使われる基本的な操作ですが、その目的と結果は根本的に異なります。まずは、その直感的なイメージを掴みましょう。

*   **集合演算（Set Operations）**: テーブルを**縦方向**に操作します。結果としてレコード（行）が増減します。
    *   **イメージ**: 複数の顧客リストを「縦に積み上げる」ような操作です。
    
*   **リレーション演算（Relational Operations）**: テーブルを**横方向**に操作します。結果としてカラム（列）が広がります。
    *   **イメージ**: 顧客情報と注文情報を「横に並べて」関連付けるような操作です。

### よくある誤解と正しい知識

*   **誤解**: 「`UNION`（集合演算）と`JOIN`（リレーション演算）は似たようなものだ」
*   **正しい知識**: `UNION`はデータを**縦に積む**操作、`JOIN`はデータを**横に広げる**操作であり、目的が全く異なります。

## 2. 定義と目的

それぞれの演算の学術的な定義と、実務でどのような課題を解決するために使われるのかを解説します。

### 2.1. 用語の定義と由来

*   **集合演算 (Set Operations)**
    *   **定義**: 複数の問い合わせ結果（テーブル）を数学的な「集合」として扱い、和（`UNION`）、積（`INTERSECT`）、差（`EXCEPT`）を求める演算です。
    *   **由来**: 数学の**集合論（Set Theory）**が語源となっています。

*   **リレーション演算 (Relational Operations)**
    *   **定義**: **関係データモデル（Relational Model）**の代数に基づき、複数の表（リレーション）から結合（`JOIN`）、射影（`SELECT`）、選択（`WHERE`）といった操作を行う演算です。
    *   **由来**: 関係（リレーション）という言葉に由来します。

### 2.2. それぞれの技術が解決する課題

*   **集合演算の用途**: **同じ構造を持つデータ**を統合・比較する際に使用します。
    *   **具体例**: 東日本支店と西日本支店の顧客リストを一つに合体させる、二重登録されている顧客を特定・除去する、といった課題を解決します。

*   **リレーション演算の用途**: **異なる構造を持つデータ**を関連付けて、新たな知見を得るために使用します。
    *   **具体例**: 「顧客」テーブルと「注文」テーブルを結び付けて、誰がいつ何を買ったのかを分析する、といった課題を解決します。

## 3. 詳細比較：集合演算 vs リレーション演算

両者の技術的な違いを以下の表にまとめます。

| 観点 | 集合演算 | リレーション演算 |
| :--- | :--- | :--- |
| **出力方向** | **縦**（行が増減する） | **横**（列が広がる） |
| **代表的なSQL句** | `UNION`, `UNION ALL`, `INTERSECT`, `EXCEPT` (`MINUS`) | `INNER JOIN`, `LEFT JOIN`, `RIGHT JOIN`, `FULL OUTER JOIN`, `CROSS JOIN` |
| **制約** | 比較するテーブル間で**列の数・データ型・順序が一致**している必要がある | テーブル間を関連付ける**結合条件**（例: `ON customer.id = order.customer_id`）が必要 |
| **重複の扱い** | `UNION`は重複行を**除去**する。<br>`UNION ALL`は重複行を**保持**する。 | `JOIN`は条件に一致するすべての組み合わせを返し、結果は**重複を保持**する（必要に応じて`DISTINCT`で除去）。 |
| **NULLの扱い** | `NULL = NULL` は**一致**とみなす（`INTERSECT`や`EXCEPT`の比較時）。 | `NULL = NULL` は**偽（False）**と評価されるため、`JOIN`の結合条件ではマッチしない。 |
| **実務用途** | 複数リストの統合、差分データの抽出、共通データの確認など。 | 顧客情報と注文情報の紐付け、売上分析、詳細レポート作成など。 |
| **SQL実行例** | ```sql<br>SELECT 顧客ID FROM 東日本顧客<br>UNION<br>SELECT 顧客ID FROM 西日本顧客;<br>``` | ```sql<br>SELECT C.顧客名, O.注文日<br>FROM 顧客 C<br>INNER JOIN 注文 O ON C.顧客ID = O.顧客ID;<br>``` |

## 4. 各演算子の解説とSQL実行例

### 4.1. 集合演算（Set Operations）

集合演算は、同じ構造を持つテーブル同士を縦に連結したり、比較したりするための操作です。

*   **主なSQL句**
    *   `UNION`: 2つの結果セットを結合し、重複行を除去する（和集合）。
    *   `UNION ALL`: 2つの結果セットを結合し、重複行を保持する。
    *   `INTERSECT`: 両方の結果セットに存在する行のみを返す（積集合）。
    *   `EXCEPT` (`MINUS`): 最初の結果セットにのみ存在し、2番目の結果セットには存在しない行を返す（差集合）。

*   **SQL実行例**

    *   **正答例**: 列数とデータ型が一致しているため、正常に実行されます。
      ```sql
      -- 東日本と西日本の顧客IDを重複なく統合する
      SELECT 顧客ID FROM 東日本顧客
      UNION
      SELECT 顧客ID FROM 西日本顧客;
      ```

    *   **誤答例**: `SELECT`句で指定している列数が異なるため、エラーとなります。
      ```sql
      -- 列数が異なるためエラーになる
      SELECT 顧客ID, `顧客名` FROM 東日本顧客
      UNION
      SELECT 顧客ID FROM 西日本顧客;
      ```

### 4.2. リレーション演算（Relational Operations）

リレーション演算は、共通のキーなどを使って異なるテーブルを横に連結し、より豊富な情報を持つ一つの結果セットを作成するための操作です。

*   **主なSQL句**
    *   `INNER JOIN`: 両方のテーブルに共通のキーが存在する行のみを結合する。
    *   `LEFT JOIN` (`LEFT OUTER JOIN`): 左側のテーブルのすべての行と、右側のテーブルの一致する行を結合する。一致しない場合は`NULL`で補完される。
    *   `RIGHT JOIN` (`RIGHT OUTER JOIN`): 右側のテーブルのすべての行と、左側のテーブルの一致する行を結合する。
    *   `FULL OUTER JOIN`: どちらかのテーブルにキーが存在すれば、すべての行を結合する。
    *   `CROSS JOIN`: 両方のテーブルの行のすべての組み合わせ（デカルト積）を生成する。

*   **SQL実行例**
  ```sql
  -- 顧客テーブルと注文テーブルを顧客IDで結合し、顧客名と注文日を取得する
  SELECT 顧客.顧客名, 注文.注文日
  FROM 顧客
  INNER JOIN 注文 ON 顧客.顧客ID = 注文.顧客ID;
  ```

## 5. 学習者向けリファレンス

### 5.1. 試験で問われるポイント

資格試験などでは、両者の違いを理解しているかどうかが問われることが多いです。以下の点に注意してください。

*   **集合演算の注意点**
    *   列数やデータ型が一致していないとエラーになるという制約。
    *   `UNION`（重複除去）と `UNION ALL`（重複保持）の挙動の違い。
    *   `EXCEPT`を使った差分抽出と、`LEFT JOIN` + `IS NULL` を使った同等の処理の理解。

*   **リレーション演算の注意点**
    *   結合条件を `ON` 句に書く場合と `WHERE` 句に書く場合の違い（特に`OUTER JOIN`）。

    *   `INNER JOIN` と `INTERSECT` の役割の取り違え。
    *   前者は横に結合。両方のテーブルに共通するキーを持つ行が、結合された形で表示される。
    *   構造：行数は増えず、`列数が増える（横に広がる）`。
       
    *   後者は共通行の抽出。
    *   結果：両方のクエリに共通する行のみが返される。
    *   構造：列数は変わらず、`行数が絞られる（縦に絞り込む）`。
        
    *   `CROSS JOIN` を不用意に使うと、結果の行数が爆発的に増加するリスク。

### 5.2. 一問一答（Q&A）

**Q1: 集合演算で、比較するテーブルの列数が異なるとどうなりますか？**
**A1:** エラーになります。
**解説:** 集合演算は「同じ構造の集合」を扱うことが大前提です。

**Q2: `INNER JOIN`と`INTERSECT`の主な違いは何ですか？**
**A2:** `INNER JOIN`は共通キーでテーブルを**横に結合して広げる**のに対し、`INTERSECT`は完全に同一の行を**縦方向に比較して抽出**します。

**Q3: `UNION`と`UNION ALL`の違いは何ですか？**
**A3:** `UNION`は結果セットから重複する行を**削除**しますが、`UNION ALL`はすべての行を重複も含めて**保持**します。

**Q4: `LEFT JOIN`で、左テーブルの行に対応するデータが右テーブルに存在しない場合、その値はどうなりますか？**
**A4:** 右テーブルに対応するカラムはすべて`NULL`で補完されます。

**Q5: `CROSS JOIN`を実行した際の出力件数はどうなりますか？**
**A5:** （テーブルAの件数）×（テーブルBの件数）となります。
---



