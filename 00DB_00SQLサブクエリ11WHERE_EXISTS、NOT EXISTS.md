**EXISTS / NOT EXISTS** 

---

## １　全体像（テキスト図）

```
顧客（顧客ID → 顧客名） １→多 注文（注文ID → 顧客ID，注文日）
```

* EXISTS：ある行が「存在するか」を調べる。真偽値を返す。
* NOT EXISTS：ある行が「存在しないか」を調べる。真偽値を返す。

---

## １－１　定義（IPA準拠）と用語の由来

* **EXISTS述語**：サブクエリの結果が1行以上存在する場合に真を返すSQLの述語。
* **NOT EXISTS述語**：サブクエリの結果が0行の場合に真を返す。
* 由来：英語 *exist*（存在する）から。論理式として「存在する／存在しない」を判定。

---

## １－２　技術の必要性（解決する具体的課題）

* 課題：

  * 「注文を1件でもした顧客を抽出したい」
  * 「注文を一度もしていない顧客を抽出したい」
* EXISTS/NOT EXISTS は結合を使うより直感的に書け、不要な結合を避けられる。

---

## １－３　試験の着眼点（頻出領域と解答に必要な知識）

* 頻出領域：
  1. EXISTSを使った関連サブクエリ
  2. NOT EXISTSで「対応関係がない」データを探す問題。
  　　例：予約のない部屋＝空室を探す

* 必要知識：
  * サブクエリの評価順（FROM→WHERE→GROUP BY→HAVING→SELECT→ORDER BY）
  * 結果が「行の集合」ではなく「存在するかどうか」で判定されること

---

## １－４　体系マップ（比較表）

| 項目      | EXISTS             | IN              |
| ------- | ------------------ | --------------- |
| 判定基準    | 行が1件でもあれば真         | 値が一致すれば真        |
| NULLの影響 | 影響しない              | NULLがあると誤解しやすい  |
| 性能感     | 部分一致（見つけた時点で終了）で軽い | 値リスト全体を走査し重い場合も |
| 試験での狙い  | 「存在判定」で答えさせる問題     | 「集合一致」で答えさせる問題  |

---

## １－５　代表例（正答例・誤答例）

### テーブル例

**顧客**
| 顧客ID | 顧客名 |
| ---- | --- |
| 1    | 佐藤  |
| 2    | 鈴木  |
| 3    | 高橋  |

**注文**
| 注文ID | 顧客ID | 注文日        |
| ---- | ---- | ---------- |
| 101  | 1    | 2023-01-10 |
| 102  | 1    | 2023-01-20 |
| 103  | 2    | 2023-01-15 |

---
### 正答例（注文した顧客）
```sql
SELECT 顧客名
FROM 顧客 C
WHERE EXISTS (
    SELECT *
    FROM 注文 O
    WHERE O.顧客ID = C.顧客ID
);
```

**出力結果**
| 顧客名 |
| --- |
| 佐藤  |
| 鈴木  |
※顧客表と注文表の両方に存在する顧客IDで抽出したうえで、顧客名を表示している。
---
### 正答例（注文を一度もしていない顧客）
```sql
SELECT 顧客名
FROM 顧客 C
WHERE NOT EXISTS (
    SELECT *
    FROM 注文 O
    WHERE O.顧客ID = C.顧客ID
);
```

**出力結果**
| 顧客名 |
| --- |
| 高橋  |
※顧客表と注文表のどちらにも存在しない顧客ID　3 で抽出したうえで、顧客名を表示している。
---

### 誤答例（NOT INを使ってNULLで失敗するパターン）
```sql
SELECT 顧客名
FROM 顧客
WHERE 顧客ID NOT IN (SELECT 顧客ID FROM 注文);
```
* NOT IN は「指定した集合に含まれない値を抽出する比較演算子」です。
* 用語の由来 英語の直訳：NOT（～ではない） + IN（～の中に）
* 直感的には「～の中に含まれない」という意味。
* 注意点として、サブクエリに **NULL が含まれると全体が`評価不能`（NULL扱い）になり、結果が空**になることがある。
* `これが試験作成者の「狙いどころ」`。試験では、NULL の有無を意識した設問がよく出題される。

---

## １－６　よくある誤解と正しい知識

* 誤解：「EXISTSは値を返す」
  → 正：EXISTSは真偽値を返す。`SELECT *` の部分は何を指定してもよい（慣習的に \* を使う）。
* 誤解：「NOT INとNOT EXISTSは同じ」
  → 正：NULLを含む場合に挙動が異なる。NOT EXISTSの方が安全。

---

## １－７　一問一答（5問）

**Q1** 注文を1件でも持つ顧客を抽出するSQLは？

* **回答**：EXISTSを使ったクエリ
* **解説**：結合ではなく「存在判定」が必要。

---

**Q2** 注文を一度もしていない顧客を抽出するSQLは？

* **回答**：NOT EXISTSを使う。
* **解説**：NOT INではNULLに弱い。

---

**Q3** EXISTS内の`SELECT *` を `SELECT 顧客ID` に書き換えると結果は変わる？

* **回答**：変わらない。
* **解説**：EXISTSは「行が存在するか」だけを判定する。列は評価されない。

---

**Q4** INとEXISTSの違いで正しいのは？

* **回答**：EXISTSは存在を確認、INは値の一致を確認。
* **解説**：NULLを含むとINは落とし穴になる。

---

**Q5** 「顧客ごとに最新の注文が存在するか」を判定する場合、何を使う？

* **回答**：EXISTS
* **解説**：サブクエリ内で日付比較を行い、最新注文が存在するかを調べる。

---

## １－８　要約（3行以内）

* EXISTS / NOT EXISTS は「行の存在判定」を行う述語。
* IN/NOT INよりNULLに強く、試験では誤解を狙われやすい。
* 用途は「注文した顧客」「注文がない顧客」の抽出に典型的。

---


## EXISTS は二つの表を比較する構文なのか？」「必ず相関サブクエリになるのか？」

## １　EXISTSの基本

* **定義**：EXISTS は「サブクエリの結果が1行以上存在するか」を判定する述語。
* **性質**：返すのは「真／偽」のみで、具体的な値は返さない。

---

## ２　二つの表を比較するのか？

* **はい、多くのケースで比較に使う**

  * 典型例：「顧客」表と「注文」表を比較し、関連する注文が存在するかを調べる。
  * このとき、外側の表（顧客）と内側の表（注文）の列を結びつける必要がある。

例：

```sql
SELECT 顧客名
FROM 顧客 C
WHERE EXISTS (
    SELECT *
    FROM 注文 O
    WHERE O.顧客ID = C.顧客ID
);
```

👉 このように **二つの表を比較して「存在するか」確認する使い方が一般的**。

---

## ３　必ず相関サブクエリになるのか？

* **必ずではない**。

  * 外側の表と関連付ける場合 → **相関サブクエリ** になる。
  * 単に「サブクエリの結果が空かどうか」を調べる場合 → **非相関サブクエリ** も書ける。

---

### 相関サブクエリの例（外側と比較あり）

```sql
SELECT 顧客名
FROM 顧客 C
WHERE EXISTS (
    SELECT *
    FROM 注文 O
    WHERE O.顧客ID = C.顧客ID
);
```
👉 顧客ごとに「対応する注文があるか」を調べるので相関する。

---

### 非相関サブクエリの例（比較なし）

```sql
SELECT '注文あり' AS 判定
WHERE EXISTS (
    SELECT *
    FROM 注文
);
```

👉 注文表に1件でも行があれば「注文あり」と1行出力。顧客表との比較はない。

---

## ４　まとめ

* **EXISTS = 「サブクエリに1行でもあるか」判定**
* **二つの表を比較するケースが典型的だが、それが必須ではない**
* **必ず相関サブクエリになるわけではない**

  * 表Aと表Bを比較 → 相関サブクエリ
  * 存在そのものを確認 → 非相関サブクエリ

---

👉 ご希望なら、次に **「JOINで書いた場合」と「EXISTSで書いた場合」の違い（性能・書き方・試験の狙いどころ）」** を比較表で整理しましょうか？
