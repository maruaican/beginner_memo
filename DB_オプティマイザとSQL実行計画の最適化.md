
# オプティマイザとSQL実行計画の最適化

## 1. はじめに：情報処理技術者試験問題

本ドキュメントは、データベースのパフォーマンスを理解する上で重要な「オプティマイザ」について、情報処理技術者試験の問題を題材に解説します。

**【出題元】**
*   令和3年春期 基本情報技術者試験 午後 問30
*   分野：テクノロジ系
*   中分類：データベース
*   小分類：トランザクション処理

**【問題】**
コストベースのオプティマイザがSQLの実行計画を作成する際に必要なものはどれか。

*   ア. ディメンジョンテーブル
*   イ. 統計情報
*   ウ. 待ちグラフ
*   エ. ログファイル

**【正解】**
*   **イ. 統計情報**

---

## 2. オプティマイザの概要

### 2.1. オプティマイザとは

**オプティマイザ (Optimizer)** とは、データベース管理システム(DBMS)が持つ機能の一つです。SQL文が実行された際に、そのSQLをどのように実行するか（**実行計画**）を決定し、対象となるレコードの取得時間を最小とするように**アクセスパスを最適化**します。

「最適化する(optimize)」という言葉がその名の由来です。

レコードを取得するためには、インデックスの使用やテーブル全体の読み込み（フルスキャン）など、複数の方法が考えられます。オプティマイザは、これらの方法を評価し、クエリ（問合せ）内容に応じて最も効率が良いと判断した実行計画を選択します。

### 2.2. オプティマイザの必要性

同じ内容のSQL文であっても、その実行方法によって処理時間は大きく変わります。例えば、大量のデータの中から特定のレコードを探す場合、「インデックスを使って高速に探す」か「テーブルを最初から最後まで全件スキャンする」かで、パフォーマンスに天と地ほどの差が生まれることがあります。

オプティマイザは、データベースに蓄積された情報を利用して「どの方法が最速か」を判断することで、処理が重くなることを回避し、データベース全体の性能を維持するという重要な役割を担っています。

---

## 3. オプティマイザの主要なアプローチ

アクセスパスを選択する基準には、主に「コストベースアプローチ」と「ルールベースアプローチ」の2種類が存在します。現代のDBMSではコストベースアプローチが主流となっています。

### 3.1. コストベースアプローチ (Cost-Based Approach)

テーブルやインデックスに関する**統計情報**（レコード件数、データの値の分布など）を基に、実行計画ごとの処理コスト（I/O回数やCPU使用量など）を推定し、最もコストが低いと判断された実行計画を選択する方式です。

実行計画の精度が高く、データの実態に合わせた最適なアクセスパスを選択しやすいため、現在の主流となっています。このアプローチにおいて、実行計画を得るために必須となるのが**統計情報**です。

### 3.2. ルールベースアプローチ (Rule-Based Approach)

統計情報を使わず、あらかじめ定められた優先順位などの固定的なルールに基づいて実行計画を決定する方式です。実行しようとするSQL構文と、テーブルやインデックスの定義情報をルールに当てはめてアクセスパスを決定します。

例えば、「インデックスが設定されていれば必ず使用する」といった単純なルールで動作します。そのため、必ずしも最適な実行計画が選択されるとは限らず、古い方式とされています。

### 3.3. アプローチの比較

| 方式 | 基準となる情報 | 特徴 |
| :--- | :--- | :--- |
| **コストベース** | **統計情報**（件数、分布など） | 現代の主流。データの実態に合わせて実行計画を最適化しやすい。 |
| **ルールベース** | **固定ルール**（アクセスパスの優先順位） | 単純で古い方式。必ずしも最適な実行計画とは限らない。 |

---

## 4. 問題の選択肢解説

### 4.1. 統計情報（正答）

コストベースオプティマイザが、各実行計画のコストを推定するために必須とする情報です。

### 4.2. ディメンジョンテーブル（誤答）

データウェアハウス（DWH）で用いられる、分析の切り口（次元）となる情報（例：時間、商品、地域など）を格納したテーブルです。SQLの実行計画の最適化とは直接関係ありません。

### 4.3. 待ちグラフ（誤答）

トランザクションの並行処理において、どのトランザクションがどのリソースの解放を待っているかという関係性をグラフで表現したものです。主に**デッドロック**の検出に使用される仕組みであり、SQLの実行計画の作成には用いられません。

### 4.4. ログファイル（誤答）

データベースへの更新履歴を時系列で記録するファイルです。主に障害発生時のデータ復旧（リカバリ）や障害対応に使用されるものであり、SQLの最適化には直接関係ありません。

---

## 5. 学習のポイントと補足知識

### 5.1. 試験における着眼点

*   **頻出領域**:
    SQLの実行計画、オプティマイザの仕組み、統計情報の役割に関する問題は頻出です。
*   **試験作成者の狙い**:
    この種の問題では、「コストベースオプティマイザには**統計情報が必要**である」という基本を理解しているかが問われます。その上で、「待ちグラフ（デッドロック検出）」や「ログファイル（障害復旧）」といった、データベースにおける別の重要概念と混同させていないかを確認する意図があります。

### 5.2. よくある誤解と正しい知識

*   **誤解**: 「インデックスさえ作成しておけば、十分に最適化されるはずだ」
    *   **正しい知識**: インデックスが存在しても、それを使う方がかえって非効率になる場合があります（例：検索対象のデータがテーブルの大半を占める場合）。オプティマイザはデータ量や値の分布といった**統計情報**がなければ、インデックスを使うべきか、それともフルテーブルスキャンをすべきかの最適な判断を下すことができません。

*   **誤解**: 「待ちグラフは、処理の"待ち"を解消するものだから実行計画に関係するはずだ」
    *   **正しい知識**: 待ちグラフは、SQLの実行計画そのものを最適化するものではありません。複数のトランザクションが互いにロックをかけ合い、身動きが取れなくなる**デッドロック**状態を検出するために使われる、並行処理制御の仕組みです。

---

## 6. 理解度チェック（一問一答）

**Q1. コストベースオプティマイザが実行計画を立てるために利用する最も重要な情報は何ですか？**
> **A1.** **統計情報**です。
> *解説：* レコード件数やデータの分布といった統計情報に基づき、処理コストを推定します。

**Q2. ルールベースオプティマイザはどのようにアクセスパスを決定しますか？**
> **A2.** あらかじめ定められた**固定的な優先順位**（ルール）でアクセスパスを決定します。
> *解説：* 統計情報を使わないため、精度はコストベースに劣ります。

**Q3. SQLの実行計画において「インデックスを利用するか、全件スキャンをするか」を決定するDBMSの機能は何ですか？**
> **A3.** **オプティマイザ**です。
> *解説：* 実行されるSQLを解析し、最も効率的なアクセス方法を選択します。

**Q4. デッドロックの検出に必要となる情報は何ですか？**
> **A4.** **待ちグラフ**です。
> *解説：* どのトランザクションがどのリソース（資源）を待っているかを表すことで、デッドロックを検出します。

**Q5. コストベース方式とルールベース方式の根本的な違いは何ですか？**
> **A5.** 前者が**統計情報**に依拠するのに対し、後者は**固定ルール**に依拠する点です。
> *解説：* この違いにより、現代のデータベースでは、より精度の高い最適化が可能なコストベース方式が主流となっています。

---

## 7. まとめ

*   コストベースオプティマイザは、**統計情報**を用いてSQL実行計画のコストを推定し、最も効率的なものを選択します。
*   待ちグラフやログファイルは、それぞれデッドロック検出や障害復旧といった別用途で使われるため、SQLの最適化には不要です。
*   現代の多くのデータベースでは、データの実態に即した最適化が可能な**コストベース方式が主流**となっています。