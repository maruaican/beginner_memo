## ルーターの最長一致の原則


---

### 平成27年秋期 問32

#### 【問題】

ルータがルーティングテーブルに①～④のエントリをもつとき，`10.1.1.250` 宛てのパケットをルーティングする場合に選択するエントリはどれか。ここで，ルータは最長一致検索及び可変長サブネットマスクをサポートしているものとする。

**▼ルーティングテーブル**

| エントリ | 宛先 | サブネットマスク | ネクストホップ |
|:---:|:---|:---|:---|
| ① | 10.0.0.0 | 255.0.0.0 | 192.168.2.1 |
| ② | 10.1.1.0 | 255.255.255.0 | 192.168.3.1 |
| ③ | 10.1.1.128 | 255.255.255.128 | 192.168.4.1 |
| ④ | 0.0.0.0 | 0.0.0.0 | 192.168.1.1 |

---

### 【総合解説】

#### 1. はじめに：ルータの経路選択プロセス

ルータは、ネットワークの「交通整理役」です。届いたパケットの宛先IPアドレスを見て、ルーティングテーブルという地図の中から最適な経路を判断し、次のルータ（ネクストホップ）にパケットを転送します。

最適な経路を選ぶためには、以下の**優先順位**で判断が行われます。

1.  **最長一致（ロンゲストマッチ）**：最も具体的で詳細な経路を最優先する。
2.  **アドミニストレーティブディスタンス（AD値）**：経路情報の信頼度で判断する。
3.  **メトリック**：宛先までのコスト（距離や速度など）で判断する。

今回の問題は、この最初のステップである「**最長一致**」の原則に関するものです。

#### 2. 最重要原則：ロンゲストマッチ（最長一致）とは？

ロンゲストマッチとは、**「宛先IPアドレスが複数の経路に合致する場合、サブネットマスクのネットワーク部が最も長い（＝最も宛先を具体的に示している）経路を優先する」**というルールです。

##### なぜこの原則が必要か？

ネットワークはしばしば、大きなネットワークの中に小さなネットワークが含まれる階層構造になっています。この構造を効率的に管理するために、ロンゲストマッチは不可欠です。

これを**住所**に例えてみましょう。

*   **① `10.0.0.0/8`**: 「**日本**」宛ての荷物はこちら
*   **② `10.1.1.0/24`**: 「**東京都**」宛ての荷物はこちら
*   **③ `10.1.1.128/25`**: 「**東京都千代田区**」宛ての荷物はこちら
*   **④ `0.0.0.0/0`**: 上記以外の「**外国**」宛ての荷物はこちら（デフォルトルート）

もし宛先が「東京都千代田区」なら、「日本」や「東京都」という案内も間違いではありません。しかし、最も正確で迷わない案内は「東京都千代田区」です。ルータも同様に、**最も具体的で詳細な情報（＝ネットワーク部が長い）を最優先**します。

#### 3. 問題の具体的な解析ステップ

##### ステップ1：ルーティングテーブルをCIDR表記で理解する

まず、サブネットマスクをプレフィックス長（CIDR表記）に変換すると、各エントリが示すネットワークの範囲が分かりやすくなります。

| エントリ | 宛先 | サブネットマスク | プレフィックス長 |
|:---:|:---|:---|:---:|
| ① | 10.0.0.0 | 255.0.0.0 | **/8** |
| ② | 10.1.1.0 | 255.255.255.0 | **/24** |
| ③ | 10.1.1.128 | 255.255.255.128 | **/25** |
| ④ | 0.0.0.0 | 0.0.0.0 | **/0** |

##### ステップ2：宛先IPアドレス `10.1.1.250` が各エントリに合致するか確認する

| エントリ | ネットワーク範囲 | `10.1.1.250`に合致するか？ | 理由 |
|:---:|:---|:---:|:---|
| ① (/8) | `10.0.0.0` ～ `10.255.255.255` | **合致する** | 最初の8ビット（`10`）が一致します。 |
| ② (/24) | `10.1.1.0` ～ `10.1.1.255` | **合致する** | 最初の24ビット（`10.1.1`）が一致します。 |
| ③ (/25) | `10.1.1.128` ～ `10.1.1.255` | **合致する** | 宛先IPがこの範囲内に含まれます。 |
| ④ (/0) | すべてのIPアドレス | **合致する** | これは**デフォルトルート**と呼ばれ、他に適切な経路がない場合の最終手段です。 |

##### ステップ3：ロンゲストマッチの原則を適用する

`10.1.1.250` は、①, ②, ③, ④のすべてのエントリに合致しました。ここでロンゲストマッチの原則を適用し、プレフィックス長が**最も長い（数字が大きい）**ものを選択します。

*   エントリ①: `/8`
*   エントリ②: `/24`
*   エントリ③: `/25`
*   エントリ④: `/0`

比較すると、**`/25`** が最も長いため、ルータは **エントリ③** を選択します。

#### 4. 結論

したがって、`10.1.1.250` 宛てのパケットは、**エントリ③** の経路情報に基づき、ネクストホップ `192.168.4.1` へ転送されます。

---

#### 【補足知識】もしロンゲストマッチで決まらない場合は？

今回の問題ではロンゲストマッチだけで答えが決まりましたが、実務ではさらに複雑なケースがあります。

*   **アドミニストレーティブディスタンス (AD値)**
    もし、**全く同じプレフィックス長**の経路（例：`10.1.1.0/24`が複数）を異なるルーティングプロトコル（OSPFやEIGRPなど）から学習した場合、ルータは**AD値**という「情報の信頼度」を示す数値で判断します。この値が**小さいほど信頼性が高い**とされ、優先されます。

*   **メトリック**
    もし、AD値まで同じだった場合（例：同じOSPFから同じプレフィックス長の経路を複数学習した場合）、最後に**メトリック**で判断します。メトリックは宛先までの「コスト」を示す値で、ホップ数や回線速度などを基に計算されます。この値が**小さいほど最適な経路**と判断されます。