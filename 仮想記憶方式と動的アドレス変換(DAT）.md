この資料は、仮想記憶方式における論理アドレスから物理アドレスへの変換に関する情報が重複して記載されているため、以下の通り体系的に整理します。要約は行わず、記載された情報を網羅します。

---

## １．仮想記憶方式の概要

### １－１．定義と用語の由来

*   **仮想記憶方式**：補助記憶（HDD/SSD）の一部を主記憶のように見せかけ、プログラムが大きな連続したアドレス空間を利用できる方式。
*   **論理アドレス**（仮想アドレス）：CPUが命令で指定するアドレス。プログラムが命令中で使用するアドレスであり、プログラムは「連続した大きなメモリがある」と思い込める。
*   **物理アドレス**：実際の主記憶（RAM）の番地。主記憶は断片化しており、プログラムから見て連続しているとは限らない。
*   **動的アドレス変換(DAT: Dynamic Address Translation)**：ハードウェアで論理アドレスを物理アドレスに変換する機構。

### １－２．技術の必要性（解決する具体的課題）

仮想記憶方式は、以下の課題を解決するために必要とされます。
*   **主記憶の小ささ**：主記憶が小さいため、プログラム全体を一度に主記憶に載せられない。
*   **メモリの断片化**：プログラムは連続したアドレス空間を要求するが、実際の主記憶は断片化していると、連続領域の確保が難しい。

**解決策**：
論理アドレスを物理アドレスに動的に変換し、プログラムの一部だけを主記憶にロードすることで、プログラムには「仮想的に大きく連続したメモリ」を見せかけ、実際にはページ単位でバラバラの主記憶に割り当てることが可能になる。

### １－３．全体像（図解イメージ）

仮想記憶方式におけるアドレス変換の全体像は以下の通りです。

```
[CPU（プログラム命令）]
   ↓ 論理アドレス（仮想アドレス）
[動的アドレス変換(DAT)＋ページテーブル]ー**ハードウェア（DAT）**
   ↓ 【変換】
[主記憶（物理アドレス）]
   ↓ 読み書き
[補助記憶（ページイン／ページアウト）]ーー**OS**
```

また、変換の流れは以下のようにも表せます。

```
CPU（プログラム命令）
   ↓ 論理アドレス（仮想アドレス）
[ 動的アドレス変換(DAT) ＋ ページテーブル ]
   ↓ 物理アドレス
主記憶（実際のRAM上の番地）
```

---

## ２．論理アドレスと物理アドレスの変換

### ２－１．動的アドレス変換(DAT)

*   **役割**：論理アドレスを物理アドレスに変換する処理を担うハードウェア機構です。
*   **処理主体**：アドレス変換はDATという**ハードウェア**によって行われます。

### ２－２．変換のタイミング

*   **変換の発生タイミング**：CPUが主記憶を参照するたびに、必ずアドレス変換が行われます。
*   **誤解を招くポイント**：
    *   「ページフォールト時」や「ページイン・ページアウト時」に変換が行われると誤解されがちです。
    *   実際は、**CPUが主記憶を参照するたびに必ず変換する**。

### ２－３．変換の仕組み

アドレス変換は、論理アドレスを「ページ番号」と「ページ内オフセット」に分け、ページテーブルを使って物理アドレスに置き換える処理です。

*   **論理アドレスの構成**：
    ```
    論理アドレス（仮想アドレス）
     ┌───────────────┐
     │ ページ番号 │ ページ内オフセット │
     └───────────────┘
       ↑ページを探す    ↑ページ内のどこか
    ```
*   **ページテーブルの役割**：ページ番号をキーとして、対応する物理フレーム番号（主記憶上の位置）を取得します。
*   **変換の式**：
    ```
    物理アドレス = ページフレーム番号（主記憶上の位置）＋ページ内オフセット
    ```

*   **変換の具体例**：
    *   **前提**：ページサイズ：4KB (4096バイト)、論理アドレス空間：16KB (ページ番号 0～3)、主記憶：8KBしかなく、空きフレームが2つ。
    *   **手順**：
        1.  論理アドレス `5000` を参照したとする。
        2.  `5000 ÷ 4096 = 1 あまり 904` を計算する。
        3.  → ページ番号 = `1`、ページ内オフセット = `904` となる。
        4.  ページテーブルで「ページ番号1」を探す（例：ページ1 → 主記憶のフレーム3に載っている）。
        5.  物理アドレスを組み立てる（例：フレーム3の先頭アドレス + 904 = **物理アドレスXXXX**）。
        つまり、「論理アドレス5000」は「ページ1の先頭から904バイト目」を指します。

---

## ３．ページ番号とページ内オフセットの詳細

### ３－１．定義と用語の由来

*   **ページ番号 (Page number)**：仮想アドレスが属する「ページ」を示す番号です。大きなアドレス空間をページ単位で分割して管理するために用いられます。
*   **ページ内オフセット (Page offset)**：そのページの先頭から「何バイト目か」を表す位置情報です。ページの中の正確な場所を特定するために用いられます。
*   **由来**：*offset* は「ずれ」「差」を意味する英単語であり、ページの先頭アドレスからの差分であるため「オフセット」と呼ばれます。

### ３－２．構成（図解イメージ）

論理アドレスはページ番号とページ内オフセットに分割されます。

```
論理アドレス（仮想アドレス）
 ┌───────────────┐
 │ ページ番号 │ ページ内オフセット │
 └───────────────┘
   ↑ページを探す    ↑ページ内のどこか
```

### ３－３．計算例

*   **Q**：ページサイズ 1KB、論理アドレス = 2500 の場合、ページ番号とオフセットは？
    *   `2500 ÷ 1024 = 2 あまり 452`
    *   **ページ番号 = 2**
    *   **ページ内オフセット = 452**

*   **Q**：ページサイズ 4KB (4096バイト)、論理アドレス = 5000 の場合、ページ番号とオフセットは？
    *   `5000 ÷ 4096 = 1 あまり 904`
    *   **ページ番号 = 1**
    *   **ページ内オフセット = 904**

---

## ４．ページテーブル

### ４－１．役割と構造（図解イメージ）

ページテーブルは「ページ番号 → 物理フレーム番号」の対応付けを行う表です。

```
論理アドレス（仮想アドレス）
   ┌───────────────┐
   │ ページ番号 │ ページ内オフセット │
   └───────────────┘
        │
        ▼ ページ番号をキーに検索
   ┌───────────────────┐
   │ ページテーブル（対応表）│
   │───────────────────│
   │ ページ0 → フレーム2 │
   │ ページ1 → フレーム5 │
   │ ページ2 → 未ロード × │ ← ページフォールト発生
   │ ページ3 → フレーム7 │
   └───────────────────┘
        │
        ▼
   ┌──────────────────────┐
   │ 主記憶（物理メモリのフレーム群） │
   │──────────────────────│
   │ フレーム2 │ フレーム5 │ フレーム7 │ ... │
   └──────────────────────┘
        │
        ▼
   「フレーム番号 + ページ内オフセット」＝物理アドレス
```

**図の流れ**：
1.  CPUが論理アドレス（例：ページ番号 = 1、オフセット = 904）を出す。
2.  ページテーブルを見て、ページ1がフレーム5にあると分かる。
3.  物理アドレスは「フレーム5の先頭アドレス」＋「オフセット904」として組み立てられる。
4.  もしページ2をアクセスしようとしても「未ロード」の場合、ページフォールトが発生する。

---

## ５．ページフォールト

### ５－１．定義と発生条件

*   **ページフォールト**：アドレス変換の結果、必要なページが主記憶上に存在しない（ページテーブルに「未ロード」と示されている）場合に発生します。
*   **発生時**：ページテーブルに目的のページが載っていなかった場合に発生します。

### ５－２．処理主体

*   ページフォールト発生時の処理は、**OS**が担当します。OSは補助記憶からそのページを主記憶に持ってきて（ページイン）、再度アドレス変換を行います。
*   ページイン／ページアウト処理もOSが担当します。

### ５－３．アドレス変換との関係

*   **アドレス変換**は、CPUが主記憶をアクセスするたびに**毎回必ず実行**されます。
*   **ページフォールト**は、その**変換に失敗した時の特別処理**（OSが動く）であり、変換処理そのものではありません。
*   変換に失敗した結果としてOS処理に移行します。

### ５－４．よくある誤解と正しい知識

*   ❌ **誤解**：ページフォールト＝アドレス変換のトリガー
*   ✅ **正解**：アドレス**変換**は**アクセスごと**に行われ、ページフォールトは「変換に失敗した結果」です。
*   **再現防止のポイント**：「**変換はCPUのハードウェア、ページイン／アウトはOS**」と役割を分けて覚えることが推奨されます。

---

## ６．試験対策

### ６－１．試験の着眼点（誤答を狙うポイント）

応用情報技術者試験などの問題で、試験作成者は以下のような誤解を狙うことがあります。
*   「ページフォールト時」や「ページイン・ページアウト時」に変換が行われると誤解させる選択肢。
*   実際は、**CPUが主記憶を参照するたびに必ず変換する**という点を理解しているかが問われます。

**必要知識**：
*   論理アドレス → ページ番号＋ページ内オフセット
*   ページテーブル参照で物理フレーム番号を取得
*   変換は毎回発生

### ６－２．体系マップ（分類・関係・比較表）

| 状況               | アドレス変換は？             | 補足                   |
| :----------------- | :--------------------------- | :--------------------- |
| 主記憶に存在するページをアクセス | **行う**                   | 正解（CPUアクセスごとにDATが実行） |
| ページフォールト発生時      | 行わない（むしろ失敗してOS処理に移行） | ページの有無を確認する段階        |
| ページイン時           | 行わない                 | OSがページをロードするだけ       |
| ページアウト時          | 行わない                 | OSがページを退避するだけ        |

### ６－３．代表例（正答例・誤答例）

*   **正答例**：「主記憶に存在するページをアクセスするとき」
*   **誤答例**：「ページフォールトが発生したとき」
    *   → 実際にはアドレス変換は行われず、OSが補助記憶から読み込む処理になります。

### ６－４．一問一答（5問）

**Q1.** 論理アドレスを「ページ番号＋ページ内オフセット」に分けるのはなぜか？
*   **A**：ページ単位で管理し、ページ番号で主記憶上の位置を特定するため。

**Q2.** アドレス変換を担うハードウェア機構の名前は？
*   **A**：動的アドレス変換機構（DAT）。

**Q3.** ページフォールト時に処理を行うのはCPUかOSか？
*   **A**：OS。ページアウト／イン処理はOSが担当する。

**Q4.** アドレス変換が行われるタイミングはいつ？
*   **A**：CPUが主記憶を参照するたび。

**Q5.** ページフォールトはアドレス変換が成功か失敗か？
*   **A**：失敗。必要なページが主記憶にないため。