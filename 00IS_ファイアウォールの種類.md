
---

# ファイアウォールの体系的解説

## 1. ファイアウォールとは

### 1.1. 定義と役割
ファイアウォールとは、内部ネットワークと外部ネットワークとの間に設置され、あらかじめ定義されたルールに基づき、不要な通信を遮断する仕組みです。インターネットから内部システムへの不正アクセスを防いだり、不要なポートへの通信を制御してマルウェアの拡散を防止したりする役割を担います。

### 1.2. 用語の由来
ファイアウォール（Firewall）という言葉は、火災の延焼を防ぐ「**防火壁**」が語源です。ネットワークにおける脅威が内部に侵入・拡散するのを防ぐ壁としての役割を示しています。

## 2. ファイアウォールの分類と全体像

ファイアウォールは、OSI参照モデルの「**どの層の情報を見て通信を判断するか**」によって、いくつかの種類に分類されます。階層が上がるほど、より詳細な情報（通信の中身）を検査できますが、その分処理の負荷は高くなる傾向があります。

### 2.1. 分類の全体像（テキスト図）
```
ファイアウォールの分類
 ├─ パケットフィルタリング型（ネットワーク層/トランスポート層）
 │     └─ IPアドレス／ポート番号／プロトコルで判定
 ├─ サーキットレベルゲートウェイ型（トランスポート層）
 │     └─ TCPコネクションの確立可否で判定
 ├─ ステートフルインスペクション型（ネットワーク層～トランスポート層 + 状態）
 │     └─ 通信の状態（セッション情報）を保持して判定
 ├─ アプリケーションゲートウェイ型（アプリケーション層, Proxy型）
 │     └─ HTTP, FTP などアプリケーションレベルで検査
 └─ WAF（Web Application Firewall）（アプリケーション層特化）
       └─ Webアプリのリクエスト内容（SQLインジェクション等）を検査
```

### 2.2. 具体的なイメージ
ファイアウォールの各種類を、建物への入館管理に例えると、以下のようにイメージできます。

*   **パケットフィルタリング型：門番**
    *   通行人の「顔写真（IPアドレス）」と「通行証番号（ポート番号）」だけを見て、通すか止めるかを機械的に判断します。
*   **ステートフルインスペクション型：門番＋出入り記録簿**
    *   門番の機能に加え、「この人はさっき入館したから、今出ていくのは妥当だ」といったように、出入りの記録（通信の文脈）を照合して判断します。
*   **アプリケーションゲートウェイ型：代行受付窓口**
    *   来訪者（外部からの通信）を目的の相手（サーバ）に直接会わせず、受付担当者（プロキシ）が代理で用件を聞き、内容を精査・翻訳してから相手に伝えます。
*   **WAF（Web Application Firewall）：申請書の内容チェック担当**
    *   入館申請書（Webリクエスト）に「`DROP TABLE 社員;`」のような危険な記述がないか、その中身を一行一行細かく審査します。

## 3. 各ファイアウォールの詳細

### 3.1. パケットフィルタリング型
*   **動作する層**: ネットワーク層 (L3) / トランスポート層 (L4)
*   **監視・判定する情報**:
    *   送信元/宛先の**IPアドレス**
    *   送信元/宛先の**ポート番号**
    *   **プロトコル**の種類（TCP, UDP, ICMPなど）
*   **仕組みと特徴**: パケットのヘッダ情報のみを「ふるいにかける（filter）」ように見て、ルールに合致しない通信を単純に通過または破棄します。処理が軽量で高速ですが、通信の中身までは検査しないため、柔軟性やセキュリティレベルは限定的です。
*   **解決する課題**: 外部から無制限に全ポートへアクセスされる危険に対し、不要なポート（例: データベース用のポート）を閉じ、必要なポート（例: Web閲覧用の80番ポート）だけを許可する、といった基本的なアクセス制御を行います。

### 3.2. サーキットレベルゲートウェイ型
*   **動作する層**: トランスポート層 (L4)
*   **監視・判定する情報**: TCPハンドシェイクなどのコネクション確立要求
*   **仕組みと特徴**: アプリケーションのデータ内容には関与せず、TCPコネクションの確立を代理で行います。接続が許可されると、あとはパケットを透過させるため、比較的高速に動作します。
*   **解決する課題**: アプリケーションのデータ内容を検査することなく、正規のTCPコネクション確立手順に基づいているか否かで通信を制御します。

### 3.3. ステートフルインスペクション型
*   **動作する層**: ネットワーク層 (L3) / トランスポート層 (L4) ＋ セッションの状態
*   **監視・判定する情報**: パケットフィルタリング型の情報に加え、過去の通信履歴（**セッション状態情報**）
*   **仕組みと特徴**: 「State（状態）」を「Inspection（検査）」することからこの名がついています。過去の通信を記録・追跡し、その文脈に沿った通信であるかを判断します。例えば、「内部から外部へのリクエストに対する応答パケット」は許可し、「リクエストがないのに外部から一方的に送られてきた応答パケット」は不正と見なして破棄します。
*   **解決する課題**: 通信の前後関係を記憶しているため、送信元を偽装した不正な応答パケットなどを防ぐことができます。パケットフィルタリング型の高速性と、より高度なセキュリティを両立させた、バランスの取れた方式です。

### 3.4. アプリケーションゲートウェイ型（プロキシ型）
*   **動作する層**: アプリケーション層 (L7)
*   **監視・判定する情報**: HTTP, FTPなどの各アプリケーションプロトコルのコマンドやデータ
*   **仕組みと特徴**: 利用者の代わりに通信を行う「代理（Proxy）」として動作します。通信を一度終端させ、内容を詳細に解析した上で、問題がなければ代理としてサーバとの通信を再確立します。この仕組みから**プロキシ型ファイアウォール**とも呼ばれます。
*   **解決する課題**: HTTPのメソッド（GETは許可、POSTは禁止）やFTPのコマンド（GETは許可、PUTは禁止）など、アプリケーションの動作レベルで非常にきめ細かい制御が可能です。

### 3.5. WAF (Web Application Firewall)
*   **動作する層**: アプリケーション層 (L7) ※Webアプリケーションに特化
*   **監視・判定する情報**:
    *   URLのパラメータ
    *   POSTデータの内容
    *   HTTPヘッダの詳細
*   **仕組みと特徴**: Webアプリケーションの脆弱性を狙った攻撃に特化した防御装置です。HTTPリクエストの内容を詳細に検査し、**SQLインジェクション**や**クロスサイトスクリプティング（XSS）**といった、通常のファイアウォールでは検知できない攻撃パターンを検出・遮断します。
*   **解決する課題**: 「社員テーブルを削除するようなSQL文がリクエストに含まれていないか」といった、アプリケーションのデータ内容にまで踏み込んだチェックを行い、Webサイトを保護します。

## 4. ファイアウォールの種類別比較

| 種類 | 監視・判定する情報 | 動作層 | 特徴 |
| :--- | :--- | :--- | :--- |
| **パケットフィルタリング型** | IPアドレス, ポート番号, プロトコル | L3, L4 | 軽量・高速だが、通信の中身は見ないため柔軟性に欠ける。 |
| **サーキットレベルゲートウェイ型** | TCPハンドシェイク情報 | L4 | 接続確立の可否を制御する。データの中身は見ない。 |
| **ステートフルインスペクション型** | パケット情報＋セッション状態 | L3, L4 | 通信の文脈を理解し、安全性と性能のバランスが良い。 |
| **アプリケーションゲートウェイ型** | HTTP/FTP等のアプリケーションデータ | L7 | アプリケーションのコマンドレベルで詳細な制御が可能だが、処理が重い。 |
| **WAF** | POSTデータ, URLパラメータ, SQL文など | L7 | Webアプリケーションへの攻撃防御に特化している。 |

## 5. 試験対策：頻出論点とよくある誤解

資格試験などでは、各ファイアウォールが「どの層の情報を見ているか」という違いを突いた問題が頻出します。

### 5.1. 最重要知識：監視対象と層の対応
*   **パケットフィルタリング型**: IPアドレス、ポート番号（L3/L4ヘッダ）
*   **ステートフルインスペクション型**: 上記＋セッション情報
*   **アプリケーションゲートウェイ型**: HTTPリクエストなど（L7データ）
*   **WAF**: POSTデータ、URLパラメータなど（L7データの中身）

### 5.2. よくある誤解と正しい知識（ひっかけパターン）

**誤解①：パケットフィルタリング型がURLやPOSTデータ（Webの中身）を監視できる。**
*   **❌間違い**: パケットフィルタリング型が見るのはパケットのヘッダ情報（IPアドレスやポート番号）のみです。
*   **✔️正しい知識**: URLやPOSTデータといったアプリケーション層のデータを監視できるのは、**アプリケーションゲートウェイ型**や**WAF**です。
    *   **正答例**: 「送信元と宛先のIPアドレスとポート番号で通信を制御する」→ パケットフィルタリング型
    *   **誤答例**: 「Webアプリケーションに渡されるPOSTデータを検査する」→ WAFの機能
    *   **誤答例**: 「利用者のPCから送信されたURLを基にアクセスを制御する」→ アプリケーションゲートウェイ型 or WAFの機能

**誤解②：ファイアウォールはMACアドレスで通信を制御できる。**
*   **❌間違い**: MACアドレスはデータリンク層（L2）の情報です。
*   **✔️正しい知識**: ファイアウォールは基本的にネットワーク層（L3）以上の情報を扱います。MACアドレスによるフィルタリングは、L2スイッチや無線LANアクセスポイントの機能です。
    *   **誤答例**: 「送信元のMACアドレスを基に通信を遮断する」→ ファイアウォールの基本的な判定対象外

**誤解③：ファイアウォールとWAFは同じもの、またはどちらかがあれば十分。**
*   **❌間違い**: 両者は防御する層と対象が異なります。
*   **✔️正しい知識**: ファイアウォールがネットワーク全体をポート単位で守るのに対し、WAFはWebアプリケーションを不正なデータ送信から守るための専用防御装置です。多くの場合、両者は併用されます。

## 6. 知識の確認（一問一答）

**Q1. パケットフィルタリング型ファイアウォールが参照する主要な情報は何ですか？**
**A1.** 送信元/宛先のIPアドレス、ポート番号、プロトコルです。
*   **解説**: L3/L4のヘッダ情報を参照するのが最大の特徴です。例えば、「TCP 25番ポート（メール送信/SMTP）への通信を禁止する」といった制御が可能です。

**Q2. アプリケーションゲートウェイ型ファイアウォールの別名は何ですか？**
**A2.** プロキシ型ファイアウォールです。
*   **解説**: 利用者の通信を「代理（proxy）」して、一度通信を終端させ、内容を解析してから再接続するため、このように呼ばれます。

**Q3. ステートフルインスペクション型の強みは何ですか？**
**A3.** 過去の通信の状態（セッション）を追跡することで、正規の応答パケットか、偽装された不正なパケットかを見分けられる点です。安全性と高速性のバランスが取れています。
*   **解説**: 例えば、内部からのリクエストがないにも関わらず、外部から一方的に送られてくる応答パケットを破棄できます。

**Q4. Webアプリケーションに渡されるPOSTデータの中身を監視し、SQLインジェクション攻撃を防ぐ役割を持つのは何ですか？**
**A4.** WAF（Web Application Firewall）です。
*   **解説**: WAFは、HTTPリクエストに含まれる「社員情報を削除するSQL文」のような、アプリケーション層の攻撃を検出することに特化しています。

**Q5. サーキットレベルゲートウェイ型が主に制御するものは何ですか？**
**A5.** TCPコネクションの確立の可否です。
*   **解説**: アプリケーションのデータ内容自体は見ませんが、通信の「セッション確立」そのものを制御します。