# 同一オリジンポリシー（Same-Origin Policy, SOP）

同一オリジンポリシー（Same-Origin Policy, SOP）は、Webブラウザが異なる「オリジン」間でのアクセスを制限する、**ブラウザ側で強制されるセキュリティモデル**です。悪意あるWebサイトが、ユーザーがログインしている他のサイトの機密情報にアクセスしたり、不正な操作を行ったりするのを防ぐ目的で導入されました。

## 1. オリジン（Origin）の定義

オリジンは、以下の3つの要素全てが一致する場合に「同一」と判断されます。

*   **スキーム (Protocol)**: `http`, `https`, `file` など
*   **ホスト名 (Host)**: `example.com`, `sub.example.com` など
*   **ポート番号 (Port)**: `80` (HTTPのデフォルト), `443` (HTTPSのデフォルト), `8080` など

**例:**
*   `https://example.com:443` と `https://example.com` は同一オリジン（デフォルトポートが省略されているため）
*   `https://example.com` と `http://example.com` は異なるオリジン（スキームが異なるため）
*   `https://www.example.com` と `https://example.com` は異なるオリジン（ホスト名が異なるため）

## 2. SOPが制限するアクセス（SOP単独で防御するリスク）

SOPは、異なるオリジンからの以下のリソースへの直接的なアクセスを制限します。これにより、クロスオリジンからの情報窃取を防ぎます。

### 2.1. JavaScriptによるDocument Object Model (DOM) アクセス

*   **制限内容**: 異なるオリジンから読み込まれた `<iframe>` などの文書オブジェクトモデル（DOM）の内容に、JavaScriptから直接アクセスすることを禁止します。
*   **防御するリスク**:
    *   **クロスオリジンDOM読み取り**: 悪意あるサイトが、ユーザーがログイン中の別サイト（iframe内）のフォーム入力内容や文書情報をJavaScriptで盗む攻撃を防ぎます。

### 2.2. ストレージ（Cookie, LocalStorage, SessionStorage, IndexedDB）へのアクセス

*   **制限内容**: Cookie、LocalStorage、SessionStorage、IndexedDB など、ブラウザが保持するクライアントサイドのデータは、同一オリジンからのみ読み書きが可能です。
*   **防御するリスク**:
    *   **クロスオリジンCookie/Storage窃取**: 他サイトのCookie（セッションIDなど）やLocalStorageに格納された機密情報を、JavaScriptで直接読み取る攻撃を防ぎます。
*   
### 2.3. XMLHttpRequest / fetch（AJAX通信）のレスポンス読み取り

*   **制限内容**: JavaScriptによる XMLHttpRequest や Fetch API を用いた異なるオリジンへの通信は可能ですが、セキュリティ上の理由から、その**レスポンス内容をJavaScriptから読み取ることをデフォルトで禁止**します。
*   **防御するリスク**:
    *   **クロスオリジンAJAXレスポンス窃取**: 他サイトのAPIやページのレスポンス内容をJavaScriptで読み取り、機密データを盗む攻撃を防ぎます。

### 2.4. Canvasピクセルデータの取得

*   **制限内容**: 異なるオリジンから読み込んだ画像や動画を `<canvas>` 要素に描画した場合、そのCanvasは「汚染された（tainted）」状態となり、JavaScriptからそのピクセルデータを取得する `getImageData()` などの操作が禁止されます。
*   **防御するリスク**:
    *   **Canvasピクセル窃取**: 他サイトの画像や動画に含まれる情報を、Canvasを通じて間接的に窃取する攻撃を防ぎます。

## 3. SOPが制限しないアクセス（読み込みは可能だが直接参照は制限）

SOPは、セキュリティリスクが低いと判断される一部のクロスオリジンリソースの読み込み自体は許可しています。しかし、その内容への直接的なJavaScriptからのアクセスは引き続き制限されます。

*   **埋め込みコンテンツの読み込み**:
    *   `<img>`, `<script>`, `<link rel="stylesheet">`, `<video>`, `<audio>` タグなどを使って、異なるオリジンにある画像、JavaScriptファイル、CSSファイル、メディアファイルなどを読み込むことは可能です（CDNからの読み込みなど）。
    *   ただし、読み込んだ画像ピクセルやCSSの中身、スクリプトが持つ内部変数などへのJavaScriptによる直接的なアクセスは、上記の「SOPが制限するアクセス」のルールに基づいて制限されます。
*   **ナビゲーション**:
    *   `window.location` による異なるオリジンへのページ遷移は可能です。
*   **フォーム送信**:
    *   `<form action="...">` を使って異なるオリジンへデータをPOST送信することは可能です。
    *   ただし、送信後のレスポンスDOMをJavaScriptで読み取ることはSOPによって制限されます。

## 4. SOP＋追加対策が必要なリスク（SOPだけでは不十分なケース）

SOPは「読み取り」や「共有」を厳しく制限しますが、以下のリスクに対しては単独では不十分であり、他のセキュリティ対策と組み合わせることで防御力を高める必要があります。

### 4.1. CSRF（Cross-Site Request Forgery: クロスサイトリクエストフォージェリ）

*   **内容**: ユーザーが認証済みのサイトに対し、悪意あるサイトから意図しないリクエスト（データの更新、削除など）を強制的に送信させる攻撃。SOPは異なるオリジンへのリクエスト送信自体は許可するため、Cookieが自動的に添付されてしまう点に脆弱性があります。
*   **追加対策**:
    *   **CSRFトークンの導入**: リクエストごとにサーバーでランダムなトークンを生成し、フォームなどに埋め込んで検証します。
    *   **SameSite Cookie属性**: Cookieの送信を同一サイトからのリクエストに限定します。
    *   Referer/Originヘッダの検証、重要な操作時の再認証など。

### 4.2. クリックジャッキング（Clickjacking）

*   **内容**: 透明な `<iframe>` などを使って、ユーザーが別のWebページの要素（ボタン、リンクなど）を意図せずクリックするように誘導する攻撃。SOPは `<iframe>` の埋め込み自体は制限しないため、このような攻撃が可能になります。
*   **追加対策**:
    *   **X-Frame-Options レスポンスヘッダ**: `DENY` や `SAMEORIGIN` を設定して、フレーム内でのページ表示を制御します。
    *   **Content Security Policy (CSP) の `frame-ancestors` ディレクティブ**: `<iframe>` の埋め込み元を制限します。
    *   JavaScriptによるフレームバンスティング（古い手法）。

### 4.3. XSS（Cross-Site Scripting）

*   **内容**: ウェブサイトに悪意あるスクリプトを注入し、そのスクリプトをユーザーのブラウザ上で実行させる攻撃。注入されたスクリプトは、**同一オリジンのWebサイトの権限で動作する**ため、SOPの制限を受けることなく、Cookieの窃取（`HttpOnly`がない場合）、DOM操作、ユーザー情報の読み取りなどが可能です。
*   **追加対策**:
    *   **入力値の適切なエスケープ処理**: ユーザー入力やデータベースからの出力内容を、表示するコンテキスト（HTML、JavaScript、URLなど）に応じて適切にエスケープします。
    *   **Content Security Policy (CSP)**: 実行可能なスクリプトのソースやインラインスクリプトの使用を制限します。
    *   **`HttpOnly`属性**: CookieをJavaScriptから参照できなくすることで、XSSによるCookie窃取を防止します。

### 4.4. クロスオリジンAPI連携の安全化（CORS: Cross-Origin Resource Sharing）

*   **内容**: SOPは異なるオリジンからのAJAXレスポンス読み取りを禁止しますが、正当な理由でクロスオリジン間でのリソース共有が必要な場合があります（例: 異なるドメインのAPI呼び出し）。CORS設定が不適切だと、セキュリティリスクが生じます。
*   **目的**: ウェブアプリケーションが、特定の異なるオリジンからのリソースロードを許可するための仕組みです。サーバーが `Access-Control-Allow-Origin` などのHTTPヘッダを返すことで、ブラウザがクロスオリジンアクセスを許可するようになります。
*   **誤設定リスク**:
    *   `Access-Control-Allow-Origin: *` と `Access-Control-Allow-Credentials: true` の同時使用は、認証情報（Cookieなど）を伴うクロスオリジンリクエストをあらゆるオリジンに許可してしまうため、非常に危険です。
    *   過剰な `Access-Control-Allow-Headers` や `Access-Control-Allow-Methods` の設定もリスクを高めます。

## 5. SOPでは直接保護されないリスク（ブラウザの範囲外の脅威）

SOPはWebブラウザのセキュリティモデルであり、ネットワーク層やサーバーサイド、OS、ユーザーの行動に関わるリスクには直接的な保護を提供しません。

*   **通信盗聴・改ざん（Man-in-the-Middle攻撃など）**:
    *   ネットワーク層でのデータの盗聴や改ざんはSOPの対象外です。HTTP通信などが対象になります。
    *   **対策**: TLS (HTTPS) による通信暗号化、HSTS (HTTP Strict Transport Security)、証明書ピンニングなど。
*   **サーバーサイド脆弱性の悪用（SQLインジェクション、OSコマンドインジェクション、RCEなど）**:
    *   サーバー側のアプリケーションやデータベースの脆弱性はSOPでは防げません。
    *   **対策**: 入力値検証、プレースホルダ利用、最小権限の原則、WAF (Web Application Firewall) など。
*   **フィッシング詐欺**:
    *   ユーザーを偽のWebサイトに誘導し、個人情報や認証情報を詐取する攻撃はSOPでは防げません。
    *   **対策**: DMARC/SPF/DKIMなどのメール認証、URLの確認、セキュリティ教育など。
*   **マルウェア感染**:
    *   ユーザーのOSやブラウザ以外のアプリケーションに対するマルウェア攻撃はSOPの範囲外です。

## 6. DOM（Document Object Model）の解説とSOPとの関係

### 6.1. DOMとは

DOM（Document Object Model）は、HTMLやXML文書をプログラムから操作するための標準的なインターフェース（API仕様）です。ウェブページの内容、構造、スタイルをJavaScriptなどのスクリプト言語から参照・変更できるように、文書を「オブジェクトのツリー構造」として表現します。DOMは、ブラウザがHTMLを解析して生成するもので、開発者はこのDOMツリーを通じてウェブページと対話します。

*   **木構造としてのDOM**:
    *   HTML文書全体が `Document` オブジェクトとして表現され、その配下に `<html>`, `<head>`, `<body>` などの要素が子ノードとして階層的に配置されます。各要素は `Element` オブジェクトとなり、その中にテキストノードや属性ノードが格納されます。
    *   この木構造は、親子関係や兄弟関係を持ち、各ノードはそれぞれが持つプロパティやメソッドを通じて操作されます。
*   **できること（主な操作例）**:
    *   **要素の取得**: `document.getElementById('id名')`, `document.querySelector('.class名')`, `document.querySelectorAll('タグ名')` などを使用して、特定のHTML要素をJavaScriptのオブジェクトとして取得できます。
    *   **内容の変更**: 取得した要素の `innerHTML` や `textContent` プロパティを変更することで、画面に表示されるテキストやHTML構造を動的に更新できます。
    *   **属性の操作**: `element.setAttribute('属性名', '値')`, `element.removeAttribute('属性名')` などで、要素の属性（`src`, `href`, `class` など）を変更できます。
    *   **スタイルの変更**: `element.style.color`, `element.style.display` などで、CSSスタイルを直接操作できます。
    *   **要素の構造変更**: `appendChild()`, `removeChild()`, `insertBefore()` などを用いて、新しい要素を動的に追加したり、既存の要素を削除・移動したりすることで、ページのレイアウトやコンテンツを変化させられます。
    *   **イベント処理**: `element.addEventListener('click', 関数)` を使って、ユーザーのクリックやキー入力などのイベントに反応する処理を設定できます。
*   **由来**: Document (文書) + Object (オブジェクトとして扱う) + Model (構造表現)

### 6.2. SOPとDOMの接点

*   **同一オリジン内でのDOM操作**:
    *   同一オリジン内のDOMは、JavaScriptから完全に自由に操作可能です。この自由度があるため、XSS攻撃などにより悪意あるスクリプトが注入されると、そのオリジン内の全情報（DOMの内容、入力データ、Cookie、LocalStorage、セッション情報など）にアクセスされてしまうリスクがあります。
*   **異なるオリジン間のDOMアクセス制限**:
    *   SOPの最も基本的な制限の一つが、異なるオリジンのドキュメント（例: `<iframe>` で埋め込まれた他サイトのページ）のDOMへの直接的なアクセス禁止です。
    *   例えば、`http://site-a.com` のページが `<iframe>` で `http://site-b.com` を埋め込んだ場合、`site-a.com` のJavaScriptは `iframe.contentWindow.document` を通じて `site-b.com` のDOMにアクセスしようとすると、SOPによりセキュリティエラーが発生し、アクセスがブロックされます。
    *   この制限は、悪意あるサイトが正当なサイトのUIを乗っ取ったり、ユーザーの機密情報を盗んだりすることを防ぐために不可欠です。
*   **安全なクロスオリジンDOM連携**:
    *   異なるオリジン間で `iframe` 内と親ウィンドウが安全にデータをやり取りする必要がある場合は、`window.postMessage()` API を使用します。このAPIは、SOPの制限を回避しつつ、明示的なメッセージ送信・受信によって安全なクロスオリジン通信を可能にします。メッセージを受信した側は、必ず送信元のオリジン（`event.origin`）を厳密に検証し、信頼できるソースからのメッセージのみを処理することが推奨されます。

## 7. まとめとIPA試験での思考フロー

| リスクの種類                  | SOP単独で防ぐか？             | 追加対策が必要か？               | 対策技術例                                         |
| :---------------------------- | :---------------------------- | :------------------------------- | :------------------------------------------------- |
| **クロスオリジンDOM/Cookie/AJAXレスポンス/Canvas窃取** | ✓ はい                      | ✗ いいえ                         |                                                    |
| **CSRF**                      | ✗ いいえ（送信自体は許可）    | ✓ はい                           | CSRFトークン、SameSite Cookie                    |
| **クリックジャッキング**      | ✗ いいえ（埋め込み自体は許可）| ✓ はい                           | X-Frame-Options, CSP frame-ancestors             |
| **XSS**                       | ✗ いいえ（同一オリジン内で発生）| ✓ はい                           | 入力エスケープ、CSP, HttpOnly Cookie             |
| **CORS誤設定の悪用**          | ✗ いいえ（設定による）        | ✓ はい                           | 適切なCORS設定（Allow-Originの限定など）           |
| **通信盗聴・改ざん**          | ✗ いいえ                      | ✓ はい                           | TLS (HTTPS)                                        |
| **サーバーサイド脆弱性悪用**  | ✗ いいえ                      | ✓ はい                           | 入力値検証、プレースホルダ、WAF                 |
| **フィッシング詐欺、マルウェア** | ✗ いいえ                      | ✓ はい                           | DMARC/SPF/DKIM、セキュリティ教育                |

### IPA試験での思考フローのヒント

1.  **問題の状況把握**:
    *   攻撃の発生源と標的が「同一オリジン」か「異なるオリジン」かを特定する。
2.  **SOPの関与を判断**:
    *   **異なるオリジン間の「読み取り」「共有」**に関する話であれば、SOPが直接関与し、デフォルトでブロックされる可能性が高い。
    *   **異なるオリジンへの「送信」**（フォーム送信など）や**「埋め込み」**に関する話であれば、SOPは直接ブロックしないため、追加対策（CSRFトークン、X-Frame-Optionsなど）が必要になる可能性が高い。
    *   **同一オリジン内で発生する攻撃**（XSSなど）であれば、SOPは直接関係なく、別の対策が必要。
3.  **関連技術の想起**:
    *   上記のSOPの関与度合いに応じて、最適な対策技術（CORS, CSRFトークン, X-Frame-Options, CSP, HttpOnlyなど）を関連付けて考える。