承知いたしました。ご提示いただいた応用情報技術者試験（平成26年春期 問28）の問題について、指定の形式で解説します。

# UNION とUNION ALLの違い



### １．全体像（テキスト図）

`UNION ALL` は、２つの表を単純に縦方向へ連結する操作です。それぞれの表のレコードが、重複を考慮せずにそのまま結合されます。

```text
  [東京在庫]         [大阪在庫]
  商品コード|在庫数     商品コード|在庫数
  ----------+------     ----------+------
  A001      |  50       B002      |  15
  B002      |  25       C003      |  35
  C003      |  35       D004      |  80
  
         ↓ UNION ALL
  
  [SQLの実行結果]
  商品コード|在庫数
  ----------+------
  A001      |  50  } 東京在庫の全レコード
  B002      |  25  }
  C003      |  35  }
  B002      |  15  } 大阪在庫の全レコード
  C003      |  35  }
  D004      |  80  }
```

### ２．定義（IPA準拠）と用語の由来

（１）**定義**
`UNION ALL`は、SQLにおける集合演算子の一つです。複数の`SELECT`文の結果を一つに統合します。`UNION`とは異なり、結果セットに含まれる重複行を削除しません。

（出典：応用情報技術者試験で用いられる一般的なSQLの定義に基づく）

（２）**用語の由来**

  * `UNION`：ラテン語で「１つになること」を意味する`unio`に由来し、数学の「和集合」の概念を表します。
  * `ALL`：「すべての」を意味し、`UNION`の標準的な動作である重複排除を行わず、「すべての行」を結果に含めることを指示します。

### ３．技術の必要性（解決する具体的課題）

`UNION ALL`は、物理的に異なる表に格納されているが論理的に同じ意味を持つデータを、まとめて取得・分析したい場合に必要となります。

  * **具体的な課題**:
      * 東京と大阪など、複数の拠点に分散している在庫データを一つのリストとして表示したい。
      * 今年度と過年度の売上データを結合し、通期の売上推移を分析したい。
  * **解決策**:
    `UNION ALL`を使用することで、各拠点の在庫表や各年度の売上表を縦に連結し、単一の結果セットとして扱うことができます。特に、各レコードが拠点や年度といった情報で明確に区別でき、重複行の削除が不要な（あるいは削除してはならない）場合に、処理が高速な`UNION ALL`が適しています。

### ４．試験の着眼点（頻出領域と解答に必要な知識を解説）

APのデータベース分野において、集合演算子は頻出領域です。
特に、`UNION`と`UNION ALL`の動作の違いは繰り返し問われます。

  * **最重要ポイント**:
      * **`UNION ALL`**: 重複行を**削除しない**。単純な連結。
      * **`UNION`**: 重複行を**削除する**。数学的な和集合。
  * **解答に必要な知識**:
      * 問題のSQLが`UNION ALL`なのか`UNION`なのかを正確に読み取ること。
      * ２つの表を**単純に足し合わせたレコード**数が、`UNION ALL`の結果の行数となることを理解していること。
      * `UNION`の場合、２つの表で「行全体（**すべての列の値）が完全に一致**するレコード」が**重複**とみなされ、１つに集約されることを理解していること。本問では`{商品コード:'C003', 在庫数:35}`が該当します。

### ５．体系マップ（分類・関係・比較表）

SQLの集合演算子は、主に以下の４つに分類されます。それぞれの違いは「重複行の扱い」と「どの部分集合を抽出するか」です。

| 演算子 | 機能 | 演算イメージ | 重複行の扱い |
| :--- | :--- | :--- | :--- |
| **`UNION ALL`** | **和集合（全件）** | 表Ａと表Ｂの**すべて**の行を結合する | **削除しない** |
| `UNION` | 和集合 | 表Ａと表Ｂの**いずれか**に含まれる行を結合する | 削除する |
| `INTERSECT` | 積集合 | 表Ａと表Ｂの**両方**に共通して存在する行を抽出する | 削除する |
| `EXCEPT` （`MINUS`） | 差集合 | 表Ａにあって表Ｂに**ない**行を抽出する | 削除する |

### ６．代表例（正答例・誤答例）

本問題における`UNION ALL`と、比較のための`UNION`の実行結果を示します。

（１）**正答例（`UNION ALL`の場合）**
問題のSQL文を実行した結果です。東京在庫（３行）と大阪在庫（３行）が単純に結合され、合計６行のレコードが返されます。

| 商品コード | 在庫数 |
| :--- | :--- |
| A001 | 50 |
| B002 | 25 |
| C003 | 35 |
| B002 | 15 |
| C003 | 35 |
| D004 | 80 |

（２）**誤答例（`UNION`の場合）**
もしSQL文が`UNION`であった場合の結果です。両方の表に存在する`{商品コード:'C003', 在庫数:35}`(**すべての列の値が完全に一致**)というレコードが**重複**とみなされ、１つに集約されます。結果は５行となります。

| 商品コード | 在庫数 |
| :--- | :--- |
| A001 | 50 |
| B002 | 25 |
| C003 | 35 |
| B002 | 15 |
| D004 | 80 |

### ７．よくある誤解と正しい知識

  * **よくある誤解**:
    「`UNION`も`UNION ALL`も、表を結合する機能なので結果は同じだろう。」
  * **正しい知識**:
    `UNION`と`UNION ALL`は明確に異なります。
    `UNION`は結果セットから重複行を排除するために、内部的にソートなどの処理を実行します。
    そのため、一般的に`UNION ALL`よりも処理が重くなります。重複がないことが保証されているデータや、重複を許容する要件の場合は、不要な処理を避けるために`UNION ALL`を使用する方が効率的です。

### ８．一問一答

**問題１**
`UNION`と`UNION ALL`の主な違いは何か。

  * **回答**:
    重複行の扱いです。`UNION`は重複行を削除しますが、`UNION ALL`は削除しません。
  * **解説**:
    この違いにより、実行結果の行数や処理性能に差が生じます。`UNION`は重複排除のための追加処理が必要なため、`UNION ALL`に比べて処理が低速になる傾向があります。

**問題２**
問題の「東京在庫」表と「大阪在庫」表に対して、以下のSQL (`INTERSECT`) を実行した結果は何か。
`SELECT 商品コード, 在庫数 FROM 東京在庫 INTERSECT SELECT 商品コード, 在庫数 FROM 大阪在庫`

  * **回答**:
    | 商品コード | 在庫数 |
    | :--- | :--- |
    | C003 | 35 |
  * **解説**:
    `INTERSECT`は積集合を求める演算子で、両方の表に共通して存在するレコードのみを返します。２つの表で完全に一致するレコードは`{C003, 35}`のみです。

**問題３**
問題の「東京在庫」表に対して、以下のSQL (`EXCEPT`) を実行した結果は何か。
`SELECT 商品コード, 在庫数 FROM 東京在庫 EXCEPT SELECT 商品コード, 在庫数 FROM 大阪在庫`

  * **回答**:
    | 商品コード | 在庫数 |
    | :--- | :--- |
    | A001 | 50 |
    | B002 | 25 |
  * **解説**:
    `EXCEPT`は差集合を求める演算子で、１つ目の`SELECT`結果にあり、２つ目の`SELECT`結果にはないレコードを返します。東京在庫のうち、大阪在庫と重複する`{C003, 35}`が除外された結果となります。

**問題４**
`UNION ALL`を使用する際に、２つの`SELECT`文で選択する列の数やデータ型が異なっていた場合、どのような結果になるか。

  * **回答**:
    エラーが発生します。
  * **解説**:
    集合演算子（`UNION`, `UNION ALL`など）を使用するための制約として、結合対象の`SELECT`文は、同じ数の列を持ち、対応する列のデータ型に互換性がなければなりません。

**問題５**
問題の２つの表を`UNION ALL`で結合した後、商品コード**ごとに(GROUP BYを予想)**在庫数の合計を求めるSQL文はどのように記述するか。

  * **回答**:
    ```sql
    SELECT 商品コード, SUM(在庫数) AS 合計在庫数
    FROM (
        SELECT 商品コード, 在庫数 FROM 東京在庫
        UNION ALL
        SELECT 商品コード, 在庫数 FROM 大阪在庫
    ) AS 全在庫
    GROUP BY 商品コード;
    ```
  * **解説**:
    `UNION ALL`で結合した結果を副問合せ（`FROM`句内の`SELECT`文）として扱い、その全体に対して**GROUP BY**句を適用することで、商品**ごとの**集計が可能になります。

### ９．要約

`UNION ALL`は、複数の`SELECT`文の結果を縦方向に結合するSQLの集合演算子です。重複する行を削除せず、全ての行をそのまま結果として返す点が`UNION`との最大の違いです。この特性により、重複排除の処理が不要なため、一般的に`UNION`よりも高速に動作します。