***

# NATとNAPTの技術解説

## 1. NATとNAPTの概要と比較

### 1.1. 定義と由来
*   **NAT (Network Address Translation)**
    *   IPアドレスを変換する技術の総称です。プライベートIPアドレスをグローバルIPアドレスに変換する仕組みを指します。
    *   **狭義のNAT**は、IPアドレスのみを**1対1**で変換します。
    *   **由来**: 「Address Translation（アドレス変換）」という言葉が示す通り、IPアドレス部分のみを書き換えることに由来します。

*   **NAPT (Network Address Port Translation)**
    *   NATの拡張技術であり、IPアドレスに加えて**ポート番号**も変換します。
    *   これにより、1つのグローバルIPアドレスを複数のプライベートIPアドレスで共有する**多対1**の変換が可能になります。
    *   **由来**: Port番号まで変換することから「Port Translation」が名称に追加されています。一般的に家庭用ルータなどで「NAT」と呼ばれる機能は、実際にはこのNAPTを指している場合がほとんどです。

### 1.2. 技術の必要性
*   **IPv4アドレス枯渇問題の解決**
    *   インターネット上で一意である必要があるグローバルIPアドレスは有限の資源です。
    *   **NAPT**を利用することで、1つのグローバルIPアドレスをLAN（Local Area Network）内の多数の端末で共有できるため、IPv4アドレスの消費を大幅に節約できます。これがNAPTが広く普及した最も大きな理由です。
*   **内部ネットワークの秘匿**
    *   NAPTを介することで、外部のインターネットからはLAN内のプライベートIPアドレスが見えなくなります。
    *   これにより、外部からの内部ネットワークへの直接的なアクセスが困難になるという、副次的なセキュリティ上のメリットが生まれます。

### 1.3. 機能比較表

| 項目 | NAT（狭義） | NAPT |
| :--- | :--- | :--- |
| **変換対象** | IPアドレスのみ | IPアドレス＋**ポート番号** |
| **対応関係** | 1対1 | **多対1** |
| **グローバルIP必要数** | 接続する端末数と同数 | 1つで多数の端末を共有可能 |
| **主な用途** | サーバ公開（固定的な変換）など | 一般家庭や企業LANのインターネット接続 |

---

## 2. NAPTの仕組み：複数端末が1つのグローバルIPを共有できる理由

### 2.1. 通信識別の基本：4つの情報の組（4タプル）
インターネット上のTCP/UDP通信は、以下の**4つの情報の組み合わせ**で一意に識別されます。この組が異なっていれば、別の通信として区別されます。

1.  **送信元IPアドレス**
2.  **送信元ポート番号**
3.  **宛先IPアドレス**
4.  **宛先ポート番号**

### 2.2. ポート番号の役割
*   **宛先ポート番号**
    *   **役割**: 提供されるサービスを識別します。
    *   **例**: Webサーバなら80番(HTTP)や443番(HTTPS)、メールサーバなら25番(SMTP)など、サービスごとに決まっています。サーバ側は、このポート番号で通信を待ち受けます。
*   **送信元ポート番号**
    *   **役割**: 通信を開始するクライアント側のセッション（通信）を識別します。
    *   **詳細**: クライアントのOSが、通信を開始する際に**空いているポート番号を自動的に割り当て**ます。これを**エフェメラルポート**（一時ポート）と呼び、一般的に49152～65535の範囲が使われます。利用者が手動で「開ける」必要はありません。

### 2.3. NAPTによる通信の流れ
ここでは、LAN内の2台のPCが、1つのグローバルIPを持つNAPTルータを経由して、同じWebサーバにアクセスする例で解説します。

*   **前提条件**
    *   PC1: `192.168.1.10`
    *   PC2: `192.168.1.11`
    *   NAPTルータのグローバルIP: `203.0.113.10`
    *   Webサーバ: `203.0.113.200:80`

**ステップ1：LAN内部のPCがパケットを送信（NAPT変換前）**
各PCのOSは、Webサーバの宛先ポート80番に向けて、自身の送信元ポートを自動で割り当ててパケットを作成します。
*   **PC1のパケット**
    *   送信元: `192.168.1.10:53001`
    *   宛先: `203.0.113.200:80`
*   **PC2のパケット**
    *   送信元: `192.168.1.11:53002`
    *   宛先: `203.0.113.200:80`

**ステップ2：NAPT装置が送信元情報を変換**
NAPTルータは、受信したパケットの**送信元IPアドレス**と**送信元ポート番号**を、自身のグローバルIPと空いているポート番号に書き換えます。この対応関係を内部の**変換テーブル（セッションテーブル）**に記録します。
*   **NAPT変換テーブルの記録**
    | 内部アドレス:ポート | 外部アドレス:ポート |
    | :--- | :--- |
    | `192.168.1.10:53001` | `203.0.113.10:60001` |
    | `192.168.1.11:53002` | `203.0.113.10:60002` |

*   **インターネットへ送出されるパケット**
    *   **PC1由来**: 送信元 `203.0.113.10:60001` → 宛先 `203.0.113.200:80`
    *   **PC2由来**: 送信元 `203.0.113.10:60002` → 宛先 `203.0.113.200:80`
    *   **ポイント**: **宛先IPと宛先ポートは変更されません**。これにより、Webサーバは正しくリクエストを受け取ることができます。

**ステップ3：Webサーバがパケットを受信して応答**
Webサーバは、**宛先ポートが80番であること**を見てHTTPリクエストとして処理します。送信元ポート（`60001`, `60002`）は、誰からの通信かを区別し、応答を返すための宛先として利用するだけです。
*   **Webサーバからの応答パケット**
    *   **PC1への応答**: 送信元 `203.0.113.200:80` → 宛先 `203.0.113.10:60001`
    *   **PC2への応答**: 送信元 `203.0.113.200:80` → 宛先 `203.0.113.10:60002`

**ステップ4：NAPT装置が応答パケットを逆変換**
NAPTルータは、受信した応答パケットの宛先（`203.0.113.10:60001`など）を見て、ステップ2で記録した**変換テーブル**を参照し、元のLAN内部のPCに正しくパケットを転送します。
*   **LAN内部へ転送されるパケット**
    *   **PC1宛**: 送信元 `203.0.113.200:80` → 宛先 `192.168.1.10:53001`
    *   **PC2宛**: 送信元 `203.0.113.200:80` → 宛先 `192.168.1.11:53002`

### 2.4. まとめ：なぜ衝突しないのか
*   **NAPTの核心**: NAPTは「**誰が（送信元IP:ポート）**」送ってきたかを、自身のグローバルIPと空きポートに書き換えて管理し、「**どこへ（宛先IP:ポート）**」送るかは変更しません。
*   **サーバ側の処理**: Webサーバは「宛先ポート」だけを見てサービスを判断するため、送信元ポートが何番であっても問題なく処理できます。
*   **クライアント側の衝突回避**:
    *   異なるクライアントからの通信は、元の送信元IPアドレスが違うためNAPTで区別できます。
    *   同じクライアントからの複数通信は、OSが異なる送信元ポート番号を割り当てるため、これも区別できます。
*   **結論**: この仕組みにより、1つのグローバルIPアドレスでも、ポート番号を使い分けることで複数の端末が同時にインターネットを利用できるのです。

---

## 3. 関連技術と概念

### 3.1. NAPTとDHCPの関係
NAPTとDHCPは全く異なる役割を持ち、相互に補完しあって家庭や企業のネットワークを支えています。

*   **DHCP (Dynamic Host Configuration Protocol) の役割**
    *   **内部通信の管理**: LAN内の各端末に、プライベートIPアドレス、サブネットマスク、デフォルトゲートウェイ、DNSサーバ情報などを**自動で割り当て**ます。
    *   **必要性**: DHCPがなければ、利用者が端末一台一台に手動でIPアドレスを設定する必要があり、設定ミスやアドレスの重複が発生しやすくなります。
*   **NAPTの役割**
    *   **外部通信の変換**: DHCPによって割り当てられた複数のプライベートIPアドレスからの通信を、1つのグローバルIPアドレスに集約してインターネットに接続させます。
*   **連携**: **DHCP**がLAN内のアドレス管理を自動化し、**NAPT**がそのLAN全体を効率的にインターネットに接続します。この組み合わせが一般的なルータの基本機能となっています。

### 3.2. アドレスの正式名称について
*   **プライベートアドレス (Private Address)**
    *   LANなど、閉じたネットワーク内部でのみ使用が許可されているIPアドレスです（例: `192.168.0.0/16`, `10.0.0.0/8`など）。RFC1918で規定されており、これが正式名称です。
*   **グローバルアドレス (Global Address)**
    *   インターネット上で一意に識別されるIPアドレスです。ISPなどから割り当てられます。
*   **「ローカルアドレス」という表現**
    *   日常的に「プライベートアドレス」とほぼ同義で使われることがありますが、試験や技術文書では「プライベートアドレス」という正式名称を用いるのが適切です。

---

## 4. 試験対策としての要点

### 4.1. よくある誤解と正しい知識
*   **誤解**: NATを使えば、1つのグローバルIPで複数端末がインターネットに接続できる。
    *   **正解**: それは**NAPT**の機能です。狭義のNATは1対1の変換です。
*   **誤解**: NAPTはセキュリティ対策のための技術である。
    *   **正解**: 主目的はIPv4アドレスの節約です。内部アドレスを隠蔽する効果はありますが、それは副次的なものであり、ファイアウォールのような本格的なセキュリティ機能ではありません。
*   **誤解**: クライアントPCでWebサイトを見るには、送信元ポートとして80番を開けておく必要がある。
    *   **正解**: 開ける必要があるのは**サーバ側**の待ち受けポートです。クライアント側の送信元ポートはOSが空いている番号を自動で割り当てます。
*   **誤解**: NAPTが通信の宛先を決めている。
    *   **正解**: 宛先はクライアントが指定し、パケットのヘッダ情報に記載されています。NAPTは**送信元**を書き換えるだけで、宛先は変更しません。

### 4.2. 一問一答形式での知識確認
**Q1. NATとNAPTの最も重要な違いは何か？**
A1. NAT（狭義）はIPアドレスのみを1対1で変換するのに対し、NAPTはIPアドレスと**ポート番号**を変換することで多対1の通信を可能にする点です。

**Q2. IPv4アドレス不足の解消に直接的に貢献するのはどちらか？**
A2. **NAPT**です。1つのグローバルIPを多数の端末で共有できるためです。

**Q3. LAN内で端末にIPアドレスを自動で割り当てるプロトコルは何か？**
A3. **DHCP**です。NAPTはアドレスの割り当てではなく、変換を行います。

**Q4. クライアントがWebサーバ（ポート80）にアクセスする時、自身の送信元ポート番号はどう決まるか？**
A4. OSが**未使用のポート番号（エフェメラルポート）**を自動的に割り当てます。

**Q5. NAPT装置は、複数端末からの通信をどのようにして区別しているのか？**
A5. 送信元ポート番号を、NAPT装置が管理する一意のポート番号に変換し、その対応関係を**変換テーブル（セッションテーブル）**に記録することで区別します。

**Q6. Webサーバは、NAPTルータから送られてくる様々な送信元ポート番号（例: 60001, 60002）にどう対応するのか？**
A6. Webサーバは**宛先ポート番号（例: 80）**のみを見てリクエストを処理します。送信元ポート番号は、応答パケットを返す際の宛先として使うだけで、特別な対応は不要です。