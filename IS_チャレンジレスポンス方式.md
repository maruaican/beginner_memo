## チャレンジレスポンス方式の認証

１　全体像（テキスト図）

```
クライアント                                        サーバ
利用者がパスワード入力
       │
       ▼
┌──────────────┐
│  パスワードの    │
│  メッセージダイジェスト生成 │  ← ハッシュ関数（Hash Function: ハッシュ関数。MD5, SHA-1など）
└──────────────┘
       │
       │
       │  チャレンジ送信（サーバ→クライアント）
       ◀─────────────────────
       │
       ▼
┌─────────────────────┐
│  受信したチャレンジとパスワードダイジェストを  │
│  組み合わせて新たにハッシュ（レスポンス）生成 │
└─────────────────────┘
       │
       │  レスポンス送信（クライアント→サーバ）
       ─────────────────────▶
       │
       ▼
┌─────────────────────┐
│  サーバ側で保管しているパスワードダイジェストと │
│  チャレンジを組み合わせて同じハッシュ計算     │
│  （レスポンス照合データ）                        │
└─────────────────────┘
       │
       ▼
クライアント送信レスポンスと照合 → 認証成功/失敗
```

---

１－１　定義（IPA準拠）と用語の由来

* **定義（IPA）**：通信経路上に平文パスワードを送信せず認証を行う方式
* **語源**：Challenge（チャレンジ: サーバが発行する一度きりの値）、Response（レスポンス: クライアントが返す応答）

---

１－２　技術の必要性（解決する課題）

* **平文送信（Plaintext Transmission: 暗号化せずにそのまま送ること）** だと盗聴されると認証情報が漏える
* チャレンジを毎回変えることで、\*\*リプレイ攻撃（Replay Attack: 過去のデータを再送して不正に利用する攻撃）\*\*や盗聴のリスクを防ぐ

---

１－３　試験の着眼点

* \*\*ハッシュ関数（Hash Function: 一方向関数。入力データから固定長の値を生成）**による**メッセージダイジェスト（Message Digest: 要約値）\*\*の理解
* チャレンジと組み合わせてレスポンス生成する流れ
* サーバ側の照合手順（パスワードダイジェスト＋チャレンジ→レスポンス）

---

１－４　体系マップ（比較表）

| 項目      | 平文認証（Plaintext Authentication） | チャレンジレスポンス方式（Challenge-Response Authentication） |
| ------- | ------------------------------ | ----------------------------------------------- |
| パスワード送信 | 平文                             | 送信せず（ダイジェスト＋チャレンジのみ）                            |
| 盗聴耐性    | 低                              | 高                                               |
| リプレイ耐性  | 低                              | 高（チャレンジ毎回異なる）                                   |
| 計算必要性   | なし                             | ハッシュ計算（2回：パスワード→ダイジェスト、ダイジェスト＋チャレンジ→レスポンス）      |

---

１－５　代表例

\*正答例：

* **APOP認証（Authenticated Post Office Protocol: 電子メールPOPの拡張認証）**
* **NTLM認証（NT LAN Manager Authentication: Microsoft独自のチャレンジレスポンス認証）**

誤答例：

* 平文パスワード送信
* \*\*MD5（Message Digest Algorithm 5: 古典的ハッシュ関数）\*\*のみで直接送信（チャレンジなし）

---

１－６　よくある誤解

* 誤解：チャレンジレスポンス方式なら通信自体が暗号化されている
  → 正：暗号化（Encryption）は別。`盗聴防止は「パスワードを直接送らない」点`である。

* 誤解：同じレスポンスを使い回せば安全
  → 正：チャレンジは毎回異なる必要がある。使い回すと**リプレイ攻撃**される。

---
１－７　一問一答（5問：問題→回答→解説）

①
問題：チャレンジレスポンス方式でサーバが毎回異なるチャレンジを送る理由は？

回答：リプレイ攻撃を防ぐため
解説：攻撃者が過去のレスポンスを盗聴しても、チャレンジが変わるので再利用できない。

②
問題：クライアント側で計算される「レスポンス」は何をもとに生成されるか？

回答：利用者パスワードのメッセージダイジェスト＋サーバからのチャレンジ
解説：単独のパスワードではなく、チャレンジと組み合わせて安全性を高める。

③
問題：チャレンジレスポンス方式で通信経路を暗号化する必要はあるか？

回答：必須ではない
解説：パスワードは直接送られないため安全。ただし、通信内容全体の秘匿性を確保するには\*\*TLS（Transport Layer Security: 通信の暗号化プロトコル）\*\*などが望ましい。

④
問題：サーバ側がレスポンス照合データを作る際に使うものは？

回答：サーバ保有のパスワードダイジェスト＋チャレンジ
解説：これを元に計算した値とクライアントのレスポンスを比較して認証する。

⑤
問題：チャレンジレスポンス方式で攻撃者に盗聴された場合、過去のレスポンスは再利用可能か？

回答：不可能
解説：チャレンジは毎回異なるため、以前のレスポンスは新しい認証には使えない。

---

１－８　要約

* サーバが毎回ランダムな**チャレンジ**を生成してクライアントに送る。
* クライアントは**パスワードダイジェスト**とチャレンジでレスポンス生成。
* サーバで照合し、パスワードを直接送らずに安全認証を実現。

---

## チャレンジレスポンス方式：クライアント／サーバ処理対比表（修正版）

| ステップ    | クライアントの処理                                                                           | サーバの処理                                                                                             |
| ------- | ----------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| 0（事前準備） | —                                                                                   | ユーザー登録時にパスワードをハッシュ化して**保存パスワードダイジェスト**を作成・保持<br>`保存ダイジェスト = SHA256(パスワード)`                         |
| 1       | 利用者がパスワードを入力                                                                        | —                                                                                                  |
| 2       | 入力パスワードを**ハッシュ化してパスワードダイジェスト**を作成（**1段階目のハッシュ**）<br>`パスワードダイジェスト = SHA256(入力パスワード)` | —                                                                                                  |
| 3       | —                                                                                   | サーバは認証要求を受けると**ランダムで一度きりのチャレンジ**を生成、クライアントに送信、内部で保持                                                |
| 4       | サーバから受け取ったチャレンジとパスワードダイジェストを**連結**                                                  | —                                                                                                  |
| 5       | 連結データをハッシュ化して**レスポンス**を生成（**2段階目のハッシュ**）<br>`レスポンス = SHA256(パスワードダイジェスト + チャレンジ)`   | 保存済みダイジェストと保持チャレンジを同じ方法で連結し、**照合用レスポンス**を生成（**2段階目のハッシュ**）<br>`照合レスポンス = SHA256(保存ダイジェスト + チャレンジ)` |
| 6       | 生成したレスポンスと利用者IDをサーバに送信                                                              | クライアントから送られたレスポンスと照合レスポンスを比較                                                                       |
| 7       | —                                                                                   | 一致すれば認証成功、一致しなければ失敗                                                                                |

---

### ポイント整理（今回追加）

1. **二段階ハッシュ化**

   * 1段階目：入力パスワード → パスワードダイジェスト
   * 2段階目：パスワードダイジェスト + チャレンジ → レスポンス

2. **サーバはパスワードそのものを知らなくても認証可能**

3. **チャレンジは毎回ランダム** → リプレイ攻撃防止

4. **パスワードは通信経路に一切流れない**

---


