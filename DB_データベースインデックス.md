# データベースインデックス：B+木インデックスとハッシュインデックスの比較解説

## 1. はじめに：インデックス選択の重要性

### 1.1. 問題提起：インデックス選択のケーススタディ

以下の"売上"表への検索処理において、B+木インデックスよりもハッシュインデックスを設定した方が適切なものはどれでしょうか。インデックスを設定する列は`＜＞`内に示します。

*   **テーブル定義**:
    `売上 (伝票番号，売上年月日，商品名，利用者ID，店舗番号，売上金額)`

*   **選択肢**:
    *   売上金額が1万円以上の売上を検索する。`＜売上金額＞`
    *   売上年月日が今月の売上を検索する。`＜売上年月日＞`
    *   商品名が'DB'で始まる売上を検索する。`＜商品名＞`
    *   利用者IDが'1001'の売上を検索する。`＜利用者ID＞`

### 1.2. インデックスとは何か

インデックスは、データベースに格納されているデータの検索を高速に行うための仕組みです。

*   **役割**:
    データベース内のテーブルや列に関する特定のキー値を格納し、その値を元にデータの高速な検索や並べ替えを可能にします。インデックスを使用することで、データベースのアクセス効率を高めることができます。

*   **技術的背景**:
    大規模なデータに対する検索では、全件を順番に調べる**全件走査（フルスキャン）**を行うと処理が非常に遅くなります。検索条件ごとに適したインデックスを設計することで、この問題を解決します。

*   **考慮点**:
    インデックスの利用に際しては、追加のディスクスペースやデータの更新・追加・削除時にインデックスをメンテナンスするための追加処理が必要となるため、適切な設計と管理が求められます。

## 2. インデックスの種類と特徴

インデックスにはいくつかの種類がありますが、ここでは代表的な「B+木インデックス」と「ハッシュインデックス」について解説します。

### 2.1. B+木インデックス (B-plus Tree Index)

*   **概要**:
    B木を改良した木構造でデータを管理する方式で、RDBMS（リレーショナルデータベース管理システム）で最も一般的に使用されています。

*   **構造と特徴**:
    *   節（ノード）ごとにキー値の範囲とその子要素へのポインタを保持しており、データを順序付きで管理します。
    *   インデックスノードはソートされた状態になっているため、**整列処理（`ORDER BY`）が高速**に行えます。
    *   木構造の深さが一定に保たれる（平衡木）ため、どのようなキー値であっても**探索コストが大きく変わらず、安定**しています。
    *   大量のデータに対する操作であっても、ある程度の速度が期待できます。

*   **得意な処理**:
    *   **範囲検索**: `>`、`>=`、`<`、`<=`、`BETWEEN`など。キーが順序通りに並んでいるため、特定の範囲を効率的にスキャンできます。
    *   **前方一致検索**: `LIKE 'DB%'`など。これも実質的に「'DB'で始まり、それ以降は任意」という範囲検索として扱われます。
    *   **並び替え**: `ORDER BY`句など。

*   **由来**:
    **Balanced tree（平衡木）**系列の改良版であることから名付けられました。

### 2.2. ハッシュインデックス (Hash Index)

*   **概要**:
    ハッシュ関数を使用して、キー値とレコードの格納位置（アドレス）を直接関連付ける方式です。

*   **構造と特徴**:
    *   キー値をもとにハッシュ関数で格納位置を一意に特定できるため、B+木インデックスよりも**高速なアクセスが可能**です。
    *   ハッシュ値には順序性がないため、**範囲検索やキー値を順番に読み込んで処理を行う用途には使用できません**。

*   **得意な処理**:
    *   **完全一致検索（等価検索）**: `=` や `IN`句での特定の値の検索。

*   **由来**:
    **「刻印」「散らす」**という意味の"Hash"から、データを分散配置する手法として名付けられました。

### 2.3. B+木インデックスとハッシュインデックスの比較

| 種類 | 得意な検索 | 不得意な検索 |
| :--- | :--- | :--- |
| **B+木インデックス** | **範囲検索** (`>=`, `BETWEEN`など)<br>**並び替え** (`ORDER BY`)<br>**前方一致検索** (`LIKE 'DB%'`) | 完全一致検索だけならハッシュインデックスより遅い場合がある |
| **ハッシュインデックス** | **完全一致検索** (`=`) | **範囲検索**、**順序処理** (`ORDER BY`) |

## 3. 設問の解説：最適なインデックスの選択

上記の特性を踏まえ、冒頭の設問の各選択肢について、どちらのインデックスが適しているかを検討します。

*   **ア．売上金額が1万円以上の売上を検索する。＜売上金額＞**
    *   **評価**: `>` や `>=` を使用する**範囲検索**に該当します。これは**B+木インデックス**が得意とする処理であり、ハッシュインデックスには不向きです。

*   **イ．売上年月日が今月の売上を検索する。＜売上年月日＞**
    *   **評価**: 特定の期間（例: `BETWEEN 'YYYY-MM-01' AND 'YYYY-MM-31'`）を指定する**範囲検索**に該当します。これも**B+木インデックス**が適しており、ハッシュインデックスには不向きです。

*   **ウ．商品名が'DB'で始まる売上を検索する。＜商品名＞**
    *   **評価**: `LIKE 'DB%'` を使用する**前方一致検索**です。これは「'DB'から始まるすべての文字列」という範囲を指定するのと同じであるため、**B+木インデックス**が適しています。ハッシュインデックスには不向きです。

*   **エ．利用者IDが'1001'の売上を検索する。＜利用者ID＞**
    *   **評価**: `=` を使用してキー値に完全一致するレコードを検索する**完全一致検索（等価検索）**です。これはハッシュ関数で直接格納位置を特定できる**ハッシュインデックス**が最も高速に処理できるため、最適です。

**結論**: 正しい選択肢は**エ**です。キー値に関連付けられた単一（または少数）のレコードを検索するため、ハッシュインデックスを有効に活用できる処理です。

## 4. 学習のポイントと補足

### 4.1. よくある誤解と正しい知識

*   **誤解1**: 「`LIKE 'DB%'` は特定文字列の検索だからハッシュ向きだ」
    *   **正しい知識**: 前方一致検索は、実質的に「'DB'以上で'DC'未満」のような**範囲検索**として処理されるため、B+木インデックスが適切です。

*   **誤解2**: 「B+木インデックスは完全一致検索ができない」
    *   **正しい知識**: B+木インデックスでも完全一致検索は**可能**です。ただし、ハッシュインデックスが直接アドレスを計算するのに対し、B+木は木構造を根からたどるため、一般的にハッシュインデックスの方が高速です。

### 4.2. 試験における着眼点

*   情報処理技術者試験（IPA）では、「どの検索条件にどのインデックスが適しているか」という問いが頻出します。
*   以下の基本原則を覚えておくことが重要です。
    *   **範囲検索**や**前方一致検索** → **B+木インデックス**
    *   **完全一致検索** → **ハッシュインデックス**

## 5. 理解度チェック（一問一答）

**Q1.** ハッシュインデックスが最も得意とする検索条件は何ですか？
**A1.** `=` 演算子などを用いた**完全一致検索**です。ハッシュ関数により、キー値から直接データのアドレスを計算できるためです。

**Q2.** 「売上金額が1万円以上」という条件の検索に向いているインデックスはどちらですか？
**A2.** **B+木インデックス**です。これは**範囲検索**に該当するためです。

**Q3.** `商品名 LIKE 'DB%'` という条件の検索に向いているインデックスはどちらですか？
**A3.** **B+木インデックス**です。前方一致検索は「'DB'で始まる文字列の範囲」を探す処理と見なされるためです。

**Q4.** ハッシュインデックスが苦手とする検索処理の例を挙げてください。
**A4.** **範囲検索**（`BETWEEN`, `>` など）や、**順序に依存する処理**（`ORDER BY`）です。ハッシュ値には順序性がないため、これらの処理には適していません。

**Q5.** 元の設問で、ハッシュインデックスの利用が最も適切な選択肢はどれですか？
**A5.** 「利用者IDが'1001'の売上を検索する」です。これは**完全一致検索**の典型例であり、ハッシュインデックスの長所を最大限に活かせます。