
# SQLトランザクション制御の体系的解説


一問一答（5問）

Q1. COMMITを行った後にROLLBACKは可能か？
A1. 不可能。
解説：COMMITは永続化を意味し、後戻りはできない。

Q2. 部分的なトランザクション取消を可能にする機能は？
A2. SAVEPOINT。
解説：ROLLBACK TO [SAVEPOINT] により、一部の処理のみ取り消せる。

Q3. チェックポイントの主な目的は？
A3. 障害復旧時間の短縮。
解説：チェックポイント以降のログのみを適用すればよいため。

Q4. ジャーナル（トランザクションログ）には何が記録されるか？
A4. トランザクションの開始・更新内容・コミット／ロールバック。
解説：これにより復旧時に正しい状態を再現可能。

Q5. ロールフォワードとロールバックの違いは？
A5. ロールフォワード＝未来に進める、ロールバック＝過去に戻す。
解説：試験では対比を問われやすい。






```sql
トランザクション制御
 ├─ 基本操作
 │    ├─ COMMIT（確定）
 │    └─ ROLLBACK（取消）
 │
 ├─ 部分制御
 │    └─ SAVEPOINT（部分取消）
 │
 └─ 障害回復
      ├─ チェックポイント（復旧開始地点）
      ├─ ジャーナル（トランザクションログ）
      └─ ロールフォワード（障害直前まで進める）
```



## 1. トランザクションの基本操作：確定と取り消し

データベースにおけるトランザクションとは、一連の処理を一つの論理的な単位としてまとめたものです。この単位内の処理は、全て成功する（コミット）か、全て失敗する（ロールバック）かのどちらかであることが保証されます。

### 1.1. コミット (COMMIT)

*   **定義と役割**
    トランザクションで行った全ての変更を確定し、データベースに永続化させる操作です。「コミットポイント」とも呼ばれます。この操作が完了すると、変更内容は恒久的なものとなり、後から取り消すことはできません。

*   **用語の由来**
    「約束を確定させる」という意味に由来します。

*   **障害発生時の挙動**
    コミットされた変更は、その後に障害（停電、システムクラッシュ等）が発生してもディスクに保存されているため、失われません。データの永続性が保証されます。

*   **具体例**
    ```sql
    BEGIN TRANSACTION;
    UPDATE 社員 SET 給与 = 500000 WHERE 社員ID = 101;
    COMMIT;  -- この操作で変更が確定・永続化される
    ```

*   **注意点・よくある誤解**
    コミットはトランザクション全体の確定のみを行い、部分的な取り消しはできません。

### 1.2. ロールバック (ROLLBACK)

*   **定義と役割**
    トランザクション内の変更を全て取り消し、トランザクション開始前の状態に戻す操作です。

*   **障害発生時の挙動**
    コミットされていない変更は、障害発生時に自動的にロールバックされ、データベースには反映されません。

## 2. トランザクションの部分的な制御：セーブポイント (SAVEPOINT)

*   **定義と役割**
    トランザクションの途中に「中間ポイント」を設定する機能です。これにより、トランザクション全体を取り消すことなく、特定のセーブポイントまで処理を戻す（部分的にロールバックする）ことが可能になります。

*   **用語の由来**
    「途中状態を保存する地点」という意味に由来します。

*   **必要性**
    長いトランザクション内で複数の処理を行う際、一部の処理だけをやり直したい場合に有効です。例えば、複数のデータ更新中に一箇所だけ入力ミスがあった場合、トランザクション全体をやり直す必要がなくなります。

*   **具体例**
    ```sql
    BEGIN TRANSACTION;
    UPDATE 社員 SET 給与 = 500000 WHERE 社員ID = 101;
    SAVEPOINT sp1; -- セーブポイント 'sp1' を設定
    UPDATE 社員 SET 給与 = 550000 WHERE 社員ID = 102; -- この変更は後で取り消される
    ROLLBACK TO sp1;  -- セーブポイント 'sp1' 以降の変更 (ID=102の給与変更) を取り消す
    COMMIT; -- ID=101の給与変更のみが確定される
    ```

*   **ロールバックできる範囲**
    `ROLLBACK TO [セーブポイント名]` を実行すると、そのセーブポイントが設定されてからコマンドが実行されるまでの間の変更が取り消されます。セーブポイントより前の変更は保持されます。

*   **注意点・よくある誤解**
    セーブポイントはあくまでトランザクション内の一時的な記録であり、コミットのようにデータを永続化するものではありません。そのため、コミットされずにトランザクションが終了した場合や、障害が発生した場合には、セーブポイントで記録した変更も失われます。

## 3. 障害回復の仕組み：チェックポイント、ジャーナル、ロールフォワード

データベースに障害が発生した場合でも、コミット済みのデータを失わず、かつ障害発生直前の状態にまで正確に復旧させるための仕組みが存在します。

### 3.1. 障害回復の全体像

障害からの復旧は、主にチェックポイントとジャーナル（トランザクションログ）を用いて行われます。

```
          [障害発生]
              │
[復旧開始] ───┴──> 1. 最新のチェックポイントからデータを復元
              │
              └───> 2. ジャーナル(ログ)を適用 (ロールフォワード)
              │
              └───> [障害発生直前の状態に復旧完了]
```

### 3.2. 各用語の役割

#### 3.2.1. チェックポイント (Checkpoint)
*   **定義と役割**
    メモリ（バッファ）上で行われたデータベースへの変更内容を、ディスク上の物理的なファイルに書き出すタイミングや、その処理自体のことです。障害発生時の復旧時間を短縮する目的で利用されます。

*   **必要性**
    チェックポイントがない場合、障害からの復旧には最初から全てのログを適用し直す必要があり、時間がかかります。定期的にチェックポイントを設けることで、復旧作業を開始する基準点ができ、復旧が高速化されます。

*   **注意点・よくある誤解**
    *   チェックポイントは復旧を補助する仕組みであり、これ自体がコミットのようにデータの永続性を保証するものではありません。
    *   トランザクションの途中取り消しとは無関係です。

#### 3.2.2. ジャーナル (Journal) / トランザクションログ
*   **定義と役割**
    データベースに加えられた全ての変更履歴（トランザクションの開始、更新内容、コミット、ロールバックなど）を時系列で記録したログファイルです。

*   **必要性**
    障害発生時に、どのトランザクションがコミットされ、どれが未完了だったかを正確に把握し、データベースを矛盾のない状態に復旧するために不可欠です。

#### 3.2.3. ロールフォワード (Roll Forward)
*   **定義と役割**
    障害からの復旧時に行われる操作の一つです。最新のチェックポイント以降にジャーナルに記録されている更新情報をデータベースに再適用し、障害発生直前の状態まで進める処理を指します。

*   **復旧プロセス**
    障害発生後、まずディスク上のデータ（最新のチェックポイントの状態）を読み込み、その後ジャーナルを使ってコミット済みのトランザクションを順に再実行（ロールフォワード）することで、失われた変更を復元します。

*   **注意点・よくある誤解**
    ロールバック（変更を取り消して過去に戻る）とは逆の操作であり、失われた変更を適用して未来（障害発生直前）に進めるのがロールフォワードです。

### 3.3. 障害回復における各技術の関係

| 用語 | 役割 | 障害復旧への関与 | トランザクション内部分取り消し可否 |
| :--- | :--- | :--- | :--- |
| **コミット** | 変更を確定し、永続化を保証する | 復旧すべき最終的なデータの状態を定義する | 不可 |
| **セーブポイント** | トランザクション内の中間状態を記録 | 直接的な関与はない（コミット前の変更は障害で失われる） | **可** |
| **チェックポイント** | メモリ上の変更をディスクに書き出す基準点 | 障害復旧の開始地点となり、復旧時間を短縮する | 不可 |
| **ジャーナル** | 全てのトランザクション履歴を時系列で記録 | ロールフォワード処理の入力情報となり、失われた変更を復元する | 不可 |
| **ロールフォワード** | ジャーナルを適用して障害発生直前の状態に進める | チェックポイント以降のコミット済みデータを復元する実際の操作 | - |

## 4. 補足：制約モード (Constraint Mode)

*   **定義と役割**
    データベースのデータの整合性を保つためのルール（制約：例 `NOT NULL`, `UNIQUE`など）の動作方式を設定するものです。

*   **トランザクション制御との関係**
    トランザクションの部分的な取り消しや障害回復の仕組みとは直接的な関係はありません。データの正しさを保証するための、また別の仕組みです。


    付録：実務的なログ（ジャーナル）と復旧の時系列例（詳細）

ログサンプル（簡略化）

[LSN100] TX100 START
[LSN101] TX100 UPDATE 注文明細 SET 数量=数量-1 WHERE 注文明細ID=201
[LSN102] TX100 COMMIT
[LSN103] TX200 START
[LSN104] TX200 UPDATE 商品 SET 在庫=在庫-1 WHERE 商品ID=100
-- crash here (TX200 未コミット)


復旧手順（起動時）

最新チェックポイント（例 LSN90）のデータ状態をディスクからロード。

ジャーナルを LSN90 以降順に読み、コミット済みのTXはREDO（LSN101 の TX100 を再適用）。

未コミットのTXはUNDO（LSN104 の TX200 を取り消す）。

システム整合性が取れたら稼働再開。