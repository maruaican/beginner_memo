(平成29年春期午前 問29)

トランザクションAとBが，共通の資源であるテーブルaとbを表に示すように更新するとき，デッドロックとなるのはどの時点か。ここで，表中の①～⑧は処理の実行順序を示す。また，ロックはテーブルの更新直前にテーブル単位で行い，アンロックはトランザクションの終了後に行うものとする。

| 時間 ↓ | トランザクションA | トランザクションB |
|:---:|:---:|:---:|
| | ① トランザクション開始 | |
| | | ② トランザクション開始 |
| | ③ テーブルa更新 | |
| | | ④ テーブルb更新 |
| | ⑤ テーブルb更新 | |
| | | ⑥ テーブルa更新 |
| | ⑦ トランザクション終了 | |
| | | ⑧ トランザクション終了 |

**選択肢**

ア. ③
イ. ④
ウ. ⑤
エ. ⑥

## 解説

### デッドロックの定義
まず、デッドロックの定義を再確認しましょう。
デッドロックとは、「2つ以上のプロセスが、互いに相手が確保している資源の解放を待ってしまい、どちらも処理を進められなくなる状態」を指します。

ポイントは**「`互いに（相互に）待ち状態`になる」**という点です。`片方だけが待っている状態は、まだデッドロックではありません`。

### 各ステップでの状態変化

それでは、ロックの状態に着目して、処理を1つずつ見ていきましょう。

*   **① トランザクションA 開始**
    *   ロック状態：なし

*   **② トランザクションB 開始**
    *   ロック状態：なし

*   **③ トランザクションAがテーブルaを更新**
    *   Aがテーブルaをロックします。
    *   ロック状態：
        *   A: **テーブルaをロック中**
        *   B: なし

*   **④ トランザクションBがテーブルbを更新**
    *   Bがテーブルbをロックします。
    *   ロック状態：
        *   A: **テーブルaをロック中**
        *   B: **テーブルbをロック中**

*   **⑤ トランザクションAがテーブルbを更新しようとする**
    *   Aはテーブルbをロックしようとしますが、すでにBがロックしています。
    *   このため、**トランザクションAは、Bがテーブルbのロックを解放するのを待つ「待ち状態」**になります。
    *   ロック状態：
        *   A: テーブルaをロック中。**テーブルbのロックを待っている（待ち状態）**
        *   B: テーブルbをロック中。**まだ処理を続けられる（待ち状態ではない）**

    **ここが重要なポイントです。**
    この時点では、Aが一方的にBを待っているだけです。Bはまだどのリソースも待っておらず、自分の処理（次のステップ⑥）に進むことができます。これは**「デッドロック」ではなく、単なる「ブロック（待ち）」**です。

*   **⑥ トランザクションBがテーブルaを更新しようとする**
    *   （⑤でAが待ち状態になった後）まだ処理を続けられるBが、次にテーブルaをロックしようとします。
    *   しかし、テーブルaはすでにAがロックしています。
    *   このため、**トランザクションBも、Aがテーブルaのロックを解放するのを待つ「待ち状態」**になります。
    *   ロック状態：
        *   A: テーブルaをロック中。**テーブルbのロックを待っている**
        *   B: テーブルbをロック中。**テーブルaのロックを待っている**

    **この瞬間に、デッドロックが成立します。**
    *   Aは、Bがロックしているテーブルbを待っている。
    *   Bは、Aがロックしているテーブルaを待っている。
    このように**「互いに相手の持っているリソースを待つ」という循環的な待ち状態**が完成したため、どちらのトランザクションも永久に処理を進めることができなくなりました。

### まとめ
*   **⑤の時点**：AだけがBを待っている**「一方的な待ち」**状態。Bはまだ動ける。
*   **⑥の時点**：AがBを待ち、BもAを待つ**「相互の待ち」**状態が初めて成立。

したがって、デッドロックが成立するのは⑥の時点となります。
「あなたの解答：ウ（⑤）」が不正解だったのは、この違いによるものです。
