# 外部キーと主キーの関係（複合主キーを含む）

※複合主キーを参照する場合、外部キーも同じ組合せを持つ必要がある。

## １　全体像（テキスト図）

```
部署表（会社番号＋部署番号が主キー）
   ┌───────────────┐
   │会社番号(PK)   │
   │部署番号(PK)   │
   │部署名         │
   └───────────────┘
             ▲ 1
             │（参照される）
             │
             ▼ 多
   ┌───────────────┐
   │従業員番号(PK) │
   │社員名         │
   │会社番号(FK)   │
   │部署番号(FK)   │
   └───────────────┘
従業員表（会社番号＋部署番号が外部キー）
```

---

## １－１　定義（IPA準拠）と用語の由来

* **主キー（Primary Key）**
  表の中で各行を一意に識別するための列または列の組合せ。
  由来：primary（主要な、一番大事な）＋ key（鍵）。

* **外部キー（Foreign Key）**
  他の表の主キーを参照する列。参照整合性制約によって、存在しない値は登録できない。
  由来：foreign（外部の）＋ key（鍵）。

---

## １－２　技術の必要性（解決する具体的課題）

* 部署番号は会社ごとに重複し得るため、**会社番号＋部署番号**を複合主キーとして部署を一意に識別。
* 従業員が所属する部署を特定するために、従業員表も「会社番号＋部署番号」を外部キーとして保持する。
* これにより「存在しない会社や部署への所属」という矛盾を防ぐ。

---

## １－３　試験の着眼点（頻出領域と必要知識）

* **狙われやすい出題ポイント**

  * 複合主キーを参照する外部キー
  * 1対多の関係の方向性（多←１）
  * 外部キーが一意ではないこと
* **必要知識**

  * 外部キーは「参照先の主キー」と同じ構造を持つ必要がある。
  * 外部キー自身は一意でなくてもよいが、参照先主キーの一意性によって、必ず1行を特定できる。

---

## １－４　体系マップ（分類・関係・比較表）

| 項目   | 主キー             | 外部キー             |
| ---- | --------------- | ---------------- |
| 定義   | 表内の一意識別子        | 他表の主キーを参照        |
| 一意性  | 必ず一意            | 一意である必要なし（多行OK）  |
| NULL | 不可              | 許容される場合あり        |
| 位置   | １の側             | 多の側              |
| 例    | 部署表の「会社番号＋部署番号」 | 従業員表の「会社番号＋部署番号」 |

---

## １－５　代表例（正答例・誤答例）

* **正答例**
  従業員表の「会社番号＋部署番号」を外部キーとし、部署表の「会社番号＋部署番号（主キー）」を参照。

* **誤答例**
  従業員表に「部署番号」だけを外部キーとして設定。
  → 会社を区別できないため、一意に部署を特定できない。

---

## １－６　よくある誤解と正しい知識

* 誤解①：外部キー単体で一意に特定できる。
  → 正しくは「参照先の主キーが一意だから、外部キーを通じて特定できる」。

* 誤解②：外部キーは必ず一意。
  → 実際は「多側」にあるので、同じ外部キーを持つ行が複数存在できる。

---

## １－７　一問一答（5問）

**Q1.** 外部キーは必ず何を参照するか？
**A1.** 他表の主キーまたは一意キー。
**解説**：一意性を保証できるものに限られる。

---

**Q2.** 部署表の主キーが「会社番号＋部署番号」の場合、従業員表の外部キーは何列必要か？
**A2.** 会社番号と部署番号の2列。
**解説**：複合主キーを参照するので、外部キーも同じ組合せを持つ必要がある。

---

**Q3.** 外部キーは一意性を持たなければならないか？
**A3.** いいえ。
**解説**：外部キーは多側に存在し、同じ外部キーを持つ従業員が多数いてよい。

---

**Q4.** 外部キーが参照する行が必ず1行に定まるのはなぜか？
**A4.** 主キーが一意だから。
**解説**：外部キー自体ではなく、参照先の主キーの一意性によって決まる。

---

**Q5.** 外部キーが複数の主キーを同時に参照することは可能か？
**A5.** 不可能。
**解説**：主キーは一意なので、必ず1行だけに対応する。

---

## １－８　要約（3行以内）

* 部署表は「会社番号＋部署番号」で一意に定まる複合主キーを持つ。
* 従業員表は同じ2列を外部キーとして参照するので、部署を必ず1つに特定できる。
* 外部キーは一意でなくても、参照先主キーの一意性で整合性が保たれる。

---

👉 つまり、**二つの外部キー（会社番号＋部署番号）のセットが、部署表の複合主キーを参照するから一意に部署を特定できる**、これが本質です。

次のステップとして、SQLの `JOIN` で「なぜその2列で結合するのか」を見てみると、さらに試験でも実務でも使える理解になりますが、JOIN例も付けてみますか？

了解しました！SQLのJOINを具体例で整理しますね。
テーマは「従業員表が所属部署を参照する場面」です。

---

# 主キーと外部キーを使ったJOINの具体例

## １　前提：テーブル定義（販売業モデル）

```
部署表(部署)
・会社番号(PK)
・部署番号(PK)
・部署名

従業員表(従業員)
・従業員番号(PK)
・社員名
・会社番号(FK)
・部署番号(FK)
```

* 部署表は「会社番号＋部署番号」で一意。
* 従業員表は同じ2列（会社番号＋部署番号）を外部キーとして保持。

---

## ２　JOINのSQL例

従業員の所属部署名を取得する例です。

```sql
SELECT 従業員.従業員番号,
       従業員.社員名,
       部署.部署名
FROM 従業員
     INNER JOIN 部署
     ON 従業員.会社番号 = 部署.会社番号
    AND 従業員.部署番号 = 部署.部署番号; 　※複合主キーと同じ組み合わせにしている。
```

---

## ３　評価順（SQL処理の流れ）

1. **FROM句**

   * 従業員表と部署表を読み込む
2. **ON句**

  * 従業員表の外部キー（従業員.会社番号＋従業員.部署番号）と部署表の複合主キー（部署.会社番号＋部署.部署番号）が等しい行を結合条件として組み合わせる
  * → 部署表では複合主キー（会社番号＋部署番号）が一意であるため、従業員は必ず1つの部署に結びつく。
  * ただし、1つの部署には複数の従業員が所属できるため、これは「1対多」の関係となる（一致結果は常に1つの部署と複数の従業員の組合せになる）。

  * ポイントを整理すると
  * 外部キーは参照先の主キーと同じ構造を持つ必要がある（単項主キーなら1列、複合主キーなら同じ組合せの列）。
  * 外部キー自身が一意である必要はないが、参照先の主キーが一意なので、結果的に行を一意に特定できる。
3. **SELECT句**

   * 指定列（従業員番号・社員名・部署名）を取り出す
4. **ORDER BY句**（あれば最後にソート）

---

## ４　実行イメージ

例データ：

**部署表**

| 会社番号 | 部署番号 | 部署名 |
| ---- | ---- | --- |
| 1    | 10   | 営業部 |
| 1    | 20   | 開発部 |
| 2    | 10   | 管理部 |

**従業員表**

| 従業員番号 | 社員名 | 会社番号 | 部署番号 |
| ----- | --- | ---- | ---- |
| 1001  | 田中  | 1    | 10   |
| 1002  | 佐藤  | 1    | 20   |
| 1003  | 鈴木  | 2    | 10   |

→ 実行結果：

| 従業員番号 | 社員名 | 部署名 |
| ----- | --- | --- |
| 1001  | 田中  | 営業部 |
| 1002  | 佐藤  | 開発部 |
| 1003  | 鈴木  | 管理部 |

---

## ５　ポイント整理

* **部署番号だけでJOINするとエラーや誤結合が発生**
  → 会社番号が異なる同じ部署番号（例：会社1の「10＝営業部」と会社2の「10＝管理部」）が区別できなくなる。
* **会社番号＋部署番号のセットでJOINすることで、部署表の複合主キーと一致し、必ず一意に部署を特定できる**。

---

## ６　まとめ

* JOINでは、従業員表の外部キー（会社番号＋部署番号）と、部署表の主キー（会社番号＋部署番号）を結合条件にする。
* 複合主キーを正しく参照しなければ、整合性が崩れ誤結合が起きる。
* これは「外部キーは参照先の主キーと同じ構造を持たなければならない」というルールの具体例。

---
👉 これで「なぜ二つの列でJOINするのか」がSQL上でも確認できたと思います。

