セーブポイントとチェックポイントの違いについて

端的に言えば、**セーブポイントは「意図的なやり直し」**、**チェックポイントは「万が一の備え」** のための仕組みです。

---

### 【早わかり】セーブポイントとチェックポイントの比較

| 項目 | セーブポイント (Savepoint) | チェックポイント (Checkpoint) |
| --- | --- | --- |
| **目的** | **トランザクション内の部分的な取り消し**<br>（処理の一部だけをやり直したい） | **障害復旧の高速化**<br>（システムが落ちても素早く復旧させたい） |
| **実行タイミング** | ユーザー（アプリケーション）が**意図的に**設定 | データベースシステムが**自動的に**、定期的に実行 |
| **対象範囲** | 特定の**トランザクション**の中 | **データベース全体** |
| **主な使われ方** | 複雑な処理の途中でエラーが起きた際に、正常な部分まで戻って処理を継続する。 | システムクラッシュ後、どこからデータを復旧すればよいかの目印として使われる。 |
| **永続性** | トランザクションが終了（コミット or ロールバック）すると消える。 | 永続的に記録され、障害復旧時に利用される。 |
| **イメージ** | **ゲームの一時セーブ**<br>（失敗したらそこからやり直す） | **防災訓練**<br>（定期的に安全確認をして、いざという時に備える） |

---

### 1. セーブポイント：トランザクション内の「やり直し地点」

セーブポイントは、一連のまとまった処理（トランザクション）の内部に、**「ここまで戻れる」という目印（ブックマーク）を付ける機能**です。

*   **目的：部分的なロールバック（取り消し）**
    *   長いトランザクションの途中でエラーが発生した場合、トランザクション全体を取り消すのではなく、設定したセーブポイントまで処理を戻して、そこからやり直すことができます。

*   **具体例：複数の更新処理**
    1.  トランザクション開始
    2.  処理A：顧客情報を更新
    3.  `SAVEPOINT A完了;` ← セーブポイントを設定
    4.  処理B：在庫情報を更新
    5.  `SAVEPOINT B完了;` ← セーブポイントを設定
    6.  処理C：ポイント情報を更新 → **ここでエラー発生！**
    7.  `ROLLBACK TO B完了;` → 処理Cだけを取り消し、処理Bが完了した状態に戻る。
    8.  処理Cを再度実行
    9.  コミット（全処理を確定）

もしセーブポイントがない場合、処理Cのエラーでトランザクション全体（処理A、Bも含む）をロールバックし、最初から全てやり直す必要があります。 このように、セーブポイントは**開発や運用の効率を高めるための「攻め」の道具**と言えます。

**ただし、停電やシステムクラッシュのような障害が発生すると、コミットされていないトランザクションはセーブポイントごと全て失われます。** あくまで意図的に操作するための機能であり、障害復旧には役立ちません。

### 2. チェックポイント：障害復旧のための「道しるべ」

チェックポイントは、データベースシステムが**障害からの復旧時間を短縮するために、自動的に行う内部処理**です。

*   **目的：障害復旧の高速化**
    *   データベースへの変更は、まずメモリ上で行われ、即座にディスクに書き込まれるわけではありません。
    *   チェックポイントは、メモリ上の変更内容をディスク上のデータファイルに書き込み、「ここまではディスクに反映済み」という記録（ログ）を残す処理です。
    *   システムがクラッシュした場合、データベースは再起動時に「最後のチェックポイント以降の処理だけ」をログから再現すればよいため、復旧時間を大幅に短縮できます。

*   **仕組みのイメージ**
    1.  データベースは、様々な変更履歴をログファイルにどんどん書き込んでいく。
    2.  **定期的**に、データベースシステムが「チェックポイント」を実行。
    3.  メモリ上の未確定なデータをディスクに書き込み、「チェックポイント完了」の印をログファイルに記録する。
    4.  **システムがクラッシュ！**
    5.  再起動後、データベースはログファイルを見て、「最後のチェックポイント」を探す。
    6.  そのチェックポイント以降のコミットされた処理だけを再現（ロールフォワード）し、未コミットの処理を取り消す（ロールバック）ことで、矛盾のない状態に素早く復旧する。

チェックポイントは、システムが健全な状態を保ち、万が一の際に迅速に立ち直るための**「守り」の仕組み**です。

### まとめ

*   **セーブポイント**は、**アプリケーション開発者**がトランザクション内での細かい制御のために使う「**部分的なやり直し**」機能です。
*   **チェックポイント**は、**データベースシステム**が障害に備えるために裏側で動いている「**全体的な安全確保**」の仕組みです。

