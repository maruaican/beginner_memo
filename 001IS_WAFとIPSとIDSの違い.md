
---

## １　全体像（テキスト図）

```
  OSI参照モデル
  ┌───────────────┐
  │ レイヤ7 アプリケーション層 ── WAF
  ├───────────────┤
  │ レイヤ3～4 ネットワーク/トランスポート層 ── IDS/IPS
  └───────────────┘
```

---

## １－１　定義（IPA準拠）と用語の由来

* **WAF（Web Application Firewall）**
  Webアプリケーションを狙った攻撃（SQLインジェクション，クロスサイトスクリプティングなど）を防ぐ仕組み。HTTP/HTTPS通信を対象。
  → 名前の通り「Webアプリ専用のファイアウォール」。

* **IDS（Intrusion Detection System）**
  不正侵入を検知してアラートを出す仕組み。監視カメラ的。

* **IPS（Intrusion Prevention System）**
  IDSに加えて遮断まで行う仕組み。警備員的。

---

## １－２　技術の必要性（解決する具体的課題）

* **WAF**：`アプリケーション層の脆弱性`を突く攻撃は従来のFW/IPSでは検知困難 → Web特化の保護が必要。
* **IDS/IPS**：ポートスキャンや既知マルウェア通信を早期発見・遮断することで被害拡大を防止。

---

## １－３　試験の着眼点（頻出領域と解答に必要な知識）

* **OSIモデルでの階層を問う問題**
  → WAF＝アプリ層
    IDS/IPS＝ネットワーク/トランスポート層。
* **検知方式の比較**
  → WAF＝ホワイトリスト型
    IDS/IPS＝シグネチャ＋アノマリ型。
* **IDSとIPSの違い**
  → IDS＝検知だけ
    IPS＝検知＋遮断。
* **誤答誘導パターン**
  → 「WAFはL4で動く」「IDSも遮断できる」といった混乱を狙う。

---

## １－４　体系マップ（分類・関係・比較表）

| 項目   | WAF             | IDS        | IPS        |
| ---- | --------------- | ---------- | ---------- |
| OSI層 | L7（アプリ層）        | L3-4       | L3-4       |
| 主な対象 | `HTTP/HTTPS通信`    | 全般的な通信     | 全般的な通信     |
| 検知方式 | ホワイトリスト（期待値ベース） | `シグネチャ＋アノマリ` | `シグネチャ＋アノマリ` |
| 動作   | 不正リクエスト遮断       | 検知のみ       | 検知＋遮断      |
| 役割比喩 | 門番（利用者入力を精査）    | 監視カメラ      | 警備員        |

---

## １－５　代表例（正答例・誤答例）

* **正答例**
  「Webアプリケーションの脆弱性攻撃（SQLインジェクションなど）対策にはWAFを導入する」
 「IDSは不正アクセスを検知し、アラートを出すだけ。」
* **誤答例（試験で狙われやすい）**
  「WAFはネットワーク層の通信を監視する」 → ×（アプリ層）
  「IDSは不正アクセスを検知し、自動的に遮断する」 → ×（IDSは検知のみ）
---

## １－６　よくある誤解と正しい知識

* 誤解：「IPSがあればWAFは不要」
  → 正しくは、**対象層が違うため併用が望ましい**。IPSは`OSやネットワーク層攻撃`に強く、WAFはWebアプリ攻撃に強い。

* 誤解：「IDS/IPSはアプリケーションのSQL文やパラメータを深く理解できる」
  → 正しくは、基本は`パケット単位の解析`であり、アプリ固有ロジックまでは把握できない。

---

## １－７　一問一答（5問）

**Q1.** OSI参照モデルでWAFが動作する層はどこか？
**A1.** アプリケーション層（L7）。
**解説** WebのHTTP/HTTPSを直接解析するため。

---

**Q2.** IDSとIPSの違いを一言で述べよ。
**A2.** IDSは検知のみ、IPSは検知＋遮断。
**解説** 試験では「受動的／能動的」の対比で出ることが多い。

---
**Q3.** WAFが得意とする攻撃例はどれか。
**A3.** SQLインジェクション、XSSなど、Webアプリの攻撃。
**解説** ネットワーク層攻撃（ポートスキャン等）はIPSの領域。

---
**Q4.** IDS/IPSが用いる代表的な検知方式は何か。
**A4.** シグネチャ検知とアノマリ検知。
**解説** 両方を組み合わせて精度を高める。

---

**Q5.** IPSをネットワークに設置する際の懸念は何か。
**A5.** 通信遅延や可用性低下。
**解説** インライン配置（セキュリティ機器や監視装置などを通信経路の途中に直接挿入して、すべてのトラフィックを通過させる構成）のため、ハード性能、そして、機器が故障すると通信が遮断される可能性があるため、冗長構成（HA）やバイパス機能が重要になります。

---

## １－８　要約（3行以内）

* **WAFはWebアプリ層（L7）、IPS/IDSはネットワーク～トランスポート層（L3-4）を守る。**
* **WAFはホワイトリスト方式、IPS/IDSはシグネチャ＋アノマリ方式。**
* **IDSは検知のみ、IPSは遮断も可能で、両者は補完関係にある。**

---


***

**【問1】**
ファイアウォール、IPS/IDS、WAFは、いずれもネットワークセキュリティ製品ですが、その防御対象とするOSI参照モデルの階層が異なります。WAFが主たる防御対象とする階層と、IPS/IDSが主たる防御対象とする階層をそれぞれ挙げ、その階層の違いが両者の検査内容にどのような違いをもたらすのか説明してください。

---
**【解答】**
WAFは主にアプリケーション層（レイヤ7）を、IPS/IDSは主にネットワーク層（レイヤ3）からトランスポート層（レイヤ4）を防御対象とします。この階層の違いにより、WAFは通信の「内容」まで踏み込んで検査するのに対し、IPS/IDSは`通信の「経路」`や「形式」を中心に検査するという違いが生まれます。

---
**【解説】】**
ネットワークセキュリティを理解する上で、**OSI参照モデル（Open Systems Interconnection reference model）**は全ての基本となる考え方です。これは国際標準化機構（ISO）によって策定された、ネットワーク通信の機能を7つの階層に分割したモデルです。

*   **WAF (Web Application Firewall)**: レイヤ7、すなわちアプリケーション層で動作します。この層はHTTPやSMTPといった、ユーザーが直接利用するアプリケーションの通信ルールを定めています。そのため、WAFはWebアプリケーションへのリクエスト（要求）やレスポンス（応答）の中身、例えば「`GET /index.html HTTP/1.1`」といった具体的なコマンドや、フォームに入力された文字列（URLパラメータ）まで詳細に解析し、不正なSQLインジェクションやクロスサイトスクリプティング（XSS）といった攻撃を検出します。これは、手紙の「宛先」だけでなく「本文」まで読んで、危険な内容がないかチェックするイメージです。

*   **IPS/IDS (Intrusion Prevention/Detection System)**: レイヤ3（ネットワーク層）とレイヤ4（トランスポート層）で主に動作します。`レイヤ3はIPアドレス`（通信相手の住所）を、`レイヤ4はポート番号`（住所の中のどの部屋か）を扱います。IPS/IDSは、送信元IPアドレスやポート番号、パケットのデータ本体であるペイロードに含まれる既知の攻撃パターンなどを見て、不正な通信経路や、明らかに異常な形式のパケットを検出・遮断します。これは、宛先不明の怪しい小包や、過去に問題を起こした人物からの手紙を入り口で止めるイメージです。

---
**【問2】**
WAFの防御モデルの主流である「ポジティブモデル（ホワイトリスト型）」とはどのような考え方ですか。また、このモデルが「未知の攻撃」に対して有効とされる理由を説明してください。

---
**【解答】**
ポジティブモデル（ホワイトリスト型）とは、「`事前に許可した安全な通信パターン」のリストを作成し、それに合致する通信のみを通過`させ、リストにない通信はすべて拒否するという考え方です。`未知の攻撃は許可リストには当然含まれないため、デフォルトでブロック`されることから、未知の攻撃に対しても有効とされています。

---
**【解説】】**
セキュリティモデルには大きく分けて2つの考え方があります。

1.  **ポジティブセキュリティモデル (Positive Security Model)**: 「許可するもの」を定義し、それ以外をすべて拒否するモデルです。「ホワイトリスト型」とも呼ばれます。語源は *Positive*（肯定的な、積極的な）で、許可するルールを積極的に定義することに由来します。
WAFでは、「このURLパターンへのアクセスは許可」「このパラメータは数字のみ許可」といった形で、アプリケーションが正常に動作するために必要な通信をすべて定義します。

2.  **ネガティブセキュリティモデル (Negative Security Model)**: 「拒否するもの」を定義し、それ以外をすべて許可するモデルです。「`ブラックリスト型`」とも呼ばれます。IPS/IDSのシグネチャ検出はこちらに分類されます。

ポジティブモデルが未知の攻撃に強い理由は、その排他性にあります。`攻撃者が新しい攻撃手法を開発したとしても、それが事前に定義された「安全な通信パターン」に合致する可能性は極めて低い`ため、結果としてブロックされるのです。
これは、パーティー会場の受付で「招待客リストに名前がある人だけ」を入場させる方式に似ています。リストにない未知の人物（未知の攻撃）は、悪意があるかないかに関わらず入場できません。

---
**【問3】**
IPS/IDSが用いる主要な不正検出方式として「シグネチャベース検出」と「アノマリベース検出」があります。この2つの方式の仕組みと、それぞれの長所・短所を説明してください。

---
**【解答】**
シグネチャベース検出は、`既知の攻撃パターンを定義`した「シグネチャ」と通信を照合し、一致した場合に不正と判断する方式です。一方、アノマリベース検出は、`平常時の通信を学習して「正常な状態」のモデルを作り、そこから逸脱する通信を異常`として検知する方式です。

*   **シグネチャベース**:
    *   長所：既知の攻撃に対する検出精度が高く、誤検知が少ない。
    *   短所：未知の攻撃や亜種の攻撃は検知できない。
    🖋 シグネチャベース（Signature-based）の語源 ラテン語の「signatus（署名された、印をつけた）」に由来
*   **アノマリベース**:
    *   長所：未知の攻撃を検知できる可能性がある。
    *   短所：正常な通信を異常と誤検知する可能性があり、`事前の学習と継続的なチューニングが必須`。語源：ギリシャ語の「anomalos（不均一、変則的）」に由来

---
**【解説】】**
IPS/IDSの検出メカニズムの根幹をなすのが、この2つの方式です。

*   **シグネチャベース検出 (Signature-based Detection)**:
    *   **シグネチャ (Signature)** とは「署名」を意味し、ここでは攻撃特有のデータパターン（特定の文字列やコードの断片など）を指します。ウイルス対策ソフトがウイルスパターンファイルでウイルスを検出するのと同じ仕組みです。例えば、「特定のマルウェアが通信時に必ず送信するバイト列」などがシグネチャとして登録されます。既知の攻撃に対しては非常に効果的ですが、シグネチャが定義されていない新種の攻撃は素通りしてしまいます。

*   **アノマリベース検出 (Anomaly-based Detection)**:
    *   **アノマリ (Anomaly)** とは「異常」「例外」を意味します。この方式では、まず`機械学習`などを用いて、一定期間のネットワークトラフィックを分析し、「普段の正常な状態」のベースライン（基準値）を確立します。その後、そのベースラインから大きく外れる通信（例：普段はないポートへの大量アクセス、パケットサイズの急激な変化など）を「異常」と判断します。これにより、シグネチャがない未知の攻撃も検知できる可能性があります。

---
**【問5】**
WebサイトがHTTPSによって通信を暗号化している場合、WAFはどのようにしてSQLインジェクションのようなアプリケーション層への攻撃を検知するのでしょうか。そのためにWAFが必要とする機能と、その機能がもたらすパフォーマンス上の課題を説明してください。

---
**【解答】】**
WAFは「HTTPS終端（TLS復号/再暗号化）」機能を用いて、一度`暗号化されたHTTPS通信を解読（復号）して平文に戻し、その内容を検査`します。検査後、問題がなければ`再び暗号化してWebサーバーへ転送`します。この復号と再暗号化の処理、特に通信開始時のSSL/TLSハンドシェイクはCPUに高い負荷をかけるため、パフォーマンス上の課題となります。

---
**【解説】】**
HTTPSは、**HTTP over SSL/TLS** の略で、通信内容を暗号化することで盗聴や改ざんを防ぐ仕組みです。しかし、この暗号化はセキュリティ対策装置にとっても厄介な問題となります。暗号化されたままでは、WAFは通信の中身を見ることができず、攻撃が含まれているかどうかを判断できません。

そこでWAFは、**HTTPS終端（またはSSL/TLSオフロード、SSL/TLSアクセラレーション）** と呼ばれる機能を実行します。

---
**【問6】**
WAFの運用において、ルールセットが複雑化・増加することがパフォーマンスに与える影響と、その対策について説明してください。

---
**【解答】**
ルールセット、特に正規表現などを多用した複雑なルールが増えるほど、通信一つひとつに対する解析時間が増大し、結果として`通信の遅延（レイテンシ）`が大きくなります。対策としては、ルールを定期的に見直してより効率的な記述にすることなどが挙げられます。

---
**【解説】**
WAFの心臓部は、通信内容を検査するための**ルールセット（シグネチャセットとも呼ばれる）**です。このルールには、「`' OR '1'='1`」のようなSQLインジェクションでよく使われる文字列パターンや、「`<script>`」のようなXSSで使われるタグなどが定義されています。

多くのWAFでは、これらのパターンを検出するために**正規表現 (Regular Expression)** という強力な文字列検索技術が用いられます。正規表現は非常に柔軟なパターンマッチングが可能ですが、その一方で、複雑な表現はCPUの計算量を著しく増大させることがあります。

例えば、新しい脆弱性が発見されるたびに、あるいはWebアプリケーションに新しい機能が追加されるたびに、防御ルールは追加・更新されていきます。Webサイトの応答速度はユーザー体験に直結するため、これは大きな問題です。

対策としては、以下のような運用が求められます。
*   **ルールの棚卸し**: 現在のアプリケーションでは不要になった古いルールを無効化・削除する。
*   **ルールの最適化**: パフォーマンス影響の大きいルールを特定し、より効率的な書き方に修正する。
*   **優先順位付け**: 頻繁に発生する攻撃パターンや、致命的な影響を及ぼす攻撃のルールを先に評価するように順序を調整する。

---
**【問7】**
IPS/IDSの運用において、必ず向き合うことになる「誤検知（False Positive）」と「見逃し（False Negative）」とは、それぞれどのような事象ですか。また、この2つの関係性について説明してください。

---
**【解答】】**
「誤検知（False Positive）」とは、正常な通信を不正な攻撃であると誤って判断してしまう事象です。「見逃し（False Negative）」とは、本来検出すべき不正な攻撃を検出できず、通過させてしまう事象です。この2つは`トレードオフ`の関係にあり、一般的に、誤検知を減らすようにルールを緩めると見逃しが増える傾向にあり、逆に見逃しを減らすためにルールを厳しくすると誤検知が増える傾向にあります。

---
**【解説】】**
セキュリティ監視における永遠の課題が、この誤検知と見逃しのバランスです。

*   **誤検知 (False Positive)**
    *   **False**（間違い）の **Positive**（陽性反応）。つまり、「攻撃だと陽性反応が出たが、実は間違いだった」という意味です。
    *   例えば、Webアプリケーションの入力フォームにプログラミングコードのサンプルを投稿した正常な通信が、コードインジェクション攻撃と誤判定されるケースなどがこれにあたります。
    *   誤検知が多いと、管理者はアラートの確認に追われ、本当に重要な攻撃アラートが埋もれてしまう「オオカミ少年」状態に陥ります。IPSの場合は、正常なサービス利用を妨害してしまいます。

*   **見逃し (False Negative)**
    *   **False**（間違い）の **Negative**（陰性反応）。つまり、「攻撃ではないと陰性反応が出たが、実は間違いで攻撃だった」という意味です。
    *   これは、セキュリティシステムが攻撃を認識できずに侵入を許してしまう、最も避けたい事態です。

この2つは、**トレードオフ (trade-off)** の関係にあります。
*   検知ルールを非常に厳しく（＝疑わしきは罰する）設定すれば、見逃しは減りますが、少しでも怪しい正常通信をブロックしてしまい、誤検知が激増します。
*   逆に、誤検知を減らすためにルールを緩く（＝明らかにクロでなければ見逃す）設定すれば、正常な通信は快適になりますが、巧妙に偽装された攻撃を見逃すリスクが高まります。

セキュリティ運用担当者の重要な役割は、自社のシステム環境やセキュリティポリシーに合わせて、このトレードオフの最適なバランスポイントを見つけ出し、継続的にルールをチューニングしていくことです。

---
**【問8】**
WAFのスケール戦略として「水平スケール」が挙げられます。この水平スケールとはどのようなアプローチか説明し、専用アプライアンスの導入と比較した場合のメリット・デメリットを挙げてください。

---
**【解答】**
`水平スケール（スケールアウト）`とは、`サーバーの台数を増やす`ことでシステム全体の処理能力を向上させるアプローチです。
*   **メリット**: 比較的安価なサーバーを必要に応じて追加できるため、`スモールスタートが可能`で柔軟な拡張性を持つ。1台が故障しても他のサーバーでサービスを継続できる可用性の高さも利点です。
*   **デメリット**: サーバーの台数が増えると、設定管理や監視の複雑性が増大する。
---
**【解説】**
WAF、特にクラウド環境や仮想環境でソフトウェアとして動作するWAFでは、水平スケールがよく採用されます。トラフィックの増加に応じて、同じ構成のWAFインスタンス（仮想サーバー）を次々と追加していくことで、システム全体のスループットを向上させます。

一方、**専用アプライアンス**は、特定の機能（この場合はWAF）を高速に処理するために設計されたハードウェアとソフトウェアが一体化した製品です。これは垂直スケールに近い考え方で、一台で非常に高いスループットを実現できます。

| 比較項目 | 水平スケール（ソフトウェア型） | 専用アプライアンス（ハードウェア型） |
| :--- | :--- | :--- |
| **拡張性** | 高い（インスタンスの追加が容易） | 限定的（機器の買い替えが必要） |
| **初期コスト** | 低い（スモールスタート可能） | 高い |
| **可用性** | 高い（1台の障害は他に影響しにくい） | 低い（冗長化構成が別途必要） |
| **性能** | 1台あたりの性能は限定的 | 1台で高スループットを実現 |
| **運用管理** | 台数が増えると複雑化 | 比較的シンプル |

---
**【問9】**
IPS/IDSが用いる「プロトコルデコーディング」とは、どのような解析手法ですか。シグネチャベースの検出とは何が違うのか、という観点で説明してください。

---
**【解答】**
プロトコルデコーディングとは、HTTPやDNSなどのプロトコル（通信規約）の仕様に基づいて通信内容を正確に分解・解析し、`プロトコル（通信規約）に違反した不正な形式の通信`や、仕様上ありえないフィールド値などを検出する手法です。
シグネチャベースが通信内容の「データパターン（文字列）」を照合するのに対し、プロトコルデコーディングは「`通信の文法や構造」が正しいかどうかを検査`する点に違いがあります。

---
**【解説】**
ネットワーク通信は、**プロトコル (Protocol)** という厳密なルール（規約）に基づいて行われます。
**プロトコルデコーディング (Protocol Decoding)** は、この通信規約の仕様書通りに通信データを分解（デコード）し、その構造や内容を詳細に分析する技術です。この過程で、以下のような異常を検出します。

*   **プロトコル違反**: 本来数字しか入らないはずのフィールドに文字列が含まれている。
*   **不正なフィールド長**: ヘッダの長さが異常に長い（バッファオーバーフロー攻撃の可能性）。
*   **RFC違反**: インターネット技術の標準仕様書であるRFC (Request for Comments) に準拠していない通信。

これは、シグネチャベースの検出とは視点が異なります。
*   **シグネチャベース**: 手紙の**本文**に「爆弾」という単語が含まれているかをチェックする。
*   **プロトコルデコーディング**: 手紙の**書式**（宛名の書き方、日付の形式など）が正しいか、封筒のサイズが規格外でないかをチェックする。

攻撃者は、セキュリティ製品を回避するために、`意図的にプロトコルを少しだけ改変した巧妙な攻撃パケットを送信してくることがあります`。プロトコルデコーディングは、このような「文法違反」の通信を捉えることで、シグネチャだけでは見逃してしまう可能性のある攻撃を検出できるのです。

---
**【問10】**
IPSをインライン設置する際に、可用性とパフォーマンスを両立させるために考慮すべき技術的な対策を2つ挙げ、それぞれ簡単に説明してください。

---
**【解答】**
1.  **冗長リンク/フェイルオーバー機能**: IPS装置を複数台用意して冗長構成（アクティブ/スタンバイなど）を組むことで、1台が故障しても待機系に処理を自動的に引き継ぎ（フェイルオーバー）、通信の停止を防ぎます。
2.  **ハードウェアバイパス機能**: IPS装置自体に深刻な障害（電源断など）が発生した場合に、内部の物理的なスイッチが作動して通信を迂回（バイパス）させ、最低限の通信を確保する機能です。

---
**【解説】**
IPSは通信経路上にインラインで配置されるため、その存在自体が潜在的なリスク要因となります。IPSが停止すれば、ネットワーク全体が停止してしまうからです。このリスクを低減し、可用性を確保するために、以下のような対策が不可欠です。

*   **冗長化 (Redundancy) とフェイルオーバー (Failover)**
    *   **冗長化**とは、同じ機能を持つ機器を予備として`複数`用意しておくことです。最も一般的なのは、通常時に稼働する「アクティブ機」と、待機している「スタンバイ機」を2台用意する構成です。
    *   **フェイルオーバー**とは、アクティブ機に障害が発生したことを検知し、`自動的にスタンバイ機に処理を切り替える`仕組みです。これにより、ユーザーはサービスが停止したことに気づかない、あるいはごく短時間の中断で済みます。

*   **ハードウェアバイパス (Hardware Bypass)**
    *   これは、IPS装置内部に組み込まれた、いわば「緊急回避路」です。IPSのソフトウェアがフリーズしたり、装置の電源が完全に落ちたりした場合、IPSは通信を処理できなくなります。このとき、ハードウェアバイパス機能が作動すると、IPSの内部を通過していた通信は、`検査を「スキップ」`して物理的に迂回し、先のネットワーク機器へ流れるようになります。
    *   `セキュリティ検査は行われなくなります`が、「通信が完全に途絶する」という最悪の事態を回避することを優先するのです。

---
**【問11】**
WAFのポジティブモデルとIPSのシグネチャモデルを比較した際、運用開始後の「チューニング」という観点において、それぞれどのような特性と課題がありますか。

---
**【解答】**
ポジティブモデルのWAFは、アプリケーションの正常な動作を定義するため、導入初期に集中的なチューニングが必要ですが、`一度安定すれば変更がない限りチューニングの頻度は低く`なります。
一方、シグネチャモデルの`IPSは、日々生まれる新たな脅威に対応するため、継続的なシグネチャの更新`と、それに伴う誤検知がないかの確認・調整（チューニング）が永続的に必要となります。

---
**【解説】**
同じ「チューニング」という言葉でも、防御モデルによってその性質は大きく異なります。

*   **WAF（ポジティブモデル）のチューニング**:
    *   **フェーズ**: 主に**導入初期**に負荷が集中します。
    *   **目的**: 開発者と協力し、保護対象のWebアプリケーションが持つすべての正規の通信パターン（URL、パラメータ、メソッドなど）を洗い出し、許可リストとして登録します。この作業が不十分だと、正常な機能がブロックされてしまいます。

*   **IPS（シグネチャモデル）のチューニング**:
    *   **フェーズ**: **導入後、永続的に**負荷が発生します。
    *   **目的**: セキュリティベンダーから日々配信される新しい攻撃パターン（シグネチャ）を適用し、防御能力を最新の状態に保ちます。
    *   **課題**: 新しいシグネチャを適用した結果、自社の環境では正常な通信が誤って攻撃と判定されてしまう（誤検知）ことがあります。そのため、定期的なシグネチャ更新のたびに、影響を監視し、必要に応じて特定のシグネチャを無効化したり、例外ルールを追加したりするチューニングが継続的に発生します。

**【問13】**
WAFの運用において、パフォーマンスへの影響を低減させるために利用される「セッションキャッシュ」および「セッション再開」機能は、SSL/TLSハンドシェイクのどの部分の負荷を軽減するものですか。

---
**【解答】**
これらの機能は、SSL/TLSハンドシェイクの中でも特に計算コストが高い「公開鍵暗号を用いた共通鍵の交換」と「サーバー証明書の検証」といった一連の処理の負荷を軽減するものです。一度確立したセッション情報を再利用することで、2回目以降の通信でこの高負荷な処理を省略します。

---
**【解説】**
HTTPS通信を開始する際の**SSL/TLSハンドシェイク**は、安全な通信路を確立するための非常に重要な手順ですが、その処理は複雑でCPUに大きな負荷をかけます。特に以下の処理は高コストです。

1.  **鍵交換**: クライアントとサーバーが、安全に共通鍵（通信データを実際に暗号化・復号するための鍵）を共有するための処理。多くの場合、計算量の多い公開鍵暗号方式（RSAや楕円曲線暗号など）が使われます。
2.  **サーバー認証**: サーバーがクライアントにデジタル証明書を提示し、クライアントがその正当性を検証する処理。

一度、このハンドシェイクが完了して通信セッションが確立されると、その結果（共通鍵など）をサーバー側（この場合はWAF）が一定時間記憶しておきます。これが**セッションキャッシュ (Session Cache)**です。

同じクライアントが短時間のうちに再度アクセスしてきた際に、このキャッシュされた情報を使ってハンドシェイクの大部分をスキップし、素早く安全な通信を再開する仕組みが**セッション再開 (Session Resumption)**です。これにより、毎回ゼロから高負荷な計算を行う必要がなくなり、サーバーのCPU負荷と通信の遅延を大幅に削減できます。

---
---
**【問14】**
IPS/IDSのアノマリベース検出において、「学習フェーズ」が非常に重要であるとされます。この学習フェーズとは何か、また、このフェーズでのチューニングを怠った場合に発生する主な問題を2つ挙げてください。

---
**【解答】**
学習フェーズとは、アノマリベース検出システムが、保護対象のネットワークにおける`平常時の通信パターン（トラフィックの量、使用されるプロトコル、通信先など）を観測・分析`し、「正常な状態」の基準となるベースラインを自動生成する期間のことです。
このフェーズのチューニングを怠ると、以下の問題が発生します。
1.  **誤検知の多発**: 正常な業務通信を異常と判定してしまい、アラートが頻発したり、IPSの場合は通信を遮断したりする。
2.  **見逃しの発生**: 異常な通信パターンを「正常」として学習してしまい、本来検出すべき攻撃を検知できなくなる。

---
**【解説】**
アノマリベース検出の根幹は、`「普段との違い」を見つけること`です。そのためには、まず「普段の状態」を正確に知る必要があります。この「普段の状態」＝「正常な状態のベースライン」を定義する期間が**学習フェーズ（ラーニングモード）**です。

システムは、この期間中に流れるトラフィックをひたすら収集・分析し、統計モデルや機械学習アルゴリズムを用いて、「このサーバーは通常、平日の9時～18時に特定のポートで通信する」「平均的なパケットサイズはこのくらいだ」といったプロファイルを作成します。

---
**【問15】**
ファイアウォール、IPS、WAFを多層防御の観点から配置する場合、一般的な配置順序とその理由を、インターネット側からサーバー側に向かう通信を例に説明してください。

---
**【解答】**
一般的な配置順序は、インターネット側から「`ファイアウォール → IPS → WAF → Webサーバー`」の順となります。
理由は、まずファイアウォールがポートレベルで不要な通信を`大まかにフィルタリング`し、
次にIPSがOSやミドルウェア層への`既知の攻撃を検知・遮断`し、
最後にWAFがアプリケーション層に到達する`通信の内容を詳細に検査`することで、各層で効率的かつ専門的な防御を実現するためです。

---
**【解説】**
セキュリティの基本原則の一つに**多層防御 (Defense in Depth)** があります。これは、一つの防御策が破られても、次の防御策で攻撃を防ぐという考え方です。

1.  **ファイアウォール (Firewall)**: ネットワークの最も外側に配置され、最初の門番となります。送信元/宛先IPアドレスとポート番号に基づいて、`許可されていないサービスへの通信（例: WebサーバーなのにSSH接続の要求が来るなど`）を機械的にブロックします。ここで不要な通信を大幅に削減し、後段の機器の負荷を軽減します。

2.  **IPS (Intrusion Prevention System)**: ファイアウォールを通過した通信の中から、OSやミドルウェアの脆弱性を狙う攻撃（例: バッファオーバーフロー攻撃など）や、マルウェアの通信といった、`既知の不正`なパターンを持つパケットを検知・遮断します。パケットの中身（ペイロード）を見て、より深いレベルでの検査を行います。

3.  **WAF (Web Application Firewall)**: IPSを通過した、Webサーバー宛の正規の`HTTP/HTTPS通信に特化`して、その「内容」を最後の砦として検査します。SQLインジェクションやクロスサイトスクリプティングなど、`アプリケーションの脆弱性`を突く、巧妙な攻撃を防ぎます。

この順序で配置することにより、外側から内側に行くにつれて、より詳細で専門的な検査が行われ、全体として効率的で強固な防御体制を築くことができます。


**【問16】**
WAFのポジティブモデル（ホワイトリスト）と対になる概念として、ネガティブモデル（ブラックリスト）があります。IPSのシグネチャベース検出は、このネガティブモデルに分類されます。両モデルの運用上のメリット・デメリットを比較して説明してください。

---
**【解答】**
| モデル | メリット | デメリット |
| :--- | :--- | :--- |
| **ポジティブモデル** | `未知の攻撃に対する防御能力が高い`。一度定義すれば、アプリケーションの変更がない限り安定して運用できる。 | `導入時の設定が非常に複雑`で、アプリケーションの全仕様を把握する必要がある。仕様変更時のメンテナンスが必須。 |
| **ネガティブモデル** | 導入が比較的容易で、`既知の脅威に対して迅速に対応`できる。アプリケーションの仕様に深く依存しない。 | `未知の攻撃は防御できない`。新たな脅威に対応するため、継続的なシグネチャの更新とチューニングが不可欠。 |

---
**【解説】**
セキュリティモデルの選択は、防御思想の根幹を決定します。

*   **ポジティブモデル（ホワイトリスト）**:
    *   **思想**: 「許可されたもの以外は、すべて悪」
    *   **比喩**: 完全招待制のパーティー。`招待状（許可リスト）を持つ人だけが入れる`。
    *   **運用**: アプリケーションの「あるべき姿」を定義します。そのため、設計段階からセキュリティを考慮する必要があり、導入には手間がかかります。しかし、その手間を乗り越えれば、ゼロデイ攻撃のような未知の脅威に対しても原理的に強い、非常に堅牢な防御が実現できます。

*   **ネガティブモデル（ブラックリスト）**:
    *   **思想**: 「禁止されたもの以外は、すべて善」
    *   **比喩**: 指名手配犯のリストを門番が持っている。`指名手配犯リストに載っている人物（既知の攻撃パターン）だけを追い返す`。
    *   **運用**: 過去に発見された攻撃パターンをリスト化（シグネチャ化）し、それと一致する通信をブロックします。導入は比較的簡単で、多くのシステムに適用できます。しかし、リストにない新しい手口の犯罪者（未知の攻撃）は、そのまま通り抜けてしまいます。そのため、常に指名手配犯リストを最新に保つ努力が求められます。

多くのWAF製品は、基本は`ポジティブモデル`で運用しつつ、緊急性の高い攻撃に対してはネガティブモデルのシグネチャを併用する、ハイブリッドなアプローチを取ることが一般的です。

---

**【問18】**
WAFのルールをチューニングする際、「正規表現」の知識が重要となります。正規表現がWAFのパフォーマンスに与える影響、特に「計算コストが高くなるパターン」の例を挙げ、その理由を説明してください。

---
**【解答】**
正規表現は、WAFがSQLインジェクションやXSSなどの攻撃パターンを柔軟に検出するために不可欠ですが、非効率な正規表現はCPU負荷を著しく増大させ、レイテンシの悪化を招きます。
特に、`ワイルドカード「.*」を多用した曖昧な表現や、複雑な入れ子構造（ネスト）を持つ正規表現は、マッチングの対象を検証するために膨大な組み合わせの計算（バックトラック）を試行する必要があるため、計算コストが非常に高くなる`傾向があります。

---
**【解説】**
**正規表現 (Regular Expression、しばしばRegexと略される)** は、文字列の集合を一つの文字列で表現する方法です。例えば、「`sql.*injection`」という正規表現は、「sql」という文字列の後に任意の文字（`.*`）が0文字以上続き、その後に「injection」という文字列が現れるパターンにマッチします。

この柔軟性が攻撃パターンの検出に役立つ一方で、パフォーマンスの罠にもなります。特に問題となるのが、正規表現エンジンがマッチングを試みる過程で発生する**バックトラック (Backtracking)** です。

例えば、「`a.*b`」という正規表現で「axbyb」という文字列を検査する場合を考えます。
1.  まず「a」にマッチします。
2.  次に「`.*`」が残りの「xbyb」すべてにマッチしようとします（最長一致）。
3.  しかし、その後ろの「b」にマッチする文字が残っていません。
4.  そこでエンジンは**バックトラック（後戻り）**し、「`.*`」のマッチを1文字減らして「xby」とし、最後の「b」にマッチさせようとします。これで成功します。

このように、エンジンは成功するまで様々な可能性を試行錯誤します。曖昧な表現（`.*`など）や複雑な選択・繰り返しが組み合わさった正規表現は、このバックトラックの回数が指数関数的に増加し、CPUを極度に消費する「**破滅的なバックトラック (Catastrophic Backtracking)**」と呼ばれる状態を引き起こすことがあります。これがパフォーマンス低下の主な原因です。

--
**【問19】**
IPS/IDSのアノマリベース検出は、正常な通信の振る舞いを「統計モデル」で分析します。この統計モデルが異常を検知する際の指標（メトリクス）の例を、3つ以上挙げてください。

---
**【解答】**
1.  **通信量（スループット）**: 単位時間あたりのパケット数やバイト数が、平常時のベースラインから異常に増加または減少していないか。
2.  **コネクション数**: 特定のホストが生成するTCP/UDPコネクションの数が、通常よりも急激に増加していないか（ポートスキャンの可能性）。
3.  **パケットの特性**: パケット長（サイズ）の分布や、設定されているフラグ（SYN, FINなど）の組み合わせが、通常とは異なるパターンを示していないか。
4.  **プロトコルの比率**: ネットワーク全体に占めるHTTP、DNS、SMTPなど、各プロトコルの通信の割合が、平常時と大きく変化していないか。

---
**【解説】**
アノマリベース検出は、ネットワークを様々な角度から監視し、その統計的な振る舞いを常にベースラインと比較しています。人間が健康診断で様々な数値をチェックするように、システムもネットワークの健康状態を多角的に監視しています。

*   **通信量の異常**: DDoS攻撃の予兆として、特定のサーバーへの通信量が急激に増加する場合があります。逆に、サーバーダウンの兆候として通信量がゼロになることも異常として検知できます。
*   **コネクション数の異常**: 攻撃者が攻撃対象の弱点を探すために行うポートスキャンや、ワームが感染先を広げるための活動は、短時間に多数の異なる宛先へコネクションを試みるという特徴的な振る舞いを示します。
*   **パケット特性の異常**: OSの脆弱性を突くために、意図的に不正なフラグを立てたパケット（例: Xmasスキャン）を送信する攻撃があります。アノマリ検出は、このような「通常ではありえない」パケットの形式を検知します。
*   **プロトコル比率の異常**: 例えば、普段はWebトラフィック（HTTP/HTTPS）がほとんどを占めるネットワークで、突如としてDNSクエリが異常な割合を占めるようになった場合、DNSトンネリングのような不正な情報漏洩チャネルが作られた可能性を疑うことができます。

これらの指標を単独ではなく複合的に分析することで、アノマリベース検出はより精度の高い異常検知を実現します。

---
**【問20】**
多層防御の観点からWAFとIPSを導入している環境において、Webサーバーの脆弱性を突く新しいゼロデイ攻撃が発生しました。この攻撃に対して、WAFのポジティブモデルとIPSのシグネチャモデルは、それぞれどのように機能する（あるいは、しない）可能性がありますか。それぞれの挙動を予測し、その理由を説明してください。

---
**【解答】**
*   **IPS（シグネチャモデル）**: この`新しいゼロデイ攻撃に対するシグネチャはまだ存在しないため、攻撃を検知・遮断できず、通過`させてしまう可能性が非常に高いです。
*   **WAF（ポジティブモデル）**: 攻撃通信が、事前に定義された「許可された通信パターン（URL、メソッド、パラメータ構造など）」に合致しない場合、たとえ`未知の攻撃であっても、定義されていない不正なリクエストとして検知・遮断できる可能性`があります。

結論として、このような状況では、`未知の脅威に原理的に強いポジティブモデルのWAFが、最後の砦`として機能することが期待されます。

---
**【解説】**
**ゼロデイ攻撃 (Zero-day Attack)** とは、ソフトウェアの脆弱性が発見されてから、その対策（修正パッチ）が提供されるまでの間に、その脆弱性を悪用して行われる攻撃のことです。

このシナリオにおける各セキュリティ機器の挙動は、それぞれの動作原理の違いを明確に示しています。

*   **IPSの限界**:
    IPSのシグネチャモデルは、`既知の攻撃パターン、つまり「過去問」を解くのは得意`です。しかし、ゼロデイ攻撃は、まだ誰も見たことのない「新作問題」です。問題集（シグネチャデータベース）に載っていないため、解答（検知）することができません。

*   **WAFの可能性**:
    WAFのポジティブモデルは、「許可された解法以外はすべて不正解」という採点基準を持っています。たとえ攻撃者がどのような巧妙な「新作問題」を持ち込んできたとしても、その解法（通信パターン）が、あらかじめ定められた「正しい解法」（許可リスト）と異なっていれば、不正と見なしてブロックします。
    例えば、特定のURLパラメータは「数字のみを許可」と定義されているところに、攻撃コードである文字列が入力されれば、WAFはそれが既知の攻撃か未知の攻撃かに関わらず、「ルール違反」として遮断します。

このように、シグネチャに依存しないポジティブモデルは、ゼロデイ攻撃に対する有効な防衛策の一つとなり得るのです。これこそが、多層防御においてWAFが果たすべき重要な役割と言えます。

---
